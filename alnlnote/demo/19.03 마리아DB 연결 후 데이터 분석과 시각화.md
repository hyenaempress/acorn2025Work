# 19.03 마리아DB 연결 후 데이터 분석과 시각화

> **강사님 한마디**: "DB에서 읽은 데이터를 DataFrame으로 넘어오기만 하면 끝이야! 그러면 pandas가 할 수 있는 그 많은 기능들을 할 수가 있게 되거든!"

## 📋 목차
1. [전제조건 (간단 복습)](#전제조건-간단-복습)
2. [세 가지 데이터 출력 방법](#세-가지-데이터-출력-방법)
3. [CSV 파일 입출력 (실무 필수)](#csv-파일-입출력-실무-필수)
4. [pandas.read_sql() - 진짜 좋은 녀석](#pandasread_sql---진짜-좋은-녀석)
5. [pandas 기능으로 통계 분석](#pandas-기능으로-통계-분석)
6. [교차표와 HTML 출력](#교차표와-html-출력)
7. [시각화 - 파이차트 중심](#시각화---파이차트-중심)
8. [강사님이 강조한 핵심 포인트](#강사님이-강조한-핵심-포인트)

---

## 전제조건 (간단 복습)

**강사님**: "DB 연동은 여러분 할 줄 아는 거고, 이걸 pandas로 잡아당기는 거에만 좀 관심 가지세요!"

```python
# 19.02에서 배운 기본 설정 (간단 복습)
import MySQLdb
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import sys
import pickle
import csv

plt.rcParams['font.family'] = 'Malgun Gothic'
plt.rcParams['axes.unicode_minus'] = False

# 연결 설정 로드 (피클 파일에서)
with open('./mymaria.dat', 'rb') as obj:
    config = pickle.load(obj)

conn = MySQLdb.connect(**config)  # 딕셔너리 언팩킹!
```

---

## 세 가지 데이터 출력 방법

**강사님**: "대표적인 출력이 보통 이 정도잖아요? 콘솔 출력, 데이터프레임 출력, CSV 출력!"

### 🎯 강의에서 다룬 세 가지 방법

```python
try:
    cursor = conn.cursor()
    
    # 직원 정보를 조회하는 JOIN 쿼리
    sql = """
    SELECT jikwonno, jikwonname, busername, jikwonjik, jikwongen, jikwonpay 
    FROM jikwon 
    INNER JOIN buser ON jikwon.busernum = buser.buserno
    """
    
    cursor.execute(sql)
    
    print("=== 방법 1: 콘솔로 출력 (실험용/연습용) ===")
    print("강사님: '콘솔로 출력하는 거는 이제 우리는 졸업을 해야 되겠죠'")
    
    for (jikwonno, jikwonname, busername, jikwonjik, jikwongen, jikwonpay) in cursor:
        print(f"사번: {jikwonno:2d} | 이름: {jikwonname:4s} | 부서: {busername:6s} | 직급: {jikwonjik:4s} | 성별: {jikwongen} | 연봉: {jikwonpay:,}원")
    
    print("\n=== 방법 2: 데이터프레임으로 출력 (자주 씀!) ===")
    # 커서 재실행 (이미 소모되었으므로)
    cursor.execute(sql)
    
    df1 = pd.DataFrame(cursor.fetchall(),
                       columns=['jikwonno', 'jikwonname', 'busername', 'jikwonjik', 'jikwongen', 'jikwonpay'])
    print("강사님: '데이터프레임으로 출력한 거예요?'")
    print(df1.head(3))

except Exception as e:
    print(f"❌ 쿼리 실행 오류: {e}")
```

---

## CSV 파일 입출력 (실무 필수)

**강사님**: "세 번째 바로 파일로 출력할 거야! 제일 흔해 빠진 게 누구야? CSV잖아!"

### 1. DB → CSV 파일 저장

```python
print("\n=== 방법 3: CSV 파일로 출력 ===")
print("강사님: 'CSV 모듈도 또 import했어요!'")

# with문 쓰면 close를 안 해도 되는 거지!
with open('./01_big_data_machine_learning/data/jik_data.csv', 'w', encoding='utf-8', newline='') as fobj:
    writer = csv.writer(fobj)
    
    # 데이터 다시 조회 (커서가 소모되었으므로)
    cursor.execute(sql)
    for row in cursor:
        writer.writerow(row)

print("✅ jik_data.csv 파일이 만들어졌어요!")
print("강사님: '파일 하나 만들어졌어요. 가보시면 파일이 이렇게 저장이 됐습니다.'")

# 또는 DataFrame을 직접 CSV로 (더 간편한 방법)
df1.to_csv('./01_big_data_machine_learning/data/jikwon.csv', encoding='utf-8', index=False)
```

### 2. CSV 파일 → DataFrame

```python
print("\n=== CSV 파일 읽어서 DataFrame으로 ===")

# 기본 읽기
df2 = pd.read_csv('./01_big_data_machine_learning/data/jik_data.csv', encoding='utf-8')
print("그냥 읽으면 헤더가 없어서...")

# 커스텀 컬럼명 지정 (실무에서 자주 씀!)
df2 = pd.read_csv('./01_big_data_machine_learning/data/jik_data.csv', 
                  encoding='utf-8',
                  names=['번호', '이름', '부서', '직급', '성별', '연봉'])

print("강사님: '헤더는 필요 없다. 우리가 names 해가지고 names 줄게요'")
print(df2.head(3))
print("이렇게 CSV 저장돼 있는 파일을 읽어서 데이터프레임에 넣고 찍은 거예요!")
```

---

## pandas.read_sql() - 진짜 좋은 녀석

**강사님**: "더 좋은 방법이 있지만 이 방법도 좋은 거야. 진짜 훌륭한 문장을 바로 읽을 수 있다고 했잖아요!"

### 🌟 pandas의 SQL 처리 기능으로 읽기

```python
print("\n=== 🌟 pandas의 read_sql로 바로 읽기 (이거 좀 좋은 녀석이야!) ===")

# 한 방에 해결! 
df = pd.read_sql(sql, conn)

# 한글 컬럼명으로 변경
df.columns = ['번호', '이름', '부서', '직급', '성별', '연봉']

print("강사님: 'DB에 자료를 pandas의 SQL 처리 기능으로 읽기'")
print(df.head(3))

print("\n강사님: 'DB의 자료를 DataFrame으로 읽었으므로 pandas의 기능을 적용 가능!'")
print("데이터프레임으로 넘어오기만 하면 끝이야! pandas가 할 수 있는 그 많은 기능들을 할 수가 있게 되거든!")
```

---

## pandas 기능으로 통계 분석

**강사님**: "이제 몇 개만 적용해볼까요? pandas의 기능을 쓰고 있는 거야!"

### 1. 기본 통계 (건수, 평균 등)

```python
print("🔢 === pandas 기능으로 기본 분석 ===")

# 건수 구하기 (두 가지 방법)
print("강사님: '건수 구해보자'")
print(f"📊 총 건수: {len(df)}개")
print(f"📊 다른 방법: {df['이름'].count()}개")  # count() 사용
print("강사님: '건수 30개야 30개. 판다스의 기능 쓰고 있는 거야'")

print(f"\n💰 연봉 평균: {df['연봉'].mean():,.0f}원")
print("강사님: '연봉 평균 구하고 싶다 그러면 .mean()이죠'")
```

### 2. 그룹별 분석 (value_counts)

```python
print("\n👥 === 그룹별 인원 분석 ===")

print("🏢 직급별 인원수:")
print("강사님: '직급별 인원수 그러면 어떻게 되겠습니다'")
print(df['직급'].value_counts())
print("강사님: '사원 13명 대리 7명... 너무 좋아요!'")

print("\n🏢 부서별 인원수:")
print("강사님: '부서별 인원수 구할 수 있겠지?'")
dept_counts = df['부서'].value_counts()
print(dept_counts)

print("\n⚥ 성별 인원수:")
gender_counts = df['성별'].value_counts()
print(gender_counts)
```

### 3. 그룹별 연봉 분석

```python
print("\n💼 === 그룹별 연봉 분석 ===")

print("💰 직급별 연봉 평균:")
print("강사님: '직급별 연봉 평균... 그룹바이 할 수 있겠지'")

# 직급별 연봉 평균
jik_avg_pay = df.groupby('직급')['연봉'].mean()
print(jik_avg_pay)

print("강사님: '합을 구하고 평균을 구하고 어쩌고 저쩌고 다 구할 수 있지'")
print("'그룹바이로 구할 수 있고, 크로스테이블로 구할 수 있고, 피봇테이블로 구할 수 있고 방법은 여러 가지가 있죠'")
```

---

## 교차표와 HTML 출력

**강사님**: "크로스테이블은 안 보여주는데 크로스테이블 뭐예요? 이것도 지금 있습니다!"

### 성별-직급 교차표 (크로스테이블)

```python
print("\n📊 === 교차표 분석 (크로스테이블) ===")

# 성별과 직급의 교차표
print("강사님: 'pd.crosstab 이렇게'")
ctab = pd.crosstab(df['성별'], df['직급'], margins=True, margins_name='전체')
print("⚥ 성별-직급 교차표:")
print(ctab)
print("강사님: '성별 직급별 이런 식으로 건수를 구할 겁니다'")

# 🌐 HTML 출력 (웹 개발용)
print("\n🌐 HTML로 변환 (웹에서 활용)")
print("강사님: '점 찍어가지고 to_html 해가지고 바깥으로 내보낼 수 있는 방법이 있어요'")
print("'특히 Django를 쓸 수 있다고 한다면 나중에 장고를 통해가지고 HTML 파일로 보낼 수가 있습니다'")

html_output = ctab.to_html()
print("ctab.to_html() 사용 - 웹 프레임워크에서 바로 활용 가능!")
print("강사님: '굉장히 좋죠? 아주 중요한 걸 기억해줘야 됩니다'")
```

---

## 시각화 - 파이차트 중심

**강사님**: "시각화만 하나만... 직급별 연봉 평균에 대해서 시각화해볼게요!"

### 🥧 직급별 연봉 파이차트 (강사님 스타일)

```python
print("\n📊 === 시각화 (파이차트) ===")

# 직급별 연봉 평균 구하기
print("강사님: '직급별 연봉 평균이야. 그룹바이 해주시고...'")
jik_pay = df.groupby('직급')['연봉'].mean()

print("인덱스와 값 확인:")
print("jik_pay.index:", jik_pay.index)  # 강사님이 보여준 부분
print("jik_pay.values:", jik_pay.values)

# 파이차트 그리기
plt.figure(figsize=(10, 8))

print("강사님: '파이차트 요거 한번 써보겠습니다'")

plt.pie(jik_pay.values,              # 값들
        labels=jik_pay.index,        # 레이블 (직급명)
        autopct='%.1f%%',            # 퍼센트 표시
        explode=(0.2, 0.1, 0.1, 0.3, 0.1),  # 조각 분리 효과
        shadow=True,                 # 그림자 효과
        startangle=90,               # 시작 각도
        labeldistance=0.7,           # 레이블 거리 조절
        counterclock=False)          # 시계 방향으로!

plt.title('직급별 평균 연봉 비율\n(강사님 스타일 파이차트)', fontsize=14)

print("강사님 설명:")
print("- explode: '첫 번째 조각은 좀 튀어나오고, 두 번째는 그대로, 네 번째 끝은 하나 좀 더 많이 튀어나올래'")
print("- shadow: '그림자 효과'")
print("- startangle: '시작 각도'") 
print("- labeldistance: '레이블 위치 조절하면 글자를 좀 더 바깥으로 안으로 볼 수 있어요'")
print("- counterclock=False: '시계 방향으로! (기본은 시계 반대 방향)'")

plt.show()

print("강사님: '요 정도 보여줄게요. 그래도 나오지 그래도!'")
```

### 📊 추가 간단 시각화들

```python
# 연봉 히스토그램 (간단하게)
plt.figure(figsize=(12, 8))

plt.subplot(2, 2, 1)
plt.hist(df['연봉'], bins=10, color='green', alpha=0.7, edgecolor='black')
plt.title('연봉 분포 히스토그램')
plt.xlabel('연봉 (원)')
plt.ylabel('인원 수')

# 직급별 연봉 막대그래프 
plt.subplot(2, 2, 2)
jik_pay.plot(kind='bar', rot=0, color='skyblue')
plt.title('직급별 평균 연봉')
plt.ylabel('평균 연봉')

# 부서별 인원수
plt.subplot(2, 2, 3)
df['부서'].value_counts().plot(kind='bar', rot=45, color='lightcoral')
plt.title('부서별 인원수')
plt.ylabel('인원 수')

# 성별 비율 (간단한 파이차트)
plt.subplot(2, 2, 4)
df['성별'].value_counts().plot(kind='pie', autopct='%.1f%%')
plt.title('성별 비율')
plt.ylabel('')

plt.tight_layout()
plt.show()

print("강사님: '시각화... 나머지 것들 여러분 하실 수 있어요'")
```

---

## 강사님이 강조한 핵심 포인트

### 🎯 **강의에서 반복 강조한 내용들**

#### 1. **콘솔 출력은 졸업해야 해** 🎓
```python
print("강사님: '콘솔로 출력하는 거는 이제 우리는 졸업을 해야 되겠죠'")
print("'웬만하면 데이터프레임으로 출력한 거예요?'")
```
**💡 핵심**: 실무에서는 콘솔 출력보다 DataFrame이나 파일 출력이 훨씬 유용

#### 2. **with문 쓰면 close 안 해도 돼** 🔄
```python
print("강사님: 'with문 써줘야 close를 안 해도 되는 거지'")

# ✅ 권장 방법
with open('file.csv', 'w', encoding='utf-8') as fobj:
    writer = csv.writer(fobj)
    # 자동으로 파일이 닫힘!
```
**💡 핵심**: with문은 파일 처리의 기본! 자동으로 리소스 관리

#### 3. **pandas.read_sql()이 진짜 좋은 녀석** ⭐
```python
print("강사님: '이거 좀 좋은 녀석이야'")
print("'진짜 훌륭한 문장을 바로 읽을 수 있다고 했잖아요'")

# 한 방에 해결!
df = pd.read_sql(sql, conn)
```
**💡 핵심**: SQL → DataFrame 변환의 최고 방법

#### 4. **DataFrame으로 넘어오면 끝!** 🏁
```python
print("강사님: '데이터프레임으로 넘어오기만 하면 끝이야!'")
print("'그러면 pandas가 할 수 있는 그 많은 기능들을 할 수가 있게 되거든!'")
```
**💡 핵심**: DB → DataFrame 변환 후 모든 분석 작업 가능

#### 5. **여러 방법이 다 있어** 🛠️
```python
print("강사님: '그룹바이로 구할 수 있고, 크로스테이블로 구할 수 있고, 피봇테이블로 구할 수 있고'")
print("'방법은 여러 가지가 있죠'")
```
**💡 핵심**: 같은 결과도 다양한 방법으로 구현 가능

#### 6. **HTML 출력은 웹 개발의 핵심** 🌐
```python
print("강사님: 'Django를 쓸 수 있다고 한다면'")
print("'나중에 장고를 통해가지고 HTML 파일로 보낼 수가 있습니다'")
print("'굉장히 좋죠? 아주 중요한 걸 기억해줘야 됩니다'")

# 웹 프레임워크에서 바로 활용
html_output = df.to_html()
```
**💡 핵심**: DataFrame → HTML 변환으로 웹 서비스 연동

#### 7. **파이차트 옵션들 마스터** 🥧
```python
print("강사님: '시계 반대 방향이 기본이야. 시계 방향으로 가고 싶으면 counterclock=False'")
print("'레이블 거리 조절하면 글자를 좀 더 바깥으로 안으로 볼 수 있어요'")
```
**💡 핵심**: 시각화는 디테일이 중요!

### 📚 **실무에서 기억할 체크리스트**

```python
실무_체크리스트 = {
    "1. DB 연결": "딕셔너리 언팩킹(**config) 사용",
    "2. 데이터 읽기": "pandas.read_sql()이 최고",
    "3. 파일 처리": "with문으로 안전하게",
    "4. 분석 작업": "DataFrame으로 변환 후 pandas 기능 활용",
    "5. 웹 연동": "to_html()로 웹 프레임워크 연결",
    "6. 시각화": "목적에 맞는 차트 선택과 옵션 활용"
}

for key, value in 실무_체크리스트.items():
    print(f"{key}: {value}")
```

### 🎉 **마무리 - 강사님의 격려**

```python
print("\n강사님 마무리 말씀:")
print("'이런 식으로 응용할 수 있다는 겁니다'")
print("'이제부터는 pandas의 기능을 얼마나 알고 있느냐'")
print("'거기에 의해서 결과가 결정이 나는 겁니다'")
print("'DB 연동은 여러분 할 줄 아는 거고,'")
print("'이걸 pandas로 잡아당기는 거에만 좀 관심 가지세요!'")
```

---

## 💡 최종 정리

### ✅ 이 장에서 배운 핵심

1. **🔄 세 가지 출력 방법**: 콘솔(연습용) → DataFrame(실무용) → CSV(공유용)
2. **⭐ pandas.read_sql()**: DB에서 DataFrame으로 한 번에 변환하는 최고의 방법
3. **📊 분석 기법**: value_counts, groupby, crosstab 등 다양한 접근법
4. **🌐 웹 연동**: to_html()로 Django 등 웹 프레임워크 연결
5. **📈 시각화**: 파이차트 중심의 실무적 시각화 기법

### 🚀 다음 단계

- **Django/Flask**: HTML 출력을 활용한 웹 서비스 구축
- **대시보드**: 실시간 데이터 분석 시스템
- **자동화**: 정기 리포트 및 분석 자동화
- **고급 시각화**: Plotly, Seaborn 등 인터랙티브 차트

**강사님**: "pandas의 기능을 얼마나 알고 있느냐 거기에 의해서 결과가 결정이 나는 겁니다!" 🎯