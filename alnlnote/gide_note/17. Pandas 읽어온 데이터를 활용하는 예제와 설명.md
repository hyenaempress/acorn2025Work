# 17. 읽어온 데이터를 활용하는 예제와 설명

## 📋 개요

웹에서 수집한 데이터 (예: 네이버 코스피 데이터)를 판다스로 읽어온 후, 실무에서 활용할 수 있는 다양한 데이터 분석 및 처리 방법을 단계별로 설명합니다.

---

## 🔧 기본 데이터 읽기 및 점검

### 1. 수집된 데이터 불러오기

```python
import pandas as pd
import numpy as np
import re

# 크롤링으로 저장된 CSV 파일 읽기
df = pd.read_csv('네이버코스피.csv', dtype=str, index_col=False)
print("=== 원본 데이터 확인 ===")
print(f"데이터 형태: {df.shape}")
print(df.head(3))
```

### 2. 데이터 구조 파악

```python
# 데이터 정보 확인
print("\n=== 데이터 정보 ===")
print(df.info())
print("\n=== 컬럼별 결측값 ===")
print(df.isnull().sum())
print("\n=== 각 컬럼의 샘플 값 ===")
for col in df.columns:
    print(f"{col}: {df[col].dropna().head(3).tolist()}")
```

---

## 🧹 데이터 전처리 및 정제

### 1. 텍스트 데이터 정제

```python
# 종목명에서 불필요한 문자 제거
df['종목명'] = df['종목명'].str.replace('\n', '').str.strip()
print("종목명 정제 후:")
print(df['종목명'].head(3))
```

### 2. 숫자 데이터 전처리 함수

```python
def clean_change_direction(val):
    """전일비 데이터 전용 전처리 함수"""
    if pd.isna(val):
        return pd.NA
    
    val = str(val)
    # 콤마 제거, 상승/하락 기호 변환
    val = val.replace(',', '').replace('상승', '+').replace('하락', '-')
    # 숫자, 점, 플러스, 마이너스만 남기기
    val = re.sub(r'[^\d\.\-\+]', '', val)
    
    try:
        return float(val)
    except ValueError:
        return pd.NA

def clean_numeric_column(series):
    """일반 숫자형 컬럼 전처리 함수"""
    return (
        series.astype(str)
        .str.replace(',', '', regex=False)      # 콤마 제거
        .str.replace('%', '', regex=False)      # 퍼센트 제거
        .replace(['', '-', 'N/A', 'nan'], pd.NA)  # 빈 값을 NA로
        .apply(lambda x: pd.to_numeric(x, errors='coerce'))  # 숫자 변환
    )

# 전일비 데이터 전처리 적용
df['전일비'] = df['전일비'].apply(clean_change_direction)

# 숫자형 컬럼들 일괄 전처리
numeric_cols = ['현재가', '전일비', '등락률', '액면가', '시가총액', '상장주식수', '거래량', 'PER', 'ROE']

for col in numeric_cols:
    if col in df.columns:
        df[col] = clean_numeric_column(df[col])

print("숫자 컬럼 일괄 처리 완료")
print(df[['종목명', '현재가', '전일비']].head(3))
```

---

## 📊 데이터 분석 및 활용 예제

### 1. 기본 통계 정보 확인

```python
print("=== 기본 통계 정보 ===")
print(df.describe())

print("\n=== 시가총액 기준 상위 5개 종목 ===")
top_5_by_market_cap = df.dropna(subset=['시가총액']).sort_values(
    by='시가총액', ascending=False
).head(5)
print(top_5_by_market_cap[['종목명', '현재가', '시가총액']])

print("\n=== 거래량 기준 상위 5개 종목 ===")
top_5_by_volume = df.dropna(subset=['거래량']).sort_values(
    by='거래량', ascending=False
).head(5)
print(top_5_by_volume[['종목명', '거래량', '현재가']])
```

### 2. 조건부 필터링 및 분석

```python
# 고가 주식 필터링 (현재가 100,000원 이상)
high_price_stocks = df[df['현재가'] >= 100000]
print(f"\n=== 고가주 분석 (10만원 이상, {len(high_price_stocks)}개) ===")
print(high_price_stocks[['종목명', '현재가', '시가총액']].head())

# 상승 종목 분석
rising_stocks = df[df['전일비'] > 0]
print(f"\n=== 상승 종목 분석 ({len(rising_stocks)}개) ===")
if len(rising_stocks) > 0:
    print("평균 상승폭:", rising_stocks['전일비'].mean())
    print("상위 상승 종목:")
    print(rising_stocks.sort_values('전일비', ascending=False)[['종목명', '전일비']].head())

# 하락 종목 분석
falling_stocks = df[df['전일비'] < 0]
print(f"\n=== 하락 종목 분석 ({len(falling_stocks)}개) ===")
if len(falling_stocks) > 0:
    print("평균 하락폭:", falling_stocks['전일비'].mean())
    print("하위 하락 종목:")
    print(falling_stocks.sort_values('전일비')[['종목명', '전일비']].head())
```

### 3. 그룹별 분석

```python
# 가격대별 그룹 분석
df['가격대'] = pd.cut(df['현재가'], 
                    bins=[0, 10000, 50000, 100000, float('inf')],
                    labels=['저가주(1만원 미만)', '중저가주(1-5만원)', '중고가주(5-10만원)', '고가주(10만원 이상)'])

price_group_analysis = df.groupby('가격대').agg({
    '종목명': 'count',
    '현재가': 'mean',
    '시가총액': 'mean',
    '거래량': 'mean'
}).round(2)
price_group_analysis.columns = ['종목 수', '평균 현재가', '평균 시가총액', '평균 거래량']
print("\n=== 가격대별 분석 ===")
print(price_group_analysis)
```

### 4. 상관관계 분석

```python
# 주요 지표 간 상관관계 분석
correlation_cols = ['현재가', '시가총액', '거래량', 'PER', 'ROE']
available_cols = [col for col in correlation_cols if col in df.columns]

if len(available_cols) >= 2:
    correlation_matrix = df[available_cols].corr()
    print("\n=== 주요 지표 상관관계 ===")
    print(correlation_matrix)
```

---

## 📈 데이터 시각화 준비

### 1. 시각화를 위한 데이터 준비

```python
import matplotlib.pyplot as plt
import seaborn as sns
plt.rcParams['font.family'] = 'DejaVu Sans'  # 한글 폰트 설정 (환경에 따라 조정)

# 상위 10개 종목 시가총액 시각화 데이터 준비
top_10_market_cap = df.dropna(subset=['시가총액']).sort_values(
    by='시가총액', ascending=False
).head(10)

print("=== 시각화용 데이터 (상위 10개 종목) ===")
print(top_10_market_cap[['종목명', '시가총액']])
```

### 2. 간단한 시각화 예제

```python
# 주의: 실제 환경에서는 matplotlib, seaborn 설치 및 한글 폰트 설정 필요

def create_visualization_code():
    """시각화 코드 예제 (실행용)"""
    code = '''
# 시가총액 상위 10개 종목 바차트
plt.figure(figsize=(12, 6))
plt.bar(top_10_market_cap['종목명'], top_10_market_cap['시가총액'])
plt.title('시가총액 상위 10개 종목')
plt.xlabel('종목명')
plt.ylabel('시가총액')
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# 현재가 분포 히스토그램
plt.figure(figsize=(10, 6))
plt.hist(df['현재가'].dropna(), bins=50, edgecolor='black')
plt.title('현재가 분포')
plt.xlabel('현재가')
plt.ylabel('빈도')
plt.show()

# 전일비 분포 (상승/하락)
rising_count = len(df[df['전일비'] > 0])
falling_count = len(df[df['전일비'] < 0])
unchanged_count = len(df[df['전일비'] == 0])

plt.figure(figsize=(8, 6))
plt.pie([rising_count, falling_count, unchanged_count], 
        labels=['상승', '하락', '보합'], 
        autopct='%1.1f%%')
plt.title('주가 등락 분포')
plt.show()
'''
    return code

visualization_code = create_visualization_code()
print("\n=== 시각화 코드 예제 ===")
print(visualization_code)
```

---

## 🔍 고급 분석 예제

### 1. 투자 지표 계산

```python
def calculate_investment_metrics(df):
    """투자 관련 지표 계산"""
    result_df = df.copy()
    
    # 시가총액 대비 거래량 비율 (유동성 지표)
    if '시가총액' in df.columns and '거래량' in df.columns:
        result_df['거래량_비율'] = (result_df['거래량'] / result_df['시가총액'] * 100).round(4)
    
    # 등락률 기반 변동성 구간 분류
    if '등락률' in df.columns:
        result_df['변동성_구간'] = pd.cut(
            result_df['등락률'].abs(),
            bins=[0, 2, 5, 10, float('inf')],
            labels=['낮음(2% 미만)', '보통(2-5%)', '높음(5-10%)', '매우높음(10% 이상)']
        )
    
    return result_df

# 투자 지표 계산 적용
df_with_metrics = calculate_investment_metrics(df)

print("=== 투자 지표가 추가된 데이터 ===")
if '거래량_비율' in df_with_metrics.columns:
    print("거래량 비율 상위 5개:")
    top_liquidity = df_with_metrics.dropna(subset=['거래량_비율']).sort_values(
        '거래량_비율', ascending=False
    ).head(5)
    print(top_liquidity[['종목명', '거래량_비율']])

if '변동성_구간' in df_with_metrics.columns:
    print("\n변동성 구간별 종목 수:")
    print(df_with_metrics['변동성_구간'].value_counts())
```

### 2. 스크리닝 (종목 선별) 예제

```python
def screen_stocks(df, criteria):
    """다중 조건을 이용한 종목 스크리닝"""
    filtered_df = df.copy()
    
    for criterion, value in criteria.items():
        if criterion == 'min_market_cap':
            filtered_df = filtered_df[filtered_df['시가총액'] >= value]
        elif criterion == 'max_per':
            filtered_df = filtered_df[filtered_df['PER'] <= value]
        elif criterion == 'min_roe':
            filtered_df = filtered_df[filtered_df['ROE'] >= value]
        elif criterion == 'min_volume':
            filtered_df = filtered_df[filtered_df['거래량'] >= value]
    
    return filtered_df

# 스크리닝 조건 설정
screening_criteria = {
    'min_market_cap': 1000000,  # 시가총액 100만 이상
    'max_per': 15,              # PER 15 이하
    'min_roe': 5                # ROE 5% 이상
}

screened_stocks = screen_stocks(df, screening_criteria)
print(f"\n=== 스크리닝 결과 ({len(screened_stocks)}개 종목) ===")
if len(screened_stocks) > 0:
    print(screened_stocks[['종목명', '현재가', '시가총액', 'PER', 'ROE']].head(10))
else:
    print("조건에 맞는 종목이 없습니다.")
```

### 3. 포트폴리오 구성 예제

```python
def create_sample_portfolio(df, portfolio_size=5, weighting_method='equal'):
    """샘플 포트폴리오 생성"""
    
    # 기본 필터링 (결측값이 적은 종목 선택)
    clean_df = df.dropna(subset=['현재가', '시가총액'])
    
    if len(clean_df) < portfolio_size:
        return None
    
    if weighting_method == 'market_cap':
        # 시가총액 가중 방식
        selected = clean_df.nlargest(portfolio_size, '시가총액')
        total_market_cap = selected['시가총액'].sum()
        selected['비중'] = (selected['시가총액'] / total_market_cap * 100).round(2)
    else:
        # 동일 가중 방식
        selected = clean_df.sample(n=portfolio_size) if len(clean_df) >= portfolio_size else clean_df
        selected['비중'] = round(100 / len(selected), 2)
    
    return selected[['종목명', '현재가', '시가총액', '비중']]

# 포트폴리오 생성 예제
print("\n=== 샘플 포트폴리오 (시가총액 가중) ===")
market_cap_portfolio = create_sample_portfolio(df, portfolio_size=5, weighting_method='market_cap')
if market_cap_portfolio is not None:
    print(market_cap_portfolio)
    print(f"총 비중: {market_cap_portfolio['비중'].sum()}%")

print("\n=== 샘플 포트폴리오 (동일 가중) ===")
equal_weight_portfolio = create_sample_portfolio(df, portfolio_size=5, weighting_method='equal')
if equal_weight_portfolio is not None:
    print(equal_weight_portfolio)
    print(f"총 비중: {equal_weight_portfolio['비중'].sum()}%")
```

---

## 💾 분석 결과 저장 및 보고

### 1. 분석 결과를 Excel로 저장

```python
def save_analysis_to_excel(df, filename='주식분석결과.xlsx'):
    """분석 결과를 Excel 파일로 저장"""
    
    with pd.ExcelWriter(filename, engine='openpyxl') as writer:
        # 전체 데이터
        df.to_excel(writer, sheet_name='전체데이터', index=False)
        
        # 시가총액 상위 20개
        top_20 = df.dropna(subset=['시가총액']).sort_values(
            '시가총액', ascending=False
        ).head(20)
        top_20.to_excel(writer, sheet_name='시가총액상위20', index=False)
        
        # 상승 종목만
        rising = df[df['전일비'] > 0]
        if len(rising) > 0:
            rising.to_excel(writer, sheet_name='상승종목', index=False)
        
        # 하락 종목만
        falling = df[df['전일비'] < 0]
        if len(falling) > 0:
            falling.to_excel(writer, sheet_name='하락종목', index=False)
    
    print(f"분석 결과가 '{filename}' 파일로 저장되었습니다.")

# Excel 저장 실행
save_analysis_to_excel(df)
```

### 2. 요약 보고서 생성

```python
def generate_summary_report(df):
    """요약 보고서 생성"""
    
    report = []
    report.append("=" * 50)
    report.append("주식 데이터 분석 요약 보고서")
    report.append("=" * 50)
    report.append(f"분석 일시: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M:%S')}")
    report.append(f"총 종목 수: {len(df)}")
    
    # 기본 통계
    if '현재가' in df.columns:
        report.append(f"평균 현재가: {df['현재가'].mean():.0f}원")
        report.append(f"최고 현재가: {df['현재가'].max():.0f}원")
        report.append(f"최저 현재가: {df['현재가'].min():.0f}원")
    
    # 등락 현황
    if '전일비' in df.columns:
        rising = len(df[df['전일비'] > 0])
        falling = len(df[df['전일비'] < 0])
        unchanged = len(df[df['전일비'] == 0])
        
        report.append("\n< 등락 현황 >")
        report.append(f"상승 종목: {rising}개 ({rising/len(df)*100:.1f}%)")
        report.append(f"하락 종목: {falling}개 ({falling/len(df)*100:.1f}%)")
        report.append(f"보합 종목: {unchanged}개 ({unchanged/len(df)*100:.1f}%)")
    
    # 시가총액 상위 5개
    if '시가총액' in df.columns:
        top_5 = df.dropna(subset=['시가총액']).nlargest(5, '시가총액')
        report.append("\n< 시가총액 상위 5개 종목 >")
        for idx, row in top_5.iterrows():
            report.append(f"{row['종목명']}: {row['시가총액']:,.0f}")
    
    report.append("=" * 50)
    
    return "\n".join(report)

# 요약 보고서 생성 및 출력
summary = generate_summary_report(df)
print(summary)

# 텍스트 파일로 저장
with open('주식분석_요약보고서.txt', 'w', encoding='utf-8') as f:
    f.write(summary)
print("\n요약 보고서가 '주식분석_요약보고서.txt' 파일로 저장되었습니다.")
```

---

## 🎯 실무 활용 팁

### 1. 데이터 품질 관리

```python
def check_data_quality(df):
    """데이터 품질 점검"""
    
    quality_report = {
        '총_행수': len(df),
        '총_컬럼수': len(df.columns),
        '결측값_비율': (df.isnull().sum().sum() / (len(df) * len(df.columns)) * 100),
        '중복행_수': df.duplicated().sum(),
        '숫자컬럼_수': len(df.select_dtypes(include=[np.number]).columns),
        '문자컬럼_수': len(df.select_dtypes(include=['object']).columns)
    }
    
    print("=== 데이터 품질 점검 결과 ===")
    for key, value in quality_report.items():
        if '비율' in key:
            print(f"{key}: {value:.2f}%")
        else:
            print(f"{key}: {value}")
    
    return quality_report

# 데이터 품질 점검 실행
quality_check = check_data_quality(df)
```

### 2. 자동화 함수 예제

```python
def automated_stock_analysis(csv_file):
    """주식 데이터 자동 분석 함수"""
    
    # 1. 데이터 로드
    df = pd.read_csv(csv_file, dtype=str, index_col=False)
    
    # 2. 데이터 전처리
    df = preprocess_stock_data(df)  # 앞서 정의한 전처리 함수 사용
    
    # 3. 기본 분석
    analysis_results = {
        'basic_stats': df.describe(),
        'top_by_market_cap': df.nlargest(10, '시가총액'),
        'top_by_volume': df.nlargest(10, '거래량'),
        'rising_stocks': df[df['전일비'] > 0],
        'falling_stocks': df[df['전일비'] < 0]
    }
    
    # 4. 결과 저장
    save_analysis_to_excel(df, f'analysis_{pd.Timestamp.now().strftime("%Y%m%d")}.xlsx')
    
    return analysis_results

# 사용 예제
# results = automated_stock_analysis('네이버코스피.csv')
```

---

## 🤖(추가학습습) 완전 자동화: 원스톱 분석 시스템

### 종합 자동화 함수

```python
def automated_stock_analysis(csv_file='네이버코스피.csv', output_dir='analysis_results'):
    """
    주식 데이터 완전 자동화 분석 시스템
    - 데이터 로드부터 보고서 생성까지 원스톱 처리
    """
    import os
    from datetime import datetime
    
    # 출력 디렉토리 생성
    if not os.path.exists(output_dir):
        os.makedirs(output_dir)
    
    print("🚀 주식 데이터 자동 분석 시스템 시작")
    print("=" * 50)
    
    try:
        # 1단계: 데이터 로드 및 전처리
        print("1️⃣ 데이터 로드 및 전처리 중...")
        df = pd.read_csv(csv_file, dtype=str, index_col=False)
        print(f"   ✅ 원본 데이터 로드 완료: {len(df)}개 행")
        
        # 전처리 적용
        df = apply_full_preprocessing(df)
        print(f"   ✅ 데이터 전처리 완료: {len(df)}개 유효 행")
        
        # 2단계: 기본 분석 실행
        print("\n2️⃣ 기본 분석 실행 중...")
        basic_results = perform_basic_analysis(df)
        print(f"   ✅ 기본 통계 분석 완료")
        
        # 3단계: 고급 분석 실행
        print("\n3️⃣ 고급 분석 실행 중...")
        advanced_results = perform_advanced_analysis(df)
        print(f"   ✅ 투자 지표 및 포트폴리오 분석 완료")
        
        # 4단계: 시각화 생성
        print("\n4️⃣ 시각화 생성 중...")
        chart_paths = create_all_charts(df, output_dir)
        print(f"   ✅ {len(chart_paths)}개 차트 생성 완료")
        
        # 5단계: 종합 보고서 생성
        print("\n5️⃣ 종합 보고서 생성 중...")
        report_paths = generate_comprehensive_reports(
            df, basic_results, advanced_results, output_dir
        )
        print(f"   ✅ {len(report_paths)}개 보고서 생성 완료")
        
        # 6단계: 결과 요약 출력
        print("\n📊 분석 완료 요약")
        print("=" * 50)
        print(f"📁 결과 저장 위치: {output_dir}")
        print(f"📈 분석 종목 수: {len(df)}")
        print(f"📋 생성된 파일:")
        
        all_files = []
        for root, dirs, files in os.walk(output_dir):
            for file in files:
                all_files.append(os.path.join(root, file))
        
        for i, file_path in enumerate(all_files, 1):
            print(f"   {i}. {os.path.basename(file_path)}")
        
        return {
            'dataframe': df,
            'basic_results': basic_results,
            'advanced_results': advanced_results,
            'output_files': all_files
        }
        
    except Exception as e:
        print(f"❌ 분석 중 오류 발생: {str(e)}")
        return None

def apply_full_preprocessing(df):
    """전체 데이터 전처리 파이프라인"""
    
    # 기본 정제
    df['종목명'] = df['종목명'].str.replace('\n', '').str.strip()
    
    # 전일비 전처리
    df['전일비'] = df['전일비'].apply(clean_change_direction)
    
    # 숫자형 컬럼 전처리
    numeric_cols = ['현재가', '등락률', '액면가', '시가총액', '상장주식수', 
                   '외국인비율', '거래량', 'PER', 'ROE']
    
    for col in numeric_cols:
        if col in df.columns:
            df[col] = clean_numeric_column(df[col])
    
    return df

def perform_basic_analysis(df):
    """기본 분석 실행"""
    
    results = {}
    
    # 기본 통계
    results['basic_stats'] = df.describe()
    
    # 상위 종목들
    results['top_market_cap'] = df.dropna(subset=['시가총액']).nlargest(10, '시가총액')
    results['top_volume'] = df.dropna(subset=['거래량']).nlargest(10, '거래량')
    results['top_price'] = df.dropna(subset=['현재가']).nlargest(10, '현재가')
    
    # 등락 현황
    results['rising_stocks'] = df[df['전일비'] > 0]
    results['falling_stocks'] = df[df['전일비'] < 0]
    results['unchanged_stocks'] = df[df['전일비'] == 0]
    
    return results

def perform_advanced_analysis(df):
    """고급 분석 실행"""
    
    results = {}
    
    # 투자 지표 계산
    df_with_metrics = calculate_investment_metrics(df)
    results['investment_metrics'] = df_with_metrics
    
    # 종목 스크리닝
    screening_criteria = {
        'min_market_cap': 1000000,
        'max_per': 15,
        'min_roe': 5
    }
    results['screened_stocks'] = screen_stocks(df, screening_criteria)
    
    # 포트폴리오 구성
    results['market_cap_portfolio'] = create_sample_portfolio(
        df, portfolio_size=10, weighting_method='market_cap'
    )
    results['equal_weight_portfolio'] = create_sample_portfolio(
        df, portfolio_size=10, weighting_method='equal'
    )
    
    return results

def create_all_charts(df, output_dir):
    """모든 차트 생성 (시각화 코드 템플릿)"""
    
    chart_paths = []
    
    # 주의: 실제 환경에서는 matplotlib 설치 필요
    chart_code_templates = {
        'market_cap_chart': '''
# 시가총액 상위 10개 종목
top_10 = df.nlargest(10, '시가총액')
plt.figure(figsize=(12, 6))
plt.bar(top_10['종목명'], top_10['시가총액'])
plt.title('시가총액 상위 10개 종목')
plt.xticks(rotation=45)
plt.tight_layout()
plt.savefig(f'{output_dir}/시가총액_상위종목.png')
plt.close()
        ''',
        
        'price_distribution': '''
# 현재가 분포 히스토그램
plt.figure(figsize=(10, 6))
plt.hist(df['현재가'].dropna(), bins=50, edgecolor='black')
plt.title('현재가 분포')
plt.xlabel('현재가')
plt.ylabel('빈도')
plt.savefig(f'{output_dir}/현재가_분포.png')
plt.close()
        ''',
        
        'change_pie_chart': '''
# 등락 비율 파이차트
rising = len(df[df['전일비'] > 0])
falling = len(df[df['전일비'] < 0])
unchanged = len(df[df['전일비'] == 0])

plt.figure(figsize=(8, 8))
plt.pie([rising, falling, unchanged], 
        labels=['상승', '하락', '보합'],
        autopct='%1.1f%%')
plt.title('주가 등락 분포')
plt.savefig(f'{output_dir}/등락_분포.png')
plt.close()
        '''
    }
    
    # 차트 코드 템플릿을 파일로 저장
    for chart_name, code in chart_code_templates.items():
        code_path = os.path.join(output_dir, f'{chart_name}_code.py')
        with open(code_path, 'w', encoding='utf-8') as f:
            f.write(f"import matplotlib.pyplot as plt\nimport pandas as pd\n\n")
            f.write(f"# {chart_name} 생성 코드\n")
            f.write(f"df = pd.read_csv('전처리된_데이터.csv')\n")
            f.write(code)
        chart_paths.append(code_path)
    
    return chart_paths

def generate_comprehensive_reports(df, basic_results, advanced_results, output_dir):
    """종합 보고서 생성"""
    
    report_paths = []
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    
    # 1. Excel 종합 분석 파일
    excel_path = os.path.join(output_dir, f'주식분석_종합보고서_{timestamp}.xlsx')
    
    with pd.ExcelWriter(excel_path, engine='openpyxl') as writer:
        # 전체 데이터
        df.to_excel(writer, sheet_name='전체데이터', index=False)
        
        # 기본 분석 결과들
        basic_results['basic_stats'].to_excel(writer, sheet_name='기본통계')
        basic_results['top_market_cap'][['종목명', '현재가', '시가총액']].to_excel(
            writer, sheet_name='시가총액상위', index=False)
        basic_results['top_volume'][['종목명', '현재가', '거래량']].to_excel(
            writer, sheet_name='거래량상위', index=False)
        
        # 등락 현황
        if len(basic_results['rising_stocks']) > 0:
            basic_results['rising_stocks'][['종목명', '현재가', '전일비']].to_excel(
                writer, sheet_name='상승종목', index=False)
        
        if len(basic_results['falling_stocks']) > 0:
            basic_results['falling_stocks'][['종목명', '현재가', '전일비']].to_excel(
                writer, sheet_name='하락종목', index=False)
        
        # 고급 분석 결과
        if advanced_results['screened_stocks'] is not None and len(advanced_results['screened_stocks']) > 0:
            advanced_results['screened_stocks'].to_excel(
                writer, sheet_name='선별된종목', index=False)
        
        if advanced_results['market_cap_portfolio'] is not None:
            advanced_results['market_cap_portfolio'].to_excel(
                writer, sheet_name='추천포트폴리오', index=False)
    
    report_paths.append(excel_path)
    
    # 2. 텍스트 요약 보고서
    txt_path = os.path.join(output_dir, f'분석요약보고서_{timestamp}.txt')
    summary_report = generate_detailed_summary(df, basic_results, advanced_results)
    
    with open(txt_path, 'w', encoding='utf-8') as f:
        f.write(summary_report)
    
    report_paths.append(txt_path)
    
    # 3. 전처리된 데이터 저장
    processed_data_path = os.path.join(output_dir, '전처리된_데이터.csv')
    df.to_csv(processed_data_path, index=False, encoding='utf-8-sig')
    report_paths.append(processed_data_path)
    
    return report_paths

def generate_detailed_summary(df, basic_results, advanced_results):
    """상세 요약 보고서 생성"""
    
    report = []
    report.append("=" * 60)
    report.append("📈 주식 데이터 종합 분석 보고서")
    report.append("=" * 60)
    report.append(f"📅 분석 일시: {datetime.now().strftime('%Y년 %m월 %d일 %H시 %M분')}")
    report.append(f"📊 분석 대상: {len(df)}개 종목")
    report.append("")
    
    # 1. 전체 현황
    report.append("🔍 1. 전체 시장 현황")
    report.append("-" * 30)
    if '현재가' in df.columns:
        avg_price = df['현재가'].mean()
        max_price = df['현재가'].max()
        min_price = df['현재가'].min()
        report.append(f"• 평균 주가: {avg_price:,.0f}원")
        report.append(f"• 최고 주가: {max_price:,.0f}원")
        report.append(f"• 최저 주가: {min_price:,.0f}원")
    
    # 2. 등락 현황
    report.append("\n📊 2. 등락 현황")
    report.append("-" * 30)
    rising_count = len(basic_results['rising_stocks'])
    falling_count = len(basic_results['falling_stocks'])
    unchanged_count = len(basic_results['unchanged_stocks'])
    total_count = rising_count + falling_count + unchanged_count
    
    if total_count > 0:
        report.append(f"• 상승 종목: {rising_count}개 ({rising_count/total_count*100:.1f}%)")
        report.append(f"• 하락 종목: {falling_count}개 ({falling_count/total_count*100:.1f}%)")
        report.append(f"• 보합 종목: {unchanged_count}개 ({unchanged_count/total_count*100:.1f}%)")
    
    # 3. 상위 종목
    report.append("\n🏆 3. 주요 상위 종목")
    report.append("-" * 30)
    report.append("[ 시가총액 상위 5개 ]")
    top_5_market = basic_results['top_market_cap'].head(5)
    for idx, row in top_5_market.iterrows():
        report.append(f"  {row['종목명']}: {row['시가총액']:,.0f}")
    
    report.append("\n[ 거래량 상위 5개 ]")
    top_5_volume = basic_results['top_volume'].head(5)
    for idx, row in top_5_volume.iterrows():
        report.append(f"  {row['종목명']}: {row['거래량']:,.0f}")
    
    # 4. 투자 추천
    report.append("\n💡 4. 투자 관점 분석")
    report.append("-" * 30)
    
    if advanced_results['screened_stocks'] is not None and len(advanced_results['screened_stocks']) > 0:
        screened_count = len(advanced_results['screened_stocks'])
        report.append(f"• 투자 기준 충족 종목: {screened_count}개")
        report.append("  (시가총액 100만 이상, PER 15 이하, ROE 5% 이상)")
        
        if screened_count <= 5:
            report.append("  추천 종목:")
            for idx, row in advanced_results['screened_stocks'].iterrows():
                report.append(f"    - {row['종목명']}")
    else:
        report.append("• 설정된 투자 기준을 충족하는 종목이 없습니다.")
    
    # 5. 포트폴리오 제안
    if advanced_results['market_cap_portfolio'] is not None:
        report.append("\n📋 5. 추천 포트폴리오 (시가총액 가중)")
        report.append("-" * 30)
        portfolio = advanced_results['market_cap_portfolio']
        for idx, row in portfolio.iterrows():
            report.append(f"• {row['종목명']}: {row['비중']}%")
    
    report.append("\n" + "=" * 60)
    report.append("※ 본 분석은 참고용이며, 투자 결정은 신중히 하시기 바랍니다.")
    report.append("=" * 60)
    
    return "\n".join(report)

# 🚀 자동화 시스템 실행 함수
def run_complete_analysis(csv_file='네이버코스피.csv'):
    """
    완전 자동화 분석 실행
    사용법: run_complete_analysis('네이버코스피.csv')
    """
    
    print("🎯 주식 데이터 원스톱 분석 시스템")
    print("🔄 모든 분석과정을 자동으로 실행합니다...")
    
    # 전체 분석 실행
    results = automated_stock_analysis(csv_file)
    
    if results:
        print("\n🎉 분석 완료!")
        print("📂 생성된 파일들을 확인하세요.")
        print("\n💡 활용 팁:")
        print("  1. Excel 파일로 상세 데이터 확인")
        print("  2. 텍스트 보고서로 핵심 인사이트 파악")
        print("  3. 차트 코드 실행으로 시각화 생성")
        
        return results
    else:
        print("❌ 분석 실행 중 문제가 발생했습니다.")
        return None

# 실행 예시
# results = run_complete_analysis('네이버코스피.csv')
```

### 자동화 시스템 특징

#### 🎯 **원스톱 분석**
- 데이터 로드 → 전처리 → 분석 → 시각화 → 보고서 생성까지 한 번에
- 모든 중간 과정 자동 저장 및 백업

#### 📊 **생성되는 결과물**
1. **Excel 종합 보고서** - 모든 분석 결과를 시트별로 정리
2. **텍스트 요약 보고서** - 핵심 인사이트와 투자 관점 정리
3. **시각화 코드 파일** - 바로 실행 가능한 차트 생성 코드
4. **전처리된 데이터** - 추가 분석용 정제된 CSV 파일

#### 🔧 **사용법**
```python
# 단 한 줄로 모든 분석 완료
results = run_complete_analysis('네이버코스피.csv')

# 또는 더 상세한 제어를 원할 경우
results = automated_stock_analysis(
    csv_file='네이버코스피.csv',
    output_dir='내가_원하는_폴더명'
)
```

이 자동화 시스템으로 **복잡한 주식 분석을 단 몇 분만에 완료**하고, **전문적인 수준의 보고서**를 자동으로 생성할 수 있습니다! 🚀

---

## 📚 핵심 요약

### 읽어온 데이터 활용 단계

1. **데이터 로드 및 점검**
   - CSV 읽기, 구조 파악, 결측값 확인

2. **데이터 전처리**
   - 텍스트 정제, 숫자형 변환, 특수문자 처리

3. **기본 분석**
   - 통계 정보, 정렬, 필터링

4. **고급 분석**
   - 그룹별 분석, 상관관계, 투자 지표 계산

5. **시각화 및 보고**
   - 차트 생성, Excel 저장, 요약 보고서

6. **자동화 시스템**
   - 원스톱 분석, 종합 보고서 자동 생성

### 실무에서 자주 사용하는 패턴

```python
# 패턴 1: 조건별 필터링
high_value_stocks = df[
    (df['시가총액'] > 1000000) & 
    (df['PER'] < 15) & 
    (df['ROE'] > 5)
]

# 패턴 2: 그룹별 집계
sector_analysis = df.groupby('업종')['시가총액'].agg(['sum', 'mean', 'count'])

# 패턴 3: 순위 매기기
df['시가총액_순위'] = df['시가총액'].rank(ascending=False)

# 패턴 4: 백분위수 활용
df['가격_백분위'] = df['현재가'].rank(pct=True) * 100

# 패턴 5: 원스톱 자동화
results = run_complete_analysis('네이버코스피.csv')
```

이러한 패턴들을 조합하여 다양한 분석 요구사항에 대응할 수 있습니다! 🎯