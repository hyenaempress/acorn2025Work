# 20.02 Django 뷰 함수와 CSV 데이터 처리 가이드

## 목차
1. [뷰 함수 완전 구현](#뷰-함수-완전-구현)
2. [CSV 데이터 다운로드 및 처리](#csv-데이터-다운로드-및-처리)
3. [데이터 시각화 구현](#데이터-시각화-구현)
4. [템플릿 구현](#템플릿-구현)
5. [URL 연결](#url-연결)
6. [시애틀 날씨 데이터 분석](#시애틀-날씨-데이터-분석)
7. [완성된 웹 애플리케이션](#완성된-웹-애플리케이션)
8. [트러블슈팅](#트러블슈팅)

---

## 뷰 함수 완전 구현

### myapp/views.py 완성 코드

```python
from django.shortcuts import render
import json, os
import pandas as pd
import numpy as np
import requests
from django.conf import settings
from datetime import datetime
import matplotlib
matplotlib.use('Agg')  # GUI 없이 파일로 저장
import matplotlib.pyplot as plt
from pathlib import Path

# 데이터 디렉토리 및 파일 경로 설정
DATA_DIR = os.path.join(settings.BASE_DIR, 'data')
CSV_PATH = os.path.join(DATA_DIR, 'seattle_weather.csv')
CSV_URL = "https://raw.githubusercontent.com/vega/vega-datasets/master/data/seattle-weather.csv"

def index(request):
    """메인 페이지 렌더링"""
    return render(request, 'index.html')

def csvFunc():
    """CSV 파일 다운로드 및 로컬 저장 함수"""
    # 데이터 디렉토리 생성
    os.makedirs(DATA_DIR, exist_ok=True)
    
    # CSV 파일이 없으면 다운로드
    if not os.path.exists(CSV_PATH):
        print(f"CSV 파일이 없습니다. 다운로드 중... {CSV_URL}")
        try:
            res = requests.get(CSV_URL, timeout=20)  # 20초 타임아웃
            res.raise_for_status()  # HTTP 오류 시 예외 발생
            
            # CSV 파일 저장
            with open(CSV_PATH, 'w', encoding='utf-8') as f:
                f.write(res.text)
            print(f"CSV 파일 다운로드 완료: {CSV_PATH}")
            
        except requests.exceptions.RequestException as e:
            print(f"CSV 다운로드 실패: {e}")
            raise
    else:
        print(f"CSV 파일 존재: {CSV_PATH}")

def show(request):
    """시애틀 날씨 데이터 분석 및 시각화"""
    
    try:
        # 1. CSV 파일 확인 및 다운로드
        csvFunc()
        
        # 2. 데이터 로딩
        df = pd.read_csv(CSV_PATH)
        print(f"데이터 로딩 완료. 형태: {df.shape}")
        
        # 3. 데이터 기본 정보 생성
        data_info = {
            'shape': df.shape,
            'columns': df.columns.tolist(),
            'dtypes': df.dtypes.to_dict(),
            'null_counts': df.isnull().sum().to_dict(),
            'description': df.describe().to_html(classes='table table-striped table-sm')
        }
        
        # 4. 이미지 저장 경로 설정
        static_img_dir = Path(settings.BASE_DIR) / 'static' / 'images'
        static_img_dir.mkdir(parents=True, exist_ok=True)
        
        # 5. 날씨별 빈도 파이 차트 생성
        weather_counts = df['weather'].value_counts()
        
        plt.figure(figsize=(10, 8))
        plt.pie(weather_counts.values, 
                labels=weather_counts.index, 
                autopct='%1.1f%%', 
                startangle=90)
        plt.title('시애틀 날씨 분포', fontsize=16, fontweight='bold')
        plt.axis('equal')
        
        pie_chart_path = static_img_dir / 'seattle_weather_pie.png'
        plt.savefig(pie_chart_path, dpi=150, bbox_inches='tight')
        plt.close()
        
        # 6. 월별 기온 변화 라인 차트 생성
        # 날짜 컬럼을 datetime으로 변환
        df['date'] = pd.to_datetime(df['date'])
        df['month'] = df['date'].dt.month
        
        # 월별 평균 기온 계산
        monthly_temp = df.groupby('month').agg({
            'temp_max': 'mean',
            'temp_min': 'mean'
        }).round(2)
        
        plt.figure(figsize=(12, 6))
        plt.plot(monthly_temp.index, monthly_temp['temp_max'], 
                marker='o', linewidth=2, label='최고기온', color='red')
        plt.plot(monthly_temp.index, monthly_temp['temp_min'], 
                marker='s', linewidth=2, label='최저기온', color='blue')
        
        plt.title('시애틀 월별 평균 기온 변화', fontsize=16, fontweight='bold')
        plt.xlabel('월', fontsize=12)
        plt.ylabel('온도 (°C)', fontsize=12)
        plt.legend()
        plt.grid(True, alpha=0.3)
        plt.xticks(range(1, 13))
        
        line_chart_path = static_img_dir / 'seattle_weather_line.png'
        plt.savefig(line_chart_path, dpi=150, bbox_inches='tight')
        plt.close()
        
        # 7. 데이터 테이블 HTML 생성 (처음 20행만)
        sample_data = df.head(20)
        table_html = sample_data.to_html(
            classes='table table-striped table-sm table-hover',
            index=False,
            escape=False
        )
        
        # 8. 템플릿에 전달할 컨텍스트 데이터
        context = {
            'data_info': data_info,
            'table_html': table_html,
            'pie_chart_path': 'images/seattle_weather_pie.png',
            'line_chart_path': 'images/seattle_weather_line.png',
            'weather_counts': weather_counts.to_dict(),
            'monthly_temp': monthly_temp.to_dict(),
            'total_records': len(df),
            'date_range': {
                'start': df['date'].min().strftime('%Y-%m-%d'),
                'end': df['date'].max().strftime('%Y-%m-%d')
            }
        }
        
        return render(request, 'show.html', context)
        
    except Exception as e:
        # 에러 발생 시 에러 페이지 표시
        error_context = {
            'error_message': str(e),
            'error_type': type(e).__name__
        }
        return render(request, 'error.html', error_context)
```

---

## CSV 데이터 다운로드 및 처리

### csvFunc() 함수 상세 분석

```python
def csvFunc():
    """CSV 파일 다운로드 및 로컬 저장 함수"""
    
    # 1. 데이터 디렉토리 생성
    os.makedirs(DATA_DIR, exist_ok=True)
    
    # 2. CSV 파일 존재 확인
    if not os.path.exists(CSV_PATH):
        print(f"CSV 파일이 없습니다. 다운로드 중... {CSV_URL}")
        
        try:
            # 3. HTTP 요청으로 CSV 데이터 다운로드
            res = requests.get(CSV_URL, timeout=20)
            res.raise_for_status()  # HTTP 에러 시 예외 발생
            
            # 4. 파일 저장
            with open(CSV_PATH, 'w', encoding='utf-8') as f:
                f.write(res.text)
            
            print(f"CSV 파일 다운로드 완료: {CSV_PATH}")
            
        except requests.exceptions.RequestException as e:
            print(f"CSV 다운로드 실패: {e}")
            raise
    else:
        print(f"CSV 파일 존재: {CSV_PATH}")
```

### 핵심 포인트

1. **디렉토리 자동 생성**: `os.makedirs(DATA_DIR, exist_ok=True)`
2. **파일 존재 확인**: `os.path.exists(CSV_PATH)`
3. **타임아웃 설정**: `requests.get(CSV_URL, timeout=20)`
4. **HTTP 오류 처리**: `res.raise_for_status()`
5. **예외 처리**: `try-except`로 안전한 다운로드

---

## 데이터 시각화 구현

### 1. 파이 차트 (날씨 분포)

```python
# 날씨별 빈도 계산
weather_counts = df['weather'].value_counts()

# 파이 차트 생성
plt.figure(figsize=(10, 8))
plt.pie(weather_counts.values, 
        labels=weather_counts.index, 
        autopct='%1.1f%%', 
        startangle=90)
plt.title('시애틀 날씨 분포', fontsize=16, fontweight='bold')
plt.axis('equal')

# 파일 저장
pie_chart_path = static_img_dir / 'seattle_weather_pie.png'
plt.savefig(pie_chart_path, dpi=150, bbox_inches='tight')
plt.close()  # 메모리 정리
```

### 2. 라인 차트 (월별 기온 변화)

```python
# 날짜 데이터 처리
df['date'] = pd.to_datetime(df['date'])
df['month'] = df['date'].dt.month

# 월별 평균 기온 계산
monthly_temp = df.groupby('month').agg({
    'temp_max': 'mean',
    'temp_min': 'mean'
}).round(2)

# 라인 차트 생성
plt.figure(figsize=(12, 6))
plt.plot(monthly_temp.index, monthly_temp['temp_max'], 
        marker='o', linewidth=2, label='최고기온', color='red')
plt.plot(monthly_temp.index, monthly_temp['temp_min'], 
        marker='s', linewidth=2, label='최저기온', color='blue')

plt.title('시애틀 월별 평균 기온 변화', fontsize=16, fontweight='bold')
plt.xlabel('월', fontsize=12)
plt.ylabel('온도 (°C)', fontsize=12)
plt.legend()
plt.grid(True, alpha=0.3)
plt.xticks(range(1, 13))

# 파일 저장
line_chart_path = static_img_dir / 'seattle_weather_line.png'
plt.savefig(line_chart_path, dpi=150, bbox_inches='tight')
plt.close()
```

---

## 템플릿 구현

### templates/index.html (메인 페이지)

```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시애틀 날씨 데이터 분석</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Arial', sans-serif;
        }
        .main-container {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
        }
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            color: white;
            font-size: 18px;
            text-decoration: none;
            transition: transform 0.3s ease;
        }
        .btn-custom:hover {
            transform: translateY(-3px);
            color: white;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1 class="mb-4">시애틀 날씨 데이터 분석</h1>
        <p class="mb-4">시애틀의 날씨 데이터를 분석하고 시각화합니다.</p>
        
        <!-- 일반 링크 -->
        <a href="/show/" class="btn btn-custom mb-3">
            🌤️ 시애틀 날씨 데이터 기술 통계와 차트 보기
        </a>
        
        <br><br>
        
        <!-- Django URL 패턴 사용 -->
        <a href="{% url 'show' %}" class="btn btn-custom">
            📊 Django URL 패턴으로 데이터 보기
        </a>
    </div>
</body>
</html>
```

### templates/show.html (데이터 표시 페이지)

```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시애틀 날씨 데이터 분석 결과</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    {% load static %}
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <div class="header">
        <div class="container">
            <h1 class="text-center">🌦️ 시애틀 날씨 데이터 분석 결과</h1>
            <p class="text-center mb-0">데이터 기간: {{ date_range.start }} ~ {{ date_range.end }}</p>
        </div>
    </div>

    <div class="container">
        <!-- 데이터 개요 -->
        <div class="row">
            <div class="col-md-4">
                <div class="stats-card text-center">
                    <h5>총 레코드 수</h5>
                    <h2 class="text-primary">{{ total_records }}</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card text-center">
                    <h5>데이터 컬럼 수</h5>
                    <h2 class="text-success">{{ data_info.columns|length }}</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card text-center">
                    <h5>데이터 형태</h5>
                    <h2 class="text-info">{{ data_info.shape.0 }} × {{ data_info.shape.1 }}</h2>
                </div>
            </div>
        </div>

        <!-- 차트 섹션 -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h4 class="text-center mb-3">날씨 분포</h4>
                    <img src="{% static pie_chart_path %}" 
                         alt="시애틀 날씨 분포 파이 차트" 
                         class="img-fluid">
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h4 class="text-center mb-3">월별 기온 변화</h4>
                    <img src="{% static line_chart_path %}" 
                         alt="시애틀 월별 기온 변화 라인 차트" 
                         class="img-fluid">
                </div>
            </div>
        </div>

        <!-- 기술 통계 -->
        <div class="chart-container">
            <h4 class="mb-3">📈 기술 통계</h4>
            <div class="table-container">
                {{ data_info.description|safe }}
            </div>
        </div>

        <!-- 샘플 데이터 -->
        <div class="chart-container">
            <h4 class="mb-3">📋 샘플 데이터 (처음 20행)</h4>
            <div class="table-container">
                {{ table_html|safe }}
            </div>
        </div>

        <!-- 네비게이션 -->
        <div class="text-center mb-5">
            <a href="{% url 'index' %}" class="btn btn-primary btn-lg">
                🏠 메인으로 돌아가기
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
```

### templates/error.html (에러 페이지)

```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오류 발생</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="alert alert-danger">
                    <h4>❌ 오류가 발생했습니다</h4>
                    <p><strong>오류 타입:</strong> {{ error_type }}</p>
                    <p><strong>오류 메시지:</strong> {{ error_message }}</p>
                    <hr>
                    <a href="{% url 'index' %}" class="btn btn-primary">메인으로 돌아가기</a>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
```

---

## URL 연결

### mainapp/urls.py 수정

```python
from django.contrib import admin
from django.urls import path
from myapp import views

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', views.index, name='index'),     # 메인 페이지
    path('show/', views.show, name='show'),   # 데이터 분석 페이지
]
```

---

## 시애틀 날씨 데이터 분석

### 데이터셋 정보

**출처**: [Vega Datasets - Seattle Weather](https://raw.githubusercontent.com/vega/vega-datasets/master/data/seattle-weather.csv)

**컬럼 구성**:
- `date`: 날짜
- `precipitation`: 강수량 (mm)
- `temp_max`: 최고기온 (°C)
- `temp_min`: 최저기온 (°C)
- `wind`: 풍속 (km/h)
- `weather`: 날씨 상태 (sun, rain, snow, fog, drizzle)

### 분석 내용

1. **기본 통계**: `describe()` 함수로 수치형 데이터 요약
2. **날씨 분포**: 파이 차트로 날씨 상태별 빈도 시각화
3. **기온 변화**: 라인 차트로 월별 최고/최저 기온 추이
4. **데이터 품질**: 결측치 확인 및 데이터 타입 검증

---

## 완성된 웹 애플리케이션

### 주요 기능

1. **자동 CSV 다운로드**: 파일이 없으면 자동으로 웹에서 다운로드
2. **실시간 데이터 분석**: Pandas를 활용한 데이터 처리
3. **동적 시각화**: Matplotlib으로 차트 생성 및 웹 표시
4. **반응형 UI**: Bootstrap을 활용한 모바일 친화적 인터페이스
5. **에러 처리**: 예외 상황에 대한 사용자 친화적 에러 페이지

### 서버 실행 및 확인

```bash
# Django 개발 서버 실행
python manage.py runserver

# 브라우저에서 확인
# http://127.0.0.1:8000/        - 메인 페이지
# http://127.0.0.1:8000/show/   - 데이터 분석 페이지
```

---

## 트러블슈팅

### 1. requests 모듈 오류
```bash
pip install requests
```

### 2. matplotlib 백엔드 오류
```python
import matplotlib
matplotlib.use('Agg')  # GUI 없이 파일로 저장
```

### 3. 정적 파일 경로 오류
```python
# settings.py 확인
STATIC_URL = 'static/'
STATICFILES_DIRS = [BASE_DIR / 'static']
```

### 4. CSV 다운로드 타임아웃
```python
# 타임아웃 시간 증가
res = requests.get(CSV_URL, timeout=30)
```

### 5. 한글 폰트 문제 (matplotlib)
```python
# 한글 폰트 설정 (선택사항)
plt.rcParams['font.family'] = 'DejaVu Sans'
```

---

## 다음 단계

### 추가 개발 아이디어

1. **대화형 차트**: Plotly 또는 Chart.js 활용
2. **데이터 필터링**: 날짜 범위, 날씨 조건별 필터
3. **캐싱**: 반복 계산 결과 캐싱으로 성능 향상
4. **API 제공**: REST API로 데이터 제공
5. **데이터베이스 연동**: 모델을 통한 데이터 저장

### 학습 포인트

1. **Django 뷰 함수**: 복잡한 비즈니스 로직 처리
2. **외부 API 연동**: HTTP 요청으로 데이터 수집
3. **데이터 분석**: Pandas와 NumPy 활용
4. **웹 시각화**: Matplotlib을 웹에서 활용
5. **예외 처리**: 견고한 웹 애플리케이션 개발

이제 Django를 활용한 데이터 분석 웹 애플리케이션의 완전한 구현 방법을 이해했습니다! 🚀