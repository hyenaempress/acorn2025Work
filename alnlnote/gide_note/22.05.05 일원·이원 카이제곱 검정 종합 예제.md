# 22.05.05 일원·이원 카이제곱 검정 종합 예제

> **강의 핵심**: "일원과 이원 카이제곱을 실제 데이터로 실습하며 언제 어떤 검정을 사용하는지 구분해보겠습니다!"

## 🎯 학습 목표

- **일원 카이제곱**: 적합도(선호도) 검정 완전 이해
- **이원 카이제곱**: 독립성 검정을 통한 교차분석
- **실무 응용**: 다양한 분야의 실제 사례 분석
- **Python 활용**: scipy.stats와 pandas를 활용한 통계 분석

---

## 📊 Section 1: 일원 카이제곱 검정 (적합도 검정)

### 🎯 핵심 개념

**일원 카이제곱 검정**은 하나의 변인에 대해 **관찰된 빈도**가 **기대되는 빈도**와 일치하는지를 검정합니다.

```python
# 일원 카이제곱의 핵심 질문들
질문_유형 = {
    "적합도": "이론적 분포와 실제 관찰값이 맞는가?",
    "선호도": "모든 범주가 동일하게 선호되는가?", 
    "공정성": "동전, 주사위가 공정한가?",
    "균등성": "각 범주의 비율이 예상과 같은가?"
}
```

### 🎲 예제 1: 주사위 공정성 검정 (코드 실습)

**상황**: 주사위를 60회 던져서 나온 관측도수가 아래와 같을 때, 이 주사위가 공정한가?

```python
import pandas as pd
import scipy.stats as stats
import matplotlib.pyplot as plt
import numpy as np

# 주사위 데이터
data = [4, 6, 17, 16, 8, 9]  # 관측값 (1,2,3,4,5,6면)
exp = [10, 10, 10, 10, 10, 10]  # 기대값 (60회 ÷ 6 = 10회씩)

print("🎲 주사위 공정성 검정")
print("=" * 30)

# 가설 설정
print("🎯 가설 설정:")
print("- H₀ (귀무가설): 주사위는 공정하다 (기대치와 관찰치가 동일)")
print("- H₁ (대립가설): 주사위는 공정하지 않다 (기대치와 관찰치가 다름)")
print()

# 데이터 정리
dice_df = pd.DataFrame({
    '주사위면': [1, 2, 3, 4, 5, 6],
    '관측도수': data,
    '기대도수': exp
})

print("📊 관측도수 vs 기대도수:")
print(dice_df)
print()

# 카이제곱 검정 실행
result = stats.chisquare(data, exp)
chi2_stat = result[0] 
p_value = result[1]

print("🔢 검정 결과:")
print(f"χ² 통계량: {chi2_stat:.3f}")
print(f"p-value: {p_value:.6f}")

# 결론 도출
alpha = 0.05
print(f"\n🎯 결론 (α = {alpha}):")
if p_value < alpha:
    print("✅ H₀ 기각: 주사위는 공정하지 않다!")
    print("📊 관측값은 우연히 발생한 것이 아니라, 어떠한 원인에 의해 발생한 값이다.")
else:
    print("❌ H₀ 채택: 주사위는 공정하다!")
```

**출력 결과**:
```
χ² 통계량: 14.200
p-value: 0.014388

🎯 결론: p-value(0.014) < 0.05 → 귀무가설 기각
✅ 주사위는 게임에 적합하지 않다!
```

### 🥤 예제 2: 스포츠 음료 선호도 검정

```python
# 5개 스포츠 음료 선호도 데이터 로드
sports_drinks = pd.read_csv('https://raw.githubusercontent.com/pykwon/python/refs/heads/master/testdata_utf8/drinkdata.csv')
print("🥤 스포츠 음료 선호도 데이터:")
print(sports_drinks)

# 일원 카이제곱 검정 (균등 선호 검정)
result = stats.chisquare(sports_drinks['관측도수'])
print(f"\n🔢 검정 결과:")
print(f"χ² 통계량: {result[0]:.3f}")
print(f"p-value: {result[1]:.6f}")

# 결론
if result[1] < 0.05:
    print("✅ H₀ 기각: 음료별 선호도에 차이가 있다!")
else:
    print("❌ H₀ 채택: 모든 음료의 선호도가 동일하다!")
```

### 📊 시각화: 관측도수 vs 기대도수

```python
# 기대도수 계산
total = sports_drinks['관측도수'].sum()
expected = [total / len(sports_drinks)] * len(sports_drinks)

# 시각화
x = np.arange(len(sports_drinks))
width = 0.35

plt.rc('font', family='Malgun Gothic')
plt.figure(figsize=(10, 6))

plt.bar(x - width/2, sports_drinks['관측도수'], width, 
        label='관측도수', alpha=0.8, color='skyblue')
plt.bar(x + width/2, expected, width, 
        label='기대도수', alpha=0.6, color='orange')

plt.xticks(x, list(sports_drinks['음료종류']))
plt.xlabel("음료 종류")
plt.ylabel("도수")
plt.title("스포츠 음료 선호도: 관측 vs 기대")
plt.legend()
plt.grid(axis='y', linestyle='--', alpha=0.4)
plt.tight_layout()
plt.show()
```

### 🔍 구체적 분석: 어떤 음료가 더 인기 있는가?

```python
# 차이 분석
sports_drinks['기대도수'] = expected
sports_drinks['차이(관측-기대)'] = sports_drinks['관측도수'] - sports_drinks['기대도수']
sports_drinks['차이비율(%)'] = round(sports_drinks['차이(관측-기대)'] / expected[0] * 100, 2)

# 내림차순 정렬 (가장 선호되는 순서)
sports_drinks_sorted = sports_drinks.sort_values(by='차이(관측-기대)', ascending=False)
sports_drinks_sorted.reset_index(drop=True, inplace=True)

print("📊 음료별 선호도 상세 분석:")
print(sports_drinks_sorted[['음료종류', '관측도수', '기대도수', '차이(관측-기대)', '차이비율(%)']])

print(f"\n🥇 가장 선호: {sports_drinks_sorted.iloc[0]['음료종류']}")
print(f"🥉 가장 비선호: {sports_drinks_sorted.iloc[-1]['음료종류']}")
```

---

## 📊 Section 2: 이원 카이제곱 검정 (독립성 검정)

### 🎯 핵심 개념

**이원 카이제곱 검정**은 두 개의 범주형 변수가 서로 **독립적인지 관련이 있는지**를 검정합니다.

```python
# 이원 카이제곱의 핵심 개념
검정_유형 = {
    "독립성_검정": "동일 집단의 두 변인이 관련이 있는가?",
    "동질성_검정": "서로 다른 집단의 특성이 동일한가?",
    "교차분석": "교차분할표를 통한 연관성 분석"
}
```

### 🚬 예제 3: 교육 수준과 흡연율 간의 관련성 분석

```python
# 흡연 데이터 로드 및 분석
data = pd.read_csv("https://raw.githubusercontent.com/pykwon/python/refs/heads/master/testdata_utf8/smoke.csv")
print("🚬 교육수준과 흡연 데이터:")
print(data.head())

print(f"\n📊 교육수준 범주: {data['education'].unique()}")  # [1 2 3]
print(f"📊 흡연수준 범주: {data['smoking'].unique()}")    # [1 2 3]

# 가설 설정
print("\n🎯 가설 설정:")
print("- H₀ (귀무가설): 교육 수준과 흡연율 간에 관련성이 없다 (독립이다)")
print("- H₁ (대립가설): 교육 수준과 흡연율 간에 관련성이 있다 (독립이 아니다)")
```

### 📋 교차분할표 생성

```python
# 교차분할표 생성
ctab = pd.crosstab(index=data['education'], columns=data['smoking'])

# 레이블 설정으로 가독성 향상
ctab.index = pd.Index(["대학원졸", "대졸", "고졸"])
ctab.columns = ["과흡연", "보통", "금연"]

print("\n📋 교육수준별 흡연 인원수 교차분할표:")
print(ctab)

# 행 백분율로 패턴 확인
print("\n📊 행 백분율 (교육수준별 흡연 패턴):")
ctab_pct = pd.crosstab(index=data['education'], columns=data['smoking'], normalize='index') * 100
ctab_pct.index = ["대학원졸", "대졸", "고졸"]
ctab_pct.columns = ["과흡연", "보통", "금연"]
print(ctab_pct.round(1))
```

### 🔢 이원 카이제곱 검정 실행

```python
# 이원 카이제곱 검정
chi2, p, dof, expected = stats.chi2_contingency(ctab)

print("\n🔢 이원 카이제곱 검정 결과:")
print(f"χ² 통계량: {chi2:.3f}")
print(f"p-value: {p:.6f}")
print(f"자유도: {dof}")

print(f"\n📊 기대빈도 행렬:")
expected_df = pd.DataFrame(expected, 
                          index=["대학원졸", "대졸", "고졸"],
                          columns=["과흡연", "보통", "금연"])
print(expected_df.round(1))

# 결론 도출
alpha = 0.05
print(f"\n🎯 결론 (α = {alpha}):")
if p < alpha:
    print("✅ H₀ 기각: 교육 수준과 흡연율 간에 관련성이 있다!")
    print("📊 교육 수준에 따라 흡연 패턴이 다르다.")
else:
    print("❌ H₀ 채택: 교육 수준과 흡연율 간에 관련성이 없다!")
```

### 🥤 예제 4: 성별에 따른 음료 선호도 차이 분석

```python
print("\n🥤 성별에 따른 음료 선호도 차이 분석")
print("=" * 40)

# 가설 설정
print("🎯 가설 설정:")
print("- H₀ (귀무가설): 성별과 음료 선호는 서로 관련이 없다")
print("- H₁ (대립가설): 성별과 음료 선호는 서로 관련이 있다")

# 데이터 생성
beverage_data = pd.DataFrame({
    '게토레이': [30, 20],
    '포카리스웨트': [20, 30], 
    '비타500': [10, 30]
}, index=['남성', '여성'])

print(f"\n📊 성별-음료 교차분할표:")
print(beverage_data)

# 이원 카이제곱 검정
chi2, p, dof, expected = stats.chi2_contingency(beverage_data)

print(f"\n🔢 검정 결과:")
print(f"χ² 통계량: {chi2:.3f}")
print(f"p-value: {p:.6f}")  
print(f"자유도: {dof}")

print(f"\n📊 기대빈도:")
expected_df = pd.DataFrame(expected, 
                          index=['남성', '여성'],
                          columns=['게토레이', '포카리스웨트', '비타500'])
print(expected_df.round(1))

# 결론
if p < 0.05:
    print("✅ H₀ 기각: 성별에 따라 음료 선호도가 다르다!")
else:
    print("❌ H₀ 채택: 성별과 음료 선호도는 관련이 없다!")
```

### 🔥 히트맵으로 패턴 시각화

```python
import seaborn as sns

# 히트맵 시각화
plt.figure(figsize=(8, 5))
plt.rc('font', family='Malgun Gothic')

sns.heatmap(beverage_data, 
           annot=True,           # 값 표시
           fmt='d',              # 정수 형태
           cmap='Blues',         # 색상 맵
           cbar_kws={'label': '선호도수'})

plt.title('성별에 따른 음료 선호도 히트맵')
plt.xlabel('음료 종류')
plt.ylabel('성별')
plt.tight_layout()
plt.show()

# 패턴 해석
print("\n🔍 패턴 분석:")
print("- 남성: 게토레이 선호 경향 (30 vs 20)")
print("- 여성: 비타500 선호 경향 (30 vs 10)")  
print("- 포카리스웨트: 성별 차이 적음")
```

---

## 📊 Section 3: 일원 vs 이원 카이제곱 구분법

### 🎯 언제 어떤 검정을 사용할까?

```python
def 카이제곱_검정_가이드():
    """일원 vs 이원 카이제곱 선택 가이드"""
    
    가이드 = {
        "🔍 데이터 확인": {
            "변수 개수": "몇 개의 범주형 변수가 있는가?",
            "질문 유형": "무엇을 알고 싶은가?"
        },
        
        "📊 일원 카이제곱": {
            "조건": "변수 1개",
            "목적": "적합도/선호도 검정",
            "질문": [
                "이론적 분포와 맞는가?",
                "모든 범주가 동일하게 선호되는가?",
                "공정한가? (동전, 주사위)"
            ],
            "함수": "stats.chisquare(observed, expected)",
            "예시": "주사위 공정성, 색깔 선호도"
        },
        
        "📊 이원 카이제곱": {
            "조건": "변수 2개",
            "목적": "독립성/동질성 검정", 
            "질문": [
                "두 변수가 관련이 있는가?",
                "집단 간 차이가 있는가?"
            ],
            "함수": "stats.chi2_contingency(cross_table)",
            "예시": "성별×선호도, 교육×흡연"
        }
    }
    
    return 가이드

# 선택 흐름도
def 검정_선택_흐름도():
    print("🌊 카이제곱 검정 선택 흐름도")
    print("=" * 30)
    print("1️⃣ 변수가 몇 개인가?")
    print("   ├─ 1개 → 일원 카이제곱")
    print("   └─ 2개 → 이원 카이제곱")
    print()
    print("2️⃣ 무엇을 확인하고 싶은가?")
    print("   ├─ 이론값과의 적합성 → 일원")
    print("   └─ 변수 간 관련성 → 이원")
    print()
    print("3️⃣ 데이터 형태는?")
    print("   ├─ 일차원 빈도표 → 일원")
    print("   └─ 교차분할표 → 이원")

검정_선택_흐름도()
```

---

## 🎯 Section 4: 실무 적용과 해석

### 💡 카이제곱 검정의 한계와 주의사항

```python
def 카이제곱_주의사항():
    """카이제곱 검정 시 주의할 점들"""
    
    주의사항 = {
        "📋 기본 조건": [
            "범주형 데이터여야 함",
            "기대빈도 ≥ 5 (모든 셀)",
            "독립적인 관찰값",
            "충분한 표본 크기"
        ],
        
        "⚠️ 흔한 실수": [
            "연속형 데이터에 직접 적용",
            "기대빈도 < 5인 셀 무시",
            "통계적 유의성 ≠ 실무적 중요성",
            "인과관계와 상관관계 혼동"
        ],
        
        "🔧 해결 방법": [
            "범주 합치기 (의미 있게)",
            "Fisher의 정확검정 사용",
            "효과크기 함께 보고",
            "실무적 의미 해석 병행"
        ]
    }
    
    return 주의사항
```

### 📊 효과크기 측정

```python
# 효과크기 계산 (Cramér's V)
def calculate_cramers_v(chi2, n, min_dim):
    """Cramér's V 효과크기 계산"""
    return np.sqrt(chi2 / (n * (min_dim - 1)))

# 예제: 성별-음료 선호도 효과크기
n = beverage_data.sum().sum()  # 총 표본수
min_dim = min(beverage_data.shape)  # 최소 차원
cramers_v = calculate_cramers_v(chi2, n, min_dim)

print(f"📊 효과크기 (Cramér's V): {cramers_v:.3f}")

# 효과크기 해석
if cramers_v < 0.1:
    effect_interpretation = "무시할 수 있는 효과"
elif cramers_v < 0.3:
    effect_interpretation = "작은 효과"  
elif cramers_v < 0.5:
    effect_interpretation = "중간 효과"
else:
    effect_interpretation = "큰 효과"

print(f"📊 효과크기 해석: {effect_interpretation}")
```

---

## 🎯 Section 5: 종합 정리 및 실무 팁

### 📚 핵심 요약

```python
def 핵심_요약():
    """22.05.05 학습 내용 핵심 요약"""
    
    요약 = {
        "🎯 일원 카이제곱": {
            "용도": "하나의 변수에 대한 적합도/선호도 검정",
            "공식": "χ² = Σ[(O-E)²/E]",
            "자유도": "범주수 - 1",
            "함수": "stats.chisquare(observed, expected)"
        },
        
        "🎯 이원 카이제곱": {
            "용도": "두 변수 간의 독립성/동질성 검정",
            "공식": "χ² = Σ[(O-E)²/E] (모든 셀에 대해)",
            "자유도": "(행-1) × (열-1)", 
            "함수": "stats.chi2_contingency(cross_table)"
        },
        
        "💡 실무 포인트": [
            "변수 개수로 일원/이원 구분",
            "기대빈도 조건 확인 필수",
            "p-value와 효과크기 함께 해석",
            "교차분할표로 패턴 파악",
            "시각화로 직관적 이해"
        ]
    }
    
    return 요약

# 다음 학습 연결점
def 다음_학습_가이드():
    print("🔗 다음 학습 연결점")
    print("=" * 20)
    print("✅ 완료: 일원/이원 카이제곱 기초")
    print("🎯 다음: 3원 이상 다차원 분석")  
    print("🎯 향후: 로지스틱 회귀와의 연결")
    print("🎯 고급: 베이지안 카이제곱")
```

### 🚀 실무 활용 팁

1. **데이터 전처리**: 범주형 변수 정리, 결측치 처리
2. **조건 확인**: 기대빈도 ≥ 5, 독립성 가정
3. **결과 해석**: 통계적 + 실무적 의미 모두 고려  
4. **시각화**: 교차표, 히트맵, 막대그래프 활용
5. **보고**: 효과크기와 함께 종합적 해석

---

## 🎉 학습 완료!

### ✅ 22.05.05에서 마스터한 내용

- **일원 카이제곱**: 주사위, 음료 선호도 검정
- **이원 카이제곱**: 교육-흡연, 성별-음료 관련성 분석  
- **실무 적용**: 데이터 분석부터 시각화까지
- **Python 활용**: scipy.stats, pandas, matplotlib, seaborn

**🎯 이제 일원과 이원 카이제곱 검정을 실무에서 자유자재로 활용할 수 있습니다!**

**다음 단계**: 더 복잡한 다차원 분석과 다른 통계 기법들과의 연결 학습