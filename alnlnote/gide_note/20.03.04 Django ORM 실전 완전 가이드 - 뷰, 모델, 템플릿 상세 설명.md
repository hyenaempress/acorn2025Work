# 20.03.04 Django ORM ì‹¤ì „ ì™„ì „ ê°€ì´ë“œ - ë·°, ëª¨ë¸, í…œí”Œë¦¿ ìƒì„¸ ì„¤ëª…

> ì´ ë¬¸ì„œëŠ” **20.03.03 Django ORM ì‚¬ìš© ê´€ë ¨ ì™„ì „ ê°€ì´ë“œ**ì— ì´ì–´ì§€ëŠ” ì‹¤ì „ êµ¬í˜„ ê°€ì´ë“œì…ë‹ˆë‹¤.

## ëª©ì°¨
1. [ì‹¤ìŠµ ë¬¸ì œ ë° ìš”êµ¬ì‚¬í•­](#ì‹¤ìŠµ-ë¬¸ì œ-ë°-ìš”êµ¬ì‚¬í•­)
2. [ëª¨ë¸ ì„¤ì • ìƒì„¸ ë¶„ì„](#ëª¨ë¸-ì„¤ì •-ìƒì„¸-ë¶„ì„)
3. [ORM ë·° í•¨ìˆ˜ ì™„ì „ ë¶„ì„](#orm-ë·°-í•¨ìˆ˜-ì™„ì „-ë¶„ì„)
4. [í…œí”Œë¦¿ êµ¬ì„± ë° í™œìš©](#í…œí”Œë¦¿-êµ¬ì„±-ë°-í™œìš©)
5. [URL ì„¤ì • ë° ë¼ìš°íŒ…](#url-ì„¤ì •-ë°-ë¼ìš°íŒ…)
6. [ì‹¤í–‰ ê²°ê³¼ ë° ë””ë²„ê¹…](#ì‹¤í–‰-ê²°ê³¼-ë°-ë””ë²„ê¹…)
7. [ì„±ëŠ¥ ìµœì í™” ì¶”ê°€ íŒ](#ì„±ëŠ¥-ìµœì í™”-ì¶”ê°€-íŒ)

---

## ì‹¤ìŠµ ë¬¸ì œ ë° ìš”êµ¬ì‚¬í•­

### ğŸ¯ í•µì‹¬ ê³¼ì œ
ê°•ì‚¬ë‹˜ì´ ì œì‹œí•œ 4ê°€ì§€ ë¶„ì„ ìš”êµ¬ì‚¬í•­:

1. **ì‚¬ë²ˆ, ì§ì›ëª…, ë¶€ì„œëª…, ì§ê¸‰, ì—°ë´‰, ê·¼ë¬´ë…„ìˆ˜**ë¥¼ DataFrameì— ê¸°ì–µ í›„ ì¶œë ¥í•˜ì‹œì˜¤. (join)
   - **ì •ë ¬**: ë¶€ì„œë²ˆí˜¸, ì§ì›ëª… ìˆœìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
2. **ë¶€ì„œëª…, ì§ê¸‰** ìë£Œë¥¼ ì´ìš©í•˜ì—¬ ê°ê° **ì—°ë´‰í•©, ì—°ë´‰í‰ê· **ì„ êµ¬í•˜ì‹œì˜¤.
3. **ë¶€ì„œëª…ë³„** ì—°ë´‰í•©, í‰ê· ì„ ì´ìš©í•˜ì—¬ ì„¸ë¡œë§‰ëŒ€ ê·¸ë˜í”„ë¥¼ ì¶œë ¥í•˜ì‹œì˜¤.
4. **ì„±ë³„, ì§ê¸‰ë³„** ë¹ˆë„í‘œë¥¼ ì¶œë ¥í•˜ì‹œì˜¤.

### ğŸ“‹ êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [x] Django ORMì„ ì‚¬ìš©í•œ ì¡°ì¸ ì¿¼ë¦¬
- [x] DataFrameì„ í™œìš©í•œ ë°ì´í„° ì§‘ê³„
- [x] ê·¼ë¬´ë…„ìˆ˜ ê³„ì‚° ë¡œì§
- [x] ë¶€ì„œëª… ê²€ìƒ‰ í•„í„°ë§
- [x] HTML í…œí”Œë¦¿ì— ê²°ê³¼ ì¶œë ¥
- [x] ì•ˆì „í•œ ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬

---

## ëª¨ë¸ ì„¤ì • ìƒì„¸ ë¶„ì„

### ğŸ—ï¸ ëª¨ë¸ êµ¬ì¡° (myapp/models.py)

#### ğŸ“‹ inspectdb ì›ë³¸ (aa.py)ì—ì„œ ë³µì‚¬í•œ í›„ ìˆ˜ì •ëœ ìµœì¢… ëª¨ë¸

```python
from django.db import models

# ---- ê¸°ë³¸ í…Œì´ë¸”ë“¤ ----

class Buser(models.Model):
    """ë¶€ì„œ í…Œì´ë¸”"""
    buserno = models.IntegerField(primary_key=True)          # ë¶€ì„œë²ˆí˜¸ (PK)
    busername = models.CharField(max_length=10)              # ë¶€ì„œëª…
    buserloc = models.CharField(max_length=10, blank=True, null=True)  # ë¶€ì„œìœ„ì¹˜
    busertel = models.CharField(max_length=15, blank=True, null=True)  # ë¶€ì„œì „í™”
    
    class Meta:
        managed = True    # âœ… False â†’ Trueë¡œ ë³€ê²½ (Djangoê°€ í…Œì´ë¸” ê´€ë¦¬)
        db_table = 'buser'
    
    def __str__(self):
        return self.busername

class Jikwon(models.Model):
    """ì§ì› í…Œì´ë¸”"""
    jikwonno = models.IntegerField(primary_key=True)         # ì§ì›ë²ˆí˜¸ (PK)
    jikwonname = models.CharField(max_length=10)             # ì§ì›ëª…
    
    # ğŸ”¥ í•µì‹¬ ìˆ˜ì •: IntegerField â†’ ForeignKeyë¡œ ë³€ê²½
    # âŒ ì›ë³¸: busernum = models.IntegerField()
    # âœ… ìˆ˜ì •: ê´€ê³„ ì„¤ì •
    busernum = models.ForeignKey(
        Buser,                                               # ì°¸ì¡° ëª¨ë¸
        on_delete=models.PROTECT,                           # ì‚­ì œ ì •ì±… (CASCADEë„ ê°€ëŠ¥)
        db_column='busernum'                                # ì‹¤ì œ DB ì»¬ëŸ¼ëª…
    )
    
    jikwonjik = models.CharField(max_length=10, blank=True, null=True)    # ì§ê¸‰
    jikwonpay = models.IntegerField(blank=True, null=True)               # ì—°ë´‰
    jikwonibsail = models.DateField(blank=True, null=True)               # ì…ì‚¬ì¼
    jikwongen = models.CharField(max_length=4, blank=True, null=True)     # ì„±ë³„
    jikwonrating = models.CharField(max_length=3, blank=True, null=True)  # í‰ì 
    
    class Meta:
        managed = True    # âœ… False â†’ Trueë¡œ ë³€ê²½
        db_table = 'jikwon'
    
    def __str__(self):
        return f"{self.jikwonname}({self.jikwonno})"

class Gogek(models.Model):
    """ê³ ê° í…Œì´ë¸”"""
    gogekno = models.IntegerField(primary_key=True)
    gogekname = models.CharField(max_length=10)
    gogektel = models.CharField(max_length=20, blank=True, null=True)
    gogekjumin = models.CharField(max_length=14, blank=True, null=True)
    
    # âœ… ì´ë¯¸ ForeignKeyë¡œ ìƒì„±ë¨ (inspectdbê°€ ìë™ ê°ì§€)
    gogekdamsano = models.ForeignKey(
        Jikwon,
        on_delete=models.PROTECT,                           # âœ… DO_NOTHING â†’ PROTECTë¡œ ë³€ê²½ ê¶Œì¥
        db_column='gogekdamsano',
        blank=True,
        null=True
    )
    
    class Meta:
        managed = True    # âœ… False â†’ Trueë¡œ ë³€ê²½
        db_table = 'gogek'

class Board(models.Model):
    """ê²Œì‹œíŒ í…Œì´ë¸”"""
    num = models.IntegerField(primary_key=True)
    author = models.CharField(max_length=10, blank=True, null=True)
    title = models.CharField(max_length=50, blank=True, null=True)
    content = models.CharField(max_length=4000, blank=True, null=True)
    bwrite = models.DateField(blank=True, null=True)
    readcnt = models.IntegerField(blank=True, null=True)
    
    class Meta:
        managed = True    # âœ… False â†’ Trueë¡œ ë³€ê²½
        db_table = 'board'

class Sangdata(models.Model):
    """ìƒí’ˆ ë°ì´í„° í…Œì´ë¸”"""
    code = models.IntegerField(primary_key=True)
    sang = models.CharField(max_length=20, blank=True, null=True)
    su = models.IntegerField(blank=True, null=True)
    dan = models.IntegerField(blank=True, null=True)
    
    class Meta:
        managed = True    # âœ… False â†’ Trueë¡œ ë³€ê²½
        db_table = 'sangdata'
```

### ğŸ” ìˆ˜ì • ì „í›„ ë¹„êµ (í•µì‹¬ ë³€ê²½ì‚¬í•­)

#### 1. Jikwon ëª¨ë¸ì˜ busernum í•„ë“œ ë³€ê²½
```python
# âŒ inspectdb ì›ë³¸
class Jikwon(models.Model):
    busernum = models.IntegerField()  # ë‹¨ìˆœ ì •ìˆ˜ í•„ë“œ
    
    class Meta:
        managed = False  # Djangoê°€ ê´€ë¦¬ ì•ˆí•¨

# âœ… ORM í™œìš©ì„ ìœ„í•œ ìˆ˜ì •
class Jikwon(models.Model):
    busernum = models.ForeignKey(
        Buser,
        on_delete=models.PROTECT,  # ë˜ëŠ” CASCADE
        db_column='busernum'
    )
    
    class Meta:
        managed = True   # Djangoê°€ ê´€ë¦¬í•¨
```

#### 2. ëª¨ë“  ëª¨ë¸ì˜ managed ì„¤ì • ë³€ê²½
```python
# âŒ inspectdb ì›ë³¸ (ëª¨ë“  ëª¨ë¸)
class Meta:
    managed = False  # ì½ê¸° ì „ìš©

# âœ… ORM í™œìš©ì„ ìœ„í•œ ìˆ˜ì • (ëª¨ë“  ëª¨ë¸)
class Meta:
    managed = True   # ì™„ì „í•œ ORM ê¸°ëŠ¥ ì‚¬ìš©
```

### ğŸ” ëª¨ë¸ ê´€ê³„ ì„¤ì • í•µì‹¬ í¬ì¸íŠ¸

#### 1. `managed = False â†’ True` ë³€ê²½ì˜ ì˜ë¯¸
```python
class Meta:
    managed = False  # âŒ inspectdb ê¸°ë³¸ê°’
    managed = True   # âœ… ORM ì™„ì „ í™œìš©ì„ ìœ„í•œ ìˆ˜ì •
```

**ë³€ê²½ ì´ìœ ì™€ íš¨ê³¼:**
- **`managed = False`**: 
  - Djangoê°€ í…Œì´ë¸”ì„ ì½ê¸°ë§Œ í•¨ (ì•ˆì „í•˜ì§€ë§Œ ì œí•œì )
  - ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ í…Œì´ë¸” êµ¬ì¡° ë³€ê²½ ë¶ˆê°€
  - ORMì˜ ì¼ë¶€ ê¸°ëŠ¥ ì œí•œ
  
- **`managed = True`**:
  - Djangoê°€ í…Œì´ë¸”ì„ ì™„ì „íˆ ê´€ë¦¬
  - ë§ˆì´ê·¸ë ˆì´ì…˜ìœ¼ë¡œ êµ¬ì¡° ë³€ê²½ ê°€ëŠ¥
  - ëª¨ë“  ORM ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥
  - **âš ï¸ ì£¼ì˜**: ê¸°ì¡´ ë°ì´í„°ì™€ ì¶©ëŒ ê°€ëŠ¥ì„±

#### 2. `IntegerField() â†’ ForeignKey()` ë³€ê²½ì˜ í•µì‹¬
```python
# âŒ inspectdb ì›ë³¸ (ê´€ê³„ ì¸ì‹ ëª»í•¨)
busernum = models.IntegerField()  # ë‹¨ìˆœ ìˆ«ìë¡œ ì¸ì‹

# âœ… ORM ê´€ê³„ í™œìš©ì„ ìœ„í•œ ìˆ˜ì •
busernum = models.ForeignKey(
    Buser,                    # ì°¸ì¡°í•  ëª¨ë¸ í´ë˜ìŠ¤
    on_delete=models.PROTECT, # ì‚­ì œ ì •ì±…
    db_column='busernum'      # ì‹¤ì œ DB ì»¬ëŸ¼ëª…
)
```

**ë³€ê²½ ì´ìœ :**
- inspectdbëŠ” ì™¸ë˜í‚¤ë¥¼ ìë™ìœ¼ë¡œ ê°ì§€í•˜ì§€ ëª»í•˜ëŠ” ê²½ìš°ê°€ ë§ìŒ
- IntegerFieldë¡œ ë‚¨ê²¨ë‘ë©´ ORMì˜ ê´€ê³„ ê¸°ëŠ¥ ì‚¬ìš© ë¶ˆê°€
- `jikwon.busernum.busername` ê°™ì€ ê´€ê³„ ì ‘ê·¼ ë¶ˆê°€ëŠ¥

**ForeignKey ì„¤ì • ì‹œ í•µì‹¬ ì˜µì…˜:**
```python
busernum = models.ForeignKey(
    'Buser',                     # ì°¸ì¡° ëª¨ë¸ (ë¬¸ìì—´ë¡œë„ ê°€ëŠ¥)
    on_delete=models.PROTECT,    # âœ… ê¶Œì¥: ì•ˆì „í•œ ì‚­ì œ ì •ì±…
    db_column='busernum',        # ì‹¤ì œ DB ì»¬ëŸ¼ëª… (ìƒëµ ê°€ëŠ¥)
    related_name='employees'     # ì—­ì°¸ì¡° ì´ë¦„ (ì„ íƒì‚¬í•­)
)
```

**ì‚­ì œ ì •ì±… ì˜µì…˜**:
- `CASCADE`: ë¶€ëª¨ ì‚­ì œ ì‹œ ìì‹ë„ ì‚­ì œ
- `PROTECT`: ìì‹ì´ ìˆìœ¼ë©´ ë¶€ëª¨ ì‚­ì œ ë¶ˆê°€
- `SET_NULL`: ë¶€ëª¨ ì‚­ì œ ì‹œ ìì‹ì˜ ì™¸ë˜í‚¤ë¥¼ NULLë¡œ ì„¤ì •
- `DO_NOTHING`: ì•„ë¬´ ì‘ì—… ì•ˆí•¨ (DB ì œì•½ì¡°ê±´ì— ì˜ì¡´)

---

## ORM ë·° í•¨ìˆ˜ ì™„ì „ ë¶„ì„

### ğŸ¯ ormAnalysisFunc ë·° í•¨ìˆ˜ ìƒì„¸ ë¶„ì„

```python
from django.shortcuts import render
from django.db import connection
from .models import Jikwon  # ë˜ëŠ”: from myapp.models import Jikwon
import pandas as pd
from django.utils.html import escape
from datetime import date

def ormAnalysisFunc(request):
    """ORMì„ ì‚¬ìš©í•œ ì§ì› ì •ë³´ ì¡°íšŒ ë° ë¶„ì„"""
    
    # ==========================================
    # 1. ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬ ë° ë³´ì•ˆ
    # ==========================================
    dept = (request.GET.get('dept') or "").strip()
    
    # ==========================================
    # 2. ORM ì¿¼ë¦¬: ì¡°ì¸ + í•„í„° + ì •ë ¬
    # ==========================================
    
    # ê¸°ë³¸ ì¿¼ë¦¬ì…‹ ìƒì„± (select_relatedë¡œ JOIN ìµœì í™”)
    qs = (
        Jikwon.objects
        .select_related('busernum')  # INNER JOIN buser í…Œì´ë¸”
    )
    
    # ë¶€ì„œëª… í•„í„°ë§ (ì‚¬ìš©ì ì…ë ¥ì´ ìˆëŠ” ê²½ìš°)
    if dept:
        qs = qs.filter(busernum__busername__icontains=dept)
        # SQL: WHERE buser.busername LIKE '%dept%'
    
    # ì •ë ¬: "ë¶€ì„œë²ˆí˜¸, ì§ì›ëª… ì˜¤ë¦„ì°¨ìˆœ"
    qs = qs.order_by('busernum__buserno', 'jikwonname')
    # SQL: ORDER BY buser.buserno, jikwon.jikwonname
    
    # ==========================================
    # 3. ë°ì´í„° ì¶”ì¶œ ë° DataFrame ë³€í™˜
    # ==========================================
    
    # values()ë¡œ í•„ìš”í•œ í•„ë“œë§Œ ì¶”ì¶œ
    rows = qs.values(
        'jikwonno',               # ì§ì›ë²ˆí˜¸
        'jikwonname',             # ì§ì›ëª…
        'busernum__busername',    # ë¶€ì„œëª… (JOINì„ í†µí•´ ì ‘ê·¼)
        'busernum__busertel',     # ë¶€ì„œì „í™”
        'jikwonjik',              # ì§ê¸‰
        'jikwonpay',              # ì—°ë´‰
        'jikwongen',              # ì„±ë³„
        'jikwonibsail',           # ì…ì‚¬ì¼(ê·¼ë¬´ë…„ìˆ˜ ê³„ì‚°ìš©)
    )
    
    # DataFrameìœ¼ë¡œ ë³€í™˜
    df = pd.DataFrame(list(rows))
    
    # ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ì²˜ë¦¬
    if df.empty:
        empty_html = "<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>"
        ctx = {
            'dept': escape(dept),
            'join_html': empty_html,
            'dept_pos_pay_html': empty_html,
            'dept_pay_html': empty_html,
            'gender_pos_freq_html': empty_html,
        }
        return render(request, 'orm_analysis.html', ctx)
    
    # ==========================================
    # 4. ì»¬ëŸ¼ëª… í•œê¸€í™”
    # ==========================================
    df = df.rename(columns={
        'jikwonno': 'ì§ì›ë²ˆí˜¸',
        'jikwonname': 'ì§ì›ëª…',
        'busernum__busername': 'ë¶€ì„œëª…',
        'busernum__busertel': 'ë¶€ì„œì „í™”',
        'jikwonjik': 'ì§ê¸‰',
        'jikwonpay': 'ì—°ë´‰',
        'jikwongen': 'ì„±ë³„',
        'jikwonibsail': 'ì…ì‚¬ì¼',
    })
    
    # ==========================================
    # 5. ê·¼ë¬´ë…„ìˆ˜ ê³„ì‚° (ì¤‘ìš”!)
    # ==========================================
    today = date.today()
    
    def years_of_service(d):
        """ì…ì‚¬ì¼ì„ ê¸°ì¤€ìœ¼ë¡œ ê·¼ë¬´ë…„ìˆ˜ ê³„ì‚°"""
        try:
            if pd.isna(d):
                return None
            # ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
            dt = pd.to_datetime(d).date()
            years = today.year - dt.year - ((today.month, today.day) < (dt.month, dt.day))
            return max(years, 0)  # ìŒìˆ˜ ë°©ì§€
        except Exception:
            return None
    
    df['ê·¼ë¬´ë…„ìˆ˜'] = df['ì…ì‚¬ì¼'].apply(years_of_service)
    
    # NaN/None ê°’ ì •ë¦¬ (í‘œì‹œìš©)
    df_display = df[['ì§ì›ë²ˆí˜¸', 'ì§ì›ëª…', 'ë¶€ì„œëª…', 'ë¶€ì„œì „í™”', 'ì§ê¸‰', 'ì—°ë´‰', 'ê·¼ë¬´ë…„ìˆ˜']].fillna('')
    
    # ==========================================
    # 6. ë¶„ì„ ê²°ê³¼ ìƒì„±
    # ==========================================
    
    # (1) ì§ì› ê¸°ë³¸ ì¡°ì¸ ê²°ê³¼ í‘œ
    join_html = df_display.to_html(index=False, classes='table table-striped')
    
    # (2) ë¶€ì„œëª…, ì§ê¸‰ ê¸°ì¤€ ì—°ë´‰ í•©/í‰ê· 
    dept_pos = (
        df.groupby(['ë¶€ì„œëª…', 'ì§ê¸‰'], dropna=False)['ì—°ë´‰']
          .agg(['sum', 'mean'])
          .reset_index()
    )
    dept_pos_pay_html = dept_pos.fillna(0).to_html(index=False, classes='table table-striped')
    
    # (3) ë¶€ì„œëª…ë³„ ì—°ë´‰ í•©/í‰ê· 
    dept_pay = (
        df.groupby(['ë¶€ì„œëª…'], dropna=False)['ì—°ë´‰']
          .agg(['sum', 'mean'])
          .reset_index()
    )
    dept_pay_html = dept_pay.fillna(0).to_html(index=False, classes='table table-striped')
    
    # (4) ì„±ë³„, ì§ê¸‰ë³„ ë¹ˆë„í‘œ (count)
    gender_pos = (
        df.groupby(['ì„±ë³„', 'ì§ê¸‰'], dropna=False)['ì§ì›ë²ˆí˜¸']
          .agg(['count'])
          .reset_index()
          .rename(columns={'count': 'ì¸ì›ìˆ˜'})
    )
    gender_pos_freq_html = gender_pos.fillna(0).to_html(index=False, classes='table table-striped')
    
    # ==========================================
    # 7. í…œí”Œë¦¿ ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„
    # ==========================================
    ctx = {
        'dept': escape(dept),                                 # XSS ë°©ì§€
        'join_html': join_html,                              # (1) ì§ì› ëª©ë¡
        'dept_pos_pay_html': dept_pos_pay_html,              # (2) ë¶€ì„œÂ·ì§ê¸‰ë³„ ì—°ë´‰ í†µê³„
        'dept_pay_html': dept_pay_html,                      # (3) ë¶€ì„œë³„ ì—°ë´‰ í†µê³„
        'gender_pos_freq_html': gender_pos_freq_html,        # (4) ì„±ë³„Â·ì§ê¸‰ë³„ ì¸ì›ìˆ˜
    }
    
    return render(request, 'orm_analysis.html', ctx)
```

### ğŸ” í•µì‹¬ ORM ê¸°ë²• ë¶„ì„

#### 1. `select_related()` - JOIN ìµœì í™”
```python
Jikwon.objects.select_related('busernum')
```
- **ì—­í• **: SQLì˜ INNER JOINê³¼ ë™ì¼
- **ì¥ì **: N+1 ì¿¼ë¦¬ ë¬¸ì œ í•´ê²° (í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ ê´€ë ¨ ë°ì´í„°ê¹Œì§€ ê°€ì ¸ì˜´)
- **ìƒì„±ë˜ëŠ” SQL**:
```sql
SELECT jikwon.*, buser.*
FROM jikwon 
INNER JOIN buser ON jikwon.busernum = buser.buserno
```

#### 2. ê´€ê³„ í•„ë“œ ì ‘ê·¼ - `__` êµ¬ë¬¸
```python
qs.filter(busernum__busername__icontains=dept)
qs.order_by('busernum__buserno', 'jikwonname')
```
- **ì˜ë¯¸**: ê´€ë ¨ í…Œì´ë¸”ì˜ í•„ë“œì— ì ‘ê·¼
- `busernum__busername`: Jikwon â†’ Buser â†’ busername
- `__icontains`: ëŒ€ì†Œë¬¸ì ë¬´ì‹œ ë¶€ë¶„ ê²€ìƒ‰ (LIKE '%value%')

#### 3. `values()` - í•„ìš”í•œ í•„ë“œë§Œ ì„ íƒ
```python
qs.values('jikwonno', 'jikwonname', 'busernum__busername')
```
- **ì—­í• **: SQLì˜ SELECT ì ˆê³¼ ë™ì¼
- **ì¥ì **: ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±, ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ê°ì†Œ
- **ë°˜í™˜**: QuerySet[dict] í˜•íƒœ

### ğŸ”§ DataFrame í™œìš© íŒ¨í„´

#### 1. ì•ˆì „í•œ DataFrame ë³€í™˜
```python
df = pd.DataFrame(list(rows))
if df.empty:
    # ë¹ˆ ë°ì´í„° ì²˜ë¦¬
    return render(request, template, empty_context)
```

#### 2. ê·¼ë¬´ë…„ìˆ˜ ê³„ì‚° ë¡œì§
```python
def years_of_service(d):
    try:
        if pd.isna(d):
            return None
        dt = pd.to_datetime(d).date()
        years = today.year - dt.year - ((today.month, today.day) < (dt.month, dt.day))
        return max(years, 0)
    except Exception:
        return None
```
- **í•µì‹¬**: ìƒì¼ì´ ì§€ë‚¬ëŠ”ì§€ í™•ì¸í•˜ì—¬ ì •í™•í•œ ë§Œ ë‚˜ì´ ê³„ì‚°
- **ì˜ˆì™¸ ì²˜ë¦¬**: ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹ì´ë‚˜ NULL ê°’ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬

#### 3. ê·¸ë£¹ë³„ ì§‘ê³„
```python
# ë¶€ì„œëª…, ì§ê¸‰ ê¸°ì¤€ ì—°ë´‰ ì§‘ê³„
dept_pos = (
    df.groupby(['ë¶€ì„œëª…', 'ì§ê¸‰'], dropna=False)['ì—°ë´‰']
      .agg(['sum', 'mean'])
      .reset_index()
)
```
- `dropna=False`: NULL ê°’ë„ ê·¸ë£¹ì— í¬í•¨
- `agg(['sum', 'mean'])`: ì—¬ëŸ¬ ì§‘ê³„ í•¨ìˆ˜ ë™ì‹œ ì ìš©
- `reset_index()`: ë©€í‹°ì¸ë±ìŠ¤ë¥¼ ì¼ë°˜ ì»¬ëŸ¼ìœ¼ë¡œ ë³€í™˜

---

## í…œí”Œë¦¿ êµ¬ì„± ë° í™œìš©

### ğŸ¨ orm_analysis.html í…œí”Œë¦¿

```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ORM ë¶„ì„ í˜ì´ì§€</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .search-form {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .search-form input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .search-form button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .search-form button:hover {
            background: #0056b3;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h3 {
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .table th,
        .table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .navigation {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .navigation a {
            display: inline-block;
            margin: 0 10px;
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        
        .navigation a:hover {
            background: #545b62;
        }
        
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ Django ORM ì§ì› ë¶„ì„ ì‹œìŠ¤í…œ</h1>
            <p>ì‹¤ë¬´ì—ì„œ í™œìš©í•˜ëŠ” ORM íŒ¨í„´ê³¼ ë°ì´í„° ë¶„ì„</p>
        </div>

        <!-- ê²€ìƒ‰ í¼ -->
        <div class="search-form">
            <form method="get" action="/orm_analysis/">
                <label for="dept"><strong>ë¶€ì„œëª… ê²€ìƒ‰:</strong></label>
                <input type="text" id="dept" name="dept" value="{{ dept }}" 
                       placeholder="ë¶€ì„œëª… ì…ë ¥ (ì˜ˆ: ì´ë¬´ë¶€, ì˜ì—…ë¶€)">
                <button type="submit">ğŸ” ì¡°íšŒ</button>
            </form>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="navigation">
            <a href="/orm_analysis/">ğŸ“‹ ì „ì²´ ìë£Œ</a>
            <a href="/dbshow/">âš¡ Raw SQL ë²„ì „</a>
            <a href="/">ğŸ  ë©”ì¸ í˜ì´ì§€</a>
        </div>

        <!-- í˜„ì¬ ê²€ìƒ‰ ì¡°ê±´ í‘œì‹œ -->
        {% if dept %}
        <div class="info-box">
            <strong>ğŸ” í˜„ì¬ ê²€ìƒ‰ ì¡°ê±´:</strong> ë¶€ì„œëª…ì— "{{ dept }}" í¬í•¨
        </div>
        {% endif %}

        <!-- 1. ì§ì› ëª©ë¡ -->
        <div class="section">
            <h3>â‘  ì§ì› ê¸°ë³¸ ì •ë³´ (JOIN ê²°ê³¼)</h3>
            <div>{{ join_html|safe }}</div>
        </div>

        <!-- 2. ë¶€ì„œÂ·ì§ê¸‰ë³„ ì—°ë´‰ í†µê³„ -->
        <div class="section">
            <h3>â‘¡ ë¶€ì„œÂ·ì§ê¸‰ë³„ ì—°ë´‰ í•©ê³„/í‰ê· </h3>
            <div>{{ dept_pos_pay_html|safe }}</div>
        </div>

        <!-- 3. ë¶€ì„œë³„ ì—°ë´‰ í†µê³„ -->
        <div class="section">
            <h3>â‘¢ ë¶€ì„œë³„ ì—°ë´‰ í•©ê³„/í‰ê· </h3>
            <div>{{ dept_pay_html|safe }}</div>
        </div>

        <!-- 4. ì„±ë³„Â·ì§ê¸‰ë³„ ì¸ì›ìˆ˜ -->
        <div class="section">
            <h3>â‘£ ì„±ë³„Â·ì§ê¸‰ë³„ ì¸ì›ìˆ˜ ë¶„í¬</h3>
            <div>{{ gender_pos_freq_html|safe }}</div>
        </div>

        <!-- ê°•ì‚¬ë‹˜ ì¡°ì–¸ -->
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-top: 30px;">
            <h4>ğŸ’¡ ê°•ì‚¬ë‹˜ì˜ ì‹¤ë¬´ ì¡°ì–¸</h4>
            <blockquote style="font-style: italic; color: #856404;">
                "ì¥ê³  ORMì„ ì¨ë„ ë˜ê³  ê·¸ëƒ¥ Raw SQL ë¬¸ì¥ì„ ì¨ë„ ê´œì°®ì•„ìš”. í¸í•œ ê±¸ë¡œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤."<br>
                "íŒ¨í„´ì„ ì½ì–´ì•¼ ë¼ìš”. ëª…ë ¹ì„ ì™¸ìš°ë¼ëŠ” ì–˜ê¸°ê°€ ì•„ë‹ˆì•¼ íŒ¨í„´ì„ ì½ìœ¼ì„¸ìš”."
            </blockquote>
        </div>
    </div>
</body>
</html>
```

### ğŸ¯ í…œí”Œë¦¿ í•µì‹¬ ê¸°ë²•

#### 1. Django í…œí”Œë¦¿ íƒœê·¸ í™œìš©
```html
{% if dept %}
    <div class="info-box">í˜„ì¬ ê²€ìƒ‰: {{ dept }}</div>
{% endif %}
```
- **ì¡°ê±´ë¶€ ë Œë”ë§**: ì‚¬ìš©ìê°€ ê²€ìƒ‰í–ˆì„ ë•Œë§Œ ì •ë³´ í‘œì‹œ

#### 2. ì•ˆì „í•œ HTML ì¶œë ¥
```html
{{ join_html|safe }}
```
- **`|safe` í•„í„°**: DataFrameì˜ `to_html()` ê²°ê³¼ë¥¼ ì•ˆì „í•˜ê²Œ ì¶œë ¥
- **ì£¼ì˜**: XSS ìœ„í—˜ì´ ìˆìœ¼ë¯€ë¡œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë°ì´í„°ì—ë§Œ ì‚¬ìš©

#### 3. ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ë§
```css
.table tr:nth-child(even) {
    background-color: #f2f2f2;
}
```
- **ì–¼ë£©ë§ íš¨ê³¼**: ê°€ë…ì„± í–¥ìƒì„ ìœ„í•œ êµëŒ€ë¡œ ë°°ê²½ìƒ‰ ì ìš©

---

## URL ì„¤ì • ë° ë¼ìš°íŒ…

### ğŸ›£ï¸ mainapp/urls.py

```python
from django.contrib import admin
from django.urls import path
from myapp import views

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', views.indexFunc, name='index'),                    # ë©”ì¸ í˜ì´ì§€
    path('dbshow/', views.dbshowFunc, name='dbshow'),           # Raw SQL ë²„ì „
    path('orm_analysis/', views.ormAnalysisFunc, name='orm_analysis'),  # ORM ë²„ì „
]
```

### ğŸ” URL íŒ¨í„´ ì„¤ëª…

1. **`path('orm_analysis/', ...)`**
   - **ìš”ì²­ URL**: `http://localhost:8000/orm_analysis/`
   - **GET íŒŒë¼ë¯¸í„°**: `?dept=ì´ë¬´ë¶€`
   - **ìµœì¢… URL**: `http://localhost:8000/orm_analysis/?dept=ì´ë¬´ë¶€`

2. **name ì†ì„± í™œìš©**
```html
<!-- í…œí”Œë¦¿ì—ì„œ URL ì—­ì°¸ì¡° -->
<a href="{% url 'orm_analysis' %}">ORM ë¶„ì„</a>
```

3. **GET íŒŒë¼ë¯¸í„° ì²˜ë¦¬**
```python
# ë·°ì—ì„œ GET íŒŒë¼ë¯¸í„° ë°›ê¸°
dept = request.GET.get('dept', '')  # ê¸°ë³¸ê°’: ë¹ˆ ë¬¸ìì—´
```

---

## ì‹¤í–‰ ê²°ê³¼ ë° ë””ë²„ê¹…

### ğŸ–¥ï¸ ì˜ˆìƒ ì‹¤í–‰ ê²°ê³¼

#### 1. ì „ì²´ ì§ì› ì¡°íšŒ (í•„í„° ì—†ìŒ)
```
â‘  ì§ì› ê¸°ë³¸ ì •ë³´
ì§ì›ë²ˆí˜¸  ì§ì›ëª…  ë¶€ì„œëª…   ë¶€ì„œì „í™”      ì§ê¸‰  ì—°ë´‰      ê·¼ë¬´ë…„ìˆ˜
1        ê¹€ì² ìˆ˜  ì´ë¬´ë¶€   02-1234-5678  ê³¼ì¥  4500000   15
2        ì´ì˜í¬  ì˜ì—…ë¶€   02-2345-6789  ëŒ€ë¦¬  3500000   8
...
```

#### 2. ë¶€ì„œ í•„í„°ë§ ê²°ê³¼ (dept=ì´ë¬´)
```
ğŸ” í˜„ì¬ ê²€ìƒ‰ ì¡°ê±´: ë¶€ì„œëª…ì— "ì´ë¬´" í¬í•¨

â‘  ì§ì› ê¸°ë³¸ ì •ë³´
ì§ì›ë²ˆí˜¸  ì§ì›ëª…  ë¶€ì„œëª…   ì§ê¸‰  ì—°ë´‰      ê·¼ë¬´ë…„ìˆ˜
1        ê¹€ì² ìˆ˜  ì´ë¬´ë¶€   ê³¼ì¥  4500000   15
5        ë°•ë¯¼ìˆ˜  ì´ë¬´ë¶€   ì‚¬ì›  2800000   3
```

#### 3. ì§‘ê³„ ê²°ê³¼
```
â‘¡ ë¶€ì„œÂ·ì§ê¸‰ë³„ ì—°ë´‰ í•©ê³„/í‰ê· 
ë¶€ì„œëª…   ì§ê¸‰   sum        mean
ì´ë¬´ë¶€   ê³¼ì¥   4500000    4500000
ì´ë¬´ë¶€   ì‚¬ì›   2800000    2800000
ì˜ì—…ë¶€   ë¶€ì¥   6000000    6000000
```

### ğŸ› ì£¼ìš” ë””ë²„ê¹… í¬ì¸íŠ¸

#### 1. ëª¨ë¸ ê´€ê³„ ì„¤ì • ì˜¤ë¥˜
```python
# âŒ ì˜ëª»ëœ ì„¤ì •
busernum = models.IntegerField()

# âœ… ì˜¬ë°”ë¥¸ ì„¤ì •
busernum = models.ForeignKey(Buser, on_delete=models.PROTECT, db_column='busernum')
```

#### 2. í…œí”Œë¦¿ ê²½ë¡œ ì˜¤ë¥˜
```python
# settings.pyì—ì„œ í…œí”Œë¦¿ ê²½ë¡œ í™•ì¸
TEMPLATES = [
    {
        'DIRS': [BASE_DIR / 'templates'],  # ì˜¬ë°”ë¥¸ ê²½ë¡œ ì„¤ì •
    },
]
```

#### 3. ë°ì´í„° íƒ€ì… ì˜¤ë¥˜
```python
# ìˆ«ì ì—°ì‚° ì „ íƒ€ì… í™•ì¸
df['ì—°ë´‰'] = pd.to_numeric(df['ì—°ë´‰'], errors='coerce')
```

#### 4. ë‚ ì§œ ê³„ì‚° ì˜¤ë¥˜
```python
# ë‹¤ì–‘í•œ ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬
dt = pd.to_datetime(d).date()  # ì•ˆì „í•œ ë‚ ì§œ ë³€í™˜
```

---

## ì„±ëŠ¥ ìµœì í™” ì¶”ê°€ íŒ

### âš¡ ORM ì¿¼ë¦¬ ìµœì í™”

#### 1. ì¿¼ë¦¬ ê°œìˆ˜ ìµœì†Œí™”
```python
# âŒ N+1 ì¿¼ë¦¬ ë°œìƒ
for jikwon in Jikwon.objects.all():
    print(jikwon.busernum.busername)  # ê° ì§ì›ë§ˆë‹¤ ë¶€ì„œ ì¡°íšŒ

# âœ… í•œ ë²ˆì˜ ì¿¼ë¦¬ë¡œ í•´ê²°
jikwons = Jikwon.objects.select_related('busernum').all()
for jikwon in jikwons:
    print(jikwon.busernum.busername)
```

#### 2. í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ
```python
# âŒ ëª¨ë“  í•„ë“œ ì¡°íšŒ
jikwons = Jikwon.objects.select_related('busernum').all()

# âœ… í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ
jikwons = Jikwon.objects.select_related('busernum').only(
    'jikwonno', 'jikwonname', 'jikwonpay', 
    'busernum__busername'
)
```

#### 3. ì¸ë±ìŠ¤ í™œìš©
```python
# ìì£¼ ê²€ìƒ‰í•˜ëŠ” í•„ë“œì— ì¸ë±ìŠ¤ ì¶”ê°€
class Jikwon(models.Model):
    jikwonname = models.CharField(max_length=10, db_index=True)
    jikwonjik = models.CharField(max_length=10, db_index=True)
```

### ğŸš€ DataFrame ìµœì í™”

#### 1. ë©”ëª¨ë¦¬ íš¨ìœ¨ì  ì²˜ë¦¬
```python
# ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì‹œ
def process_large_dataset(queryset):
    chunk_size = 1000
    for chunk in queryset.iterator(chunk_size=chunk_size):
        df_chunk = pd.DataFrame([chunk])
        # ì²­í¬ ë‹¨ìœ„ë¡œ ì²˜ë¦¬
        yield df_chunk
```

#### 2. ìºì‹± í™œìš©
```python
from django.core.cache import cache

def cached_analysis(dept):
    cache_key = f"analysis_{dept}"
    result = cache.get(cache_key)
    
    if result is None:
        result = perform_analysis(dept)
        cache.set(cache_key, result, 300)  # 5ë¶„ ìºì‹œ
    
    return result
```

### ğŸ”§ í…œí”Œë¦¿ ìµœì í™”

#### 1. CSS/JS íŒŒì¼ ë¶„ë¦¬
```html
<!-- ì™¸ë¶€ CSS íŒŒì¼ ì‚¬ìš© -->
{% load static %}
<link rel="stylesheet" href="{% static 'css/analysis.css' %}">
```

#### 2. í…Œì´ë¸” í˜ì´ì§€ë„¤ì´ì…˜
```python
from django.core.paginator import Paginator

def paginated_view(request):
    employees = Jikwon.objects.select_related('busernum').all()
    paginator = Paginator(employees, 25)  # í˜ì´ì§€ë‹¹ 25ê°œ
    
    page = request.GET.get('page')
    employees_page = paginator.get_page(page)
    
    return render(request, 'template.html', {
        'employees': employees_page
    })
```

---

## ë§ˆë¬´ë¦¬: ì‹¤ë¬´ í™œìš© ì²´í¬ë¦¬ìŠ¤íŠ¸

### âœ… ì™„ë£Œí•´ì•¼ í•  í•­ëª©ë“¤

#### ëª¨ë¸ ì„¤ì •
- [ ] `inspectdb`ë¡œ ê¸°ì¡´ DB êµ¬ì¡° íŒŒì•…
- [ ] `managed = False`ë¡œ ì•ˆì „í•œ ì—°ë™ ì„¤ì •
- [ ] `ForeignKey` ê´€ê³„ ì„¤ì •
- [ ] `on_delete` ì •ì±… ê²°ì •

#### ë·° í•¨ìˆ˜ êµ¬í˜„
- [ ] `select_related()` ë¡œ JOIN ìµœì í™”
- [ ] ì‚¬ìš©ì ì…ë ¥ ê²€ì¦ ë° XSS ë°©ì§€
- [ ] DataFrame í™œìš©í•œ ë°ì´í„° ë¶„ì„
- [ ] ì˜ˆì™¸ ì²˜ë¦¬ ë° ë¹ˆ ë°ì´í„° ëŒ€ì‘

#### í…œí”Œë¦¿ êµ¬ì„±
- [ ] ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ë§
- [ ] ì•ˆì „í•œ HTML ì¶œë ¥ (`|safe`)
- [ ] ì‚¬ìš©ì ì¹œí™”ì  UI/UX

#### ì„±ëŠ¥ ìµœì í™”
- [ ] í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ
- [ ] ì ì ˆí•œ ìºì‹± ì „ëµ
- [ ] ì¿¼ë¦¬ ìµœì í™”

### ğŸ“ ê°•ì‚¬ë‹˜ì˜ í•µì‹¬ ë©”ì‹œì§€ ì¬í™•ì¸

> **"íŒ¨í„´ì„ ì½ì–´ì•¼ ë¼ìš”. ëª…ë ¹ì„ ì™¸ìš°ë¼ëŠ” ì–˜ê¸°ê°€ ì•„ë‹ˆì•¼ íŒ¨í„´ì„ ì½ìœ¼ì„¸ìš”."**

> **"ì¥ê³  ORMì„ ì¨ë„ ë˜ê³  ê·¸ëƒ¥ Raw SQL ë¬¸ì¥ì„ ì¨ë„ ê´œì°®ì•„ìš”. í¸í•œ ê±¸ë¡œ í•˜ì‹œë©´ ë©ë‹ˆë‹¤."**

ì´ì œ Django ORMì„ í™œìš©í•œ ì‹¤ë¬´ê¸‰ ë°ì´í„° ë¶„ì„ ì‹œìŠ¤í…œì„ ì™„ì „íˆ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€