# 20.03.04 Django ORM 실전 완전 가이드 - 뷰, 모델, 템플릿 상세 설명

> 이 문서는 **20.03.03 Django ORM 사용 관련 완전 가이드**에 이어지는 실전 구현 가이드입니다.

## 목차
1. [실습 문제 및 요구사항](#실습-문제-및-요구사항)
2. [모델 설정 상세 분석](#모델-설정-상세-분석)
3. [ORM 뷰 함수 완전 분석](#orm-뷰-함수-완전-분석)
4. [템플릿 구성 및 활용](#템플릿-구성-및-활용)
5. [URL 설정 및 라우팅](#url-설정-및-라우팅)
6. [실행 결과 및 디버깅](#실행-결과-및-디버깅)
7. [성능 최적화 추가 팁](#성능-최적화-추가-팁)

---

## 실습 문제 및 요구사항

### 🎯 핵심 과제
강사님이 제시한 4가지 분석 요구사항:

1. **사번, 직원명, 부서명, 직급, 연봉, 근무년수**를 DataFrame에 기억 후 출력하시오. (join)
   - **정렬**: 부서번호, 직원명 순으로 오름차순 정렬
2. **부서명, 직급** 자료를 이용하여 각각 **연봉합, 연봉평균**을 구하시오.
3. **부서명별** 연봉합, 평균을 이용하여 세로막대 그래프를 출력하시오.
4. **성별, 직급별** 빈도표를 출력하시오.

### 📋 구현 체크리스트
- [x] Django ORM을 사용한 조인 쿼리
- [x] DataFrame을 활용한 데이터 집계
- [x] 근무년수 계산 로직
- [x] 부서명 검색 필터링
- [x] HTML 템플릿에 결과 출력
- [x] 안전한 사용자 입력 처리

---

## 모델 설정 상세 분석

### 🏗️ 모델 구조 (myapp/models.py)

#### 📋 inspectdb 원본 (aa.py)에서 복사한 후 수정된 최종 모델

```python
from django.db import models

# ---- 기본 테이블들 ----

class Buser(models.Model):
    """부서 테이블"""
    buserno = models.IntegerField(primary_key=True)          # 부서번호 (PK)
    busername = models.CharField(max_length=10)              # 부서명
    buserloc = models.CharField(max_length=10, blank=True, null=True)  # 부서위치
    busertel = models.CharField(max_length=15, blank=True, null=True)  # 부서전화
    
    class Meta:
        managed = True    # ✅ False → True로 변경 (Django가 테이블 관리)
        db_table = 'buser'
    
    def __str__(self):
        return self.busername

class Jikwon(models.Model):
    """직원 테이블"""
    jikwonno = models.IntegerField(primary_key=True)         # 직원번호 (PK)
    jikwonname = models.CharField(max_length=10)             # 직원명
    
    # 🔥 핵심 수정: IntegerField → ForeignKey로 변경
    # ❌ 원본: busernum = models.IntegerField()
    # ✅ 수정: 관계 설정
    busernum = models.ForeignKey(
        Buser,                                               # 참조 모델
        on_delete=models.PROTECT,                           # 삭제 정책 (CASCADE도 가능)
        db_column='busernum'                                # 실제 DB 컬럼명
    )
    
    jikwonjik = models.CharField(max_length=10, blank=True, null=True)    # 직급
    jikwonpay = models.IntegerField(blank=True, null=True)               # 연봉
    jikwonibsail = models.DateField(blank=True, null=True)               # 입사일
    jikwongen = models.CharField(max_length=4, blank=True, null=True)     # 성별
    jikwonrating = models.CharField(max_length=3, blank=True, null=True)  # 평점
    
    class Meta:
        managed = True    # ✅ False → True로 변경
        db_table = 'jikwon'
    
    def __str__(self):
        return f"{self.jikwonname}({self.jikwonno})"

class Gogek(models.Model):
    """고객 테이블"""
    gogekno = models.IntegerField(primary_key=True)
    gogekname = models.CharField(max_length=10)
    gogektel = models.CharField(max_length=20, blank=True, null=True)
    gogekjumin = models.CharField(max_length=14, blank=True, null=True)
    
    # ✅ 이미 ForeignKey로 생성됨 (inspectdb가 자동 감지)
    gogekdamsano = models.ForeignKey(
        Jikwon,
        on_delete=models.PROTECT,                           # ✅ DO_NOTHING → PROTECT로 변경 권장
        db_column='gogekdamsano',
        blank=True,
        null=True
    )
    
    class Meta:
        managed = True    # ✅ False → True로 변경
        db_table = 'gogek'

class Board(models.Model):
    """게시판 테이블"""
    num = models.IntegerField(primary_key=True)
    author = models.CharField(max_length=10, blank=True, null=True)
    title = models.CharField(max_length=50, blank=True, null=True)
    content = models.CharField(max_length=4000, blank=True, null=True)
    bwrite = models.DateField(blank=True, null=True)
    readcnt = models.IntegerField(blank=True, null=True)
    
    class Meta:
        managed = True    # ✅ False → True로 변경
        db_table = 'board'

class Sangdata(models.Model):
    """상품 데이터 테이블"""
    code = models.IntegerField(primary_key=True)
    sang = models.CharField(max_length=20, blank=True, null=True)
    su = models.IntegerField(blank=True, null=True)
    dan = models.IntegerField(blank=True, null=True)
    
    class Meta:
        managed = True    # ✅ False → True로 변경
        db_table = 'sangdata'
```

### 🔍 수정 전후 비교 (핵심 변경사항)

#### 1. Jikwon 모델의 busernum 필드 변경
```python
# ❌ inspectdb 원본
class Jikwon(models.Model):
    busernum = models.IntegerField()  # 단순 정수 필드
    
    class Meta:
        managed = False  # Django가 관리 안함

# ✅ ORM 활용을 위한 수정
class Jikwon(models.Model):
    busernum = models.ForeignKey(
        Buser,
        on_delete=models.PROTECT,  # 또는 CASCADE
        db_column='busernum'
    )
    
    class Meta:
        managed = True   # Django가 관리함
```

#### 2. 모든 모델의 managed 설정 변경
```python
# ❌ inspectdb 원본 (모든 모델)
class Meta:
    managed = False  # 읽기 전용

# ✅ ORM 활용을 위한 수정 (모든 모델)
class Meta:
    managed = True   # 완전한 ORM 기능 사용
```

### 🔍 모델 관계 설정 핵심 포인트

#### 1. `managed = False → True` 변경의 의미
```python
class Meta:
    managed = False  # ❌ inspectdb 기본값
    managed = True   # ✅ ORM 완전 활용을 위한 수정
```

**변경 이유와 효과:**
- **`managed = False`**: 
  - Django가 테이블을 읽기만 함 (안전하지만 제한적)
  - 마이그레이션으로 테이블 구조 변경 불가
  - ORM의 일부 기능 제한
  
- **`managed = True`**:
  - Django가 테이블을 완전히 관리
  - 마이그레이션으로 구조 변경 가능
  - 모든 ORM 기능 사용 가능
  - **⚠️ 주의**: 기존 데이터와 충돌 가능성

#### 2. `IntegerField() → ForeignKey()` 변경의 핵심
```python
# ❌ inspectdb 원본 (관계 인식 못함)
busernum = models.IntegerField()  # 단순 숫자로 인식

# ✅ ORM 관계 활용을 위한 수정
busernum = models.ForeignKey(
    Buser,                    # 참조할 모델 클래스
    on_delete=models.PROTECT, # 삭제 정책
    db_column='busernum'      # 실제 DB 컬럼명
)
```

**변경 이유:**
- inspectdb는 외래키를 자동으로 감지하지 못하는 경우가 많음
- IntegerField로 남겨두면 ORM의 관계 기능 사용 불가
- `jikwon.busernum.busername` 같은 관계 접근 불가능

**ForeignKey 설정 시 핵심 옵션:**
```python
busernum = models.ForeignKey(
    'Buser',                     # 참조 모델 (문자열로도 가능)
    on_delete=models.PROTECT,    # ✅ 권장: 안전한 삭제 정책
    db_column='busernum',        # 실제 DB 컬럼명 (생략 가능)
    related_name='employees'     # 역참조 이름 (선택사항)
)
```

**삭제 정책 옵션**:
- `CASCADE`: 부모 삭제 시 자식도 삭제
- `PROTECT`: 자식이 있으면 부모 삭제 불가
- `SET_NULL`: 부모 삭제 시 자식의 외래키를 NULL로 설정
- `DO_NOTHING`: 아무 작업 안함 (DB 제약조건에 의존)

---

## ORM 뷰 함수 완전 분석

### 🎯 ormAnalysisFunc 뷰 함수 상세 분석

```python
from django.shortcuts import render
from django.db import connection
from .models import Jikwon  # 또는: from myapp.models import Jikwon
import pandas as pd
from django.utils.html import escape
from datetime import date

def ormAnalysisFunc(request):
    """ORM을 사용한 직원 정보 조회 및 분석"""
    
    # ==========================================
    # 1. 사용자 입력 처리 및 보안
    # ==========================================
    dept = (request.GET.get('dept') or "").strip()
    
    # ==========================================
    # 2. ORM 쿼리: 조인 + 필터 + 정렬
    # ==========================================
    
    # 기본 쿼리셋 생성 (select_related로 JOIN 최적화)
    qs = (
        Jikwon.objects
        .select_related('busernum')  # INNER JOIN buser 테이블
    )
    
    # 부서명 필터링 (사용자 입력이 있는 경우)
    if dept:
        qs = qs.filter(busernum__busername__icontains=dept)
        # SQL: WHERE buser.busername LIKE '%dept%'
    
    # 정렬: "부서번호, 직원명 오름차순"
    qs = qs.order_by('busernum__buserno', 'jikwonname')
    # SQL: ORDER BY buser.buserno, jikwon.jikwonname
    
    # ==========================================
    # 3. 데이터 추출 및 DataFrame 변환
    # ==========================================
    
    # values()로 필요한 필드만 추출
    rows = qs.values(
        'jikwonno',               # 직원번호
        'jikwonname',             # 직원명
        'busernum__busername',    # 부서명 (JOIN을 통해 접근)
        'busernum__busertel',     # 부서전화
        'jikwonjik',              # 직급
        'jikwonpay',              # 연봉
        'jikwongen',              # 성별
        'jikwonibsail',           # 입사일(근무년수 계산용)
    )
    
    # DataFrame으로 변환
    df = pd.DataFrame(list(rows))
    
    # 데이터가 없는 경우 처리
    if df.empty:
        empty_html = "<p>검색 결과가 없습니다.</p>"
        ctx = {
            'dept': escape(dept),
            'join_html': empty_html,
            'dept_pos_pay_html': empty_html,
            'dept_pay_html': empty_html,
            'gender_pos_freq_html': empty_html,
        }
        return render(request, 'orm_analysis.html', ctx)
    
    # ==========================================
    # 4. 컬럼명 한글화
    # ==========================================
    df = df.rename(columns={
        'jikwonno': '직원번호',
        'jikwonname': '직원명',
        'busernum__busername': '부서명',
        'busernum__busertel': '부서전화',
        'jikwonjik': '직급',
        'jikwonpay': '연봉',
        'jikwongen': '성별',
        'jikwonibsail': '입사일',
    })
    
    # ==========================================
    # 5. 근무년수 계산 (중요!)
    # ==========================================
    today = date.today()
    
    def years_of_service(d):
        """입사일을 기준으로 근무년수 계산"""
        try:
            if pd.isna(d):
                return None
            # 다양한 날짜 형식 처리
            dt = pd.to_datetime(d).date()
            years = today.year - dt.year - ((today.month, today.day) < (dt.month, dt.day))
            return max(years, 0)  # 음수 방지
        except Exception:
            return None
    
    df['근무년수'] = df['입사일'].apply(years_of_service)
    
    # NaN/None 값 정리 (표시용)
    df_display = df[['직원번호', '직원명', '부서명', '부서전화', '직급', '연봉', '근무년수']].fillna('')
    
    # ==========================================
    # 6. 분석 결과 생성
    # ==========================================
    
    # (1) 직원 기본 조인 결과 표
    join_html = df_display.to_html(index=False, classes='table table-striped')
    
    # (2) 부서명, 직급 기준 연봉 합/평균
    dept_pos = (
        df.groupby(['부서명', '직급'], dropna=False)['연봉']
          .agg(['sum', 'mean'])
          .reset_index()
    )
    dept_pos_pay_html = dept_pos.fillna(0).to_html(index=False, classes='table table-striped')
    
    # (3) 부서명별 연봉 합/평균
    dept_pay = (
        df.groupby(['부서명'], dropna=False)['연봉']
          .agg(['sum', 'mean'])
          .reset_index()
    )
    dept_pay_html = dept_pay.fillna(0).to_html(index=False, classes='table table-striped')
    
    # (4) 성별, 직급별 빈도표 (count)
    gender_pos = (
        df.groupby(['성별', '직급'], dropna=False)['직원번호']
          .agg(['count'])
          .reset_index()
          .rename(columns={'count': '인원수'})
    )
    gender_pos_freq_html = gender_pos.fillna(0).to_html(index=False, classes='table table-striped')
    
    # ==========================================
    # 7. 템플릿 컨텍스트 준비
    # ==========================================
    ctx = {
        'dept': escape(dept),                                 # XSS 방지
        'join_html': join_html,                              # (1) 직원 목록
        'dept_pos_pay_html': dept_pos_pay_html,              # (2) 부서·직급별 연봉 통계
        'dept_pay_html': dept_pay_html,                      # (3) 부서별 연봉 통계
        'gender_pos_freq_html': gender_pos_freq_html,        # (4) 성별·직급별 인원수
    }
    
    return render(request, 'orm_analysis.html', ctx)
```

### 🔍 핵심 ORM 기법 분석

#### 1. `select_related()` - JOIN 최적화
```python
Jikwon.objects.select_related('busernum')
```
- **역할**: SQL의 INNER JOIN과 동일
- **장점**: N+1 쿼리 문제 해결 (한 번의 쿼리로 관련 데이터까지 가져옴)
- **생성되는 SQL**:
```sql
SELECT jikwon.*, buser.*
FROM jikwon 
INNER JOIN buser ON jikwon.busernum = buser.buserno
```

#### 2. 관계 필드 접근 - `__` 구문
```python
qs.filter(busernum__busername__icontains=dept)
qs.order_by('busernum__buserno', 'jikwonname')
```
- **의미**: 관련 테이블의 필드에 접근
- `busernum__busername`: Jikwon → Buser → busername
- `__icontains`: 대소문자 무시 부분 검색 (LIKE '%value%')

#### 3. `values()` - 필요한 필드만 선택
```python
qs.values('jikwonno', 'jikwonname', 'busernum__busername')
```
- **역할**: SQL의 SELECT 절과 동일
- **장점**: 메모리 효율성, 네트워크 트래픽 감소
- **반환**: QuerySet[dict] 형태

### 🔧 DataFrame 활용 패턴

#### 1. 안전한 DataFrame 변환
```python
df = pd.DataFrame(list(rows))
if df.empty:
    # 빈 데이터 처리
    return render(request, template, empty_context)
```

#### 2. 근무년수 계산 로직
```python
def years_of_service(d):
    try:
        if pd.isna(d):
            return None
        dt = pd.to_datetime(d).date()
        years = today.year - dt.year - ((today.month, today.day) < (dt.month, dt.day))
        return max(years, 0)
    except Exception:
        return None
```
- **핵심**: 생일이 지났는지 확인하여 정확한 만 나이 계산
- **예외 처리**: 잘못된 날짜 형식이나 NULL 값 안전하게 처리

#### 3. 그룹별 집계
```python
# 부서명, 직급 기준 연봉 집계
dept_pos = (
    df.groupby(['부서명', '직급'], dropna=False)['연봉']
      .agg(['sum', 'mean'])
      .reset_index()
)
```
- `dropna=False`: NULL 값도 그룹에 포함
- `agg(['sum', 'mean'])`: 여러 집계 함수 동시 적용
- `reset_index()`: 멀티인덱스를 일반 컬럼으로 변환

---

## 템플릿 구성 및 활용

### 🎨 orm_analysis.html 템플릿

```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ORM 분석 페이지</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .search-form {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .search-form input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .search-form button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .search-form button:hover {
            background: #0056b3;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h3 {
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .table th,
        .table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .navigation {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .navigation a {
            display: inline-block;
            margin: 0 10px;
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        
        .navigation a:hover {
            background: #545b62;
        }
        
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 Django ORM 직원 분석 시스템</h1>
            <p>실무에서 활용하는 ORM 패턴과 데이터 분석</p>
        </div>

        <!-- 검색 폼 -->
        <div class="search-form">
            <form method="get" action="/orm_analysis/">
                <label for="dept"><strong>부서명 검색:</strong></label>
                <input type="text" id="dept" name="dept" value="{{ dept }}" 
                       placeholder="부서명 입력 (예: 총무부, 영업부)">
                <button type="submit">🔍 조회</button>
            </form>
        </div>

        <!-- 네비게이션 -->
        <div class="navigation">
            <a href="/orm_analysis/">📋 전체 자료</a>
            <a href="/dbshow/">⚡ Raw SQL 버전</a>
            <a href="/">🏠 메인 페이지</a>
        </div>

        <!-- 현재 검색 조건 표시 -->
        {% if dept %}
        <div class="info-box">
            <strong>🔍 현재 검색 조건:</strong> 부서명에 "{{ dept }}" 포함
        </div>
        {% endif %}

        <!-- 1. 직원 목록 -->
        <div class="section">
            <h3>① 직원 기본 정보 (JOIN 결과)</h3>
            <div>{{ join_html|safe }}</div>
        </div>

        <!-- 2. 부서·직급별 연봉 통계 -->
        <div class="section">
            <h3>② 부서·직급별 연봉 합계/평균</h3>
            <div>{{ dept_pos_pay_html|safe }}</div>
        </div>

        <!-- 3. 부서별 연봉 통계 -->
        <div class="section">
            <h3>③ 부서별 연봉 합계/평균</h3>
            <div>{{ dept_pay_html|safe }}</div>
        </div>

        <!-- 4. 성별·직급별 인원수 -->
        <div class="section">
            <h3>④ 성별·직급별 인원수 분포</h3>
            <div>{{ gender_pos_freq_html|safe }}</div>
        </div>

        <!-- 강사님 조언 -->
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-top: 30px;">
            <h4>💡 강사님의 실무 조언</h4>
            <blockquote style="font-style: italic; color: #856404;">
                "장고 ORM을 써도 되고 그냥 Raw SQL 문장을 써도 괜찮아요. 편한 걸로 하시면 됩니다."<br>
                "패턴을 읽어야 돼요. 명령을 외우라는 얘기가 아니야 패턴을 읽으세요."
            </blockquote>
        </div>
    </div>
</body>
</html>
```

### 🎯 템플릿 핵심 기법

#### 1. Django 템플릿 태그 활용
```html
{% if dept %}
    <div class="info-box">현재 검색: {{ dept }}</div>
{% endif %}
```
- **조건부 렌더링**: 사용자가 검색했을 때만 정보 표시

#### 2. 안전한 HTML 출력
```html
{{ join_html|safe }}
```
- **`|safe` 필터**: DataFrame의 `to_html()` 결과를 안전하게 출력
- **주의**: XSS 위험이 있으므로 신뢰할 수 있는 데이터에만 사용

#### 3. 반응형 스타일링
```css
.table tr:nth-child(even) {
    background-color: #f2f2f2;
}
```
- **얼룩말 효과**: 가독성 향상을 위한 교대로 배경색 적용

---

## URL 설정 및 라우팅

### 🛣️ mainapp/urls.py

```python
from django.contrib import admin
from django.urls import path
from myapp import views

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', views.indexFunc, name='index'),                    # 메인 페이지
    path('dbshow/', views.dbshowFunc, name='dbshow'),           # Raw SQL 버전
    path('orm_analysis/', views.ormAnalysisFunc, name='orm_analysis'),  # ORM 버전
]
```

### 🔍 URL 패턴 설명

1. **`path('orm_analysis/', ...)`**
   - **요청 URL**: `http://localhost:8000/orm_analysis/`
   - **GET 파라미터**: `?dept=총무부`
   - **최종 URL**: `http://localhost:8000/orm_analysis/?dept=총무부`

2. **name 속성 활용**
```html
<!-- 템플릿에서 URL 역참조 -->
<a href="{% url 'orm_analysis' %}">ORM 분석</a>
```

3. **GET 파라미터 처리**
```python
# 뷰에서 GET 파라미터 받기
dept = request.GET.get('dept', '')  # 기본값: 빈 문자열
```

---

## 실행 결과 및 디버깅

### 🖥️ 예상 실행 결과

#### 1. 전체 직원 조회 (필터 없음)
```
① 직원 기본 정보
직원번호  직원명  부서명   부서전화      직급  연봉      근무년수
1        김철수  총무부   02-1234-5678  과장  4500000   15
2        이영희  영업부   02-2345-6789  대리  3500000   8
...
```

#### 2. 부서 필터링 결과 (dept=총무)
```
🔍 현재 검색 조건: 부서명에 "총무" 포함

① 직원 기본 정보
직원번호  직원명  부서명   직급  연봉      근무년수
1        김철수  총무부   과장  4500000   15
5        박민수  총무부   사원  2800000   3
```

#### 3. 집계 결과
```
② 부서·직급별 연봉 합계/평균
부서명   직급   sum        mean
총무부   과장   4500000    4500000
총무부   사원   2800000    2800000
영업부   부장   6000000    6000000
```

### 🐛 주요 디버깅 포인트

#### 1. 모델 관계 설정 오류
```python
# ❌ 잘못된 설정
busernum = models.IntegerField()

# ✅ 올바른 설정
busernum = models.ForeignKey(Buser, on_delete=models.PROTECT, db_column='busernum')
```

#### 2. 템플릿 경로 오류
```python
# settings.py에서 템플릿 경로 확인
TEMPLATES = [
    {
        'DIRS': [BASE_DIR / 'templates'],  # 올바른 경로 설정
    },
]
```

#### 3. 데이터 타입 오류
```python
# 숫자 연산 전 타입 확인
df['연봉'] = pd.to_numeric(df['연봉'], errors='coerce')
```

#### 4. 날짜 계산 오류
```python
# 다양한 날짜 형식 처리
dt = pd.to_datetime(d).date()  # 안전한 날짜 변환
```

---

## 성능 최적화 추가 팁

### ⚡ ORM 쿼리 최적화

#### 1. 쿼리 개수 최소화
```python
# ❌ N+1 쿼리 발생
for jikwon in Jikwon.objects.all():
    print(jikwon.busernum.busername)  # 각 직원마다 부서 조회

# ✅ 한 번의 쿼리로 해결
jikwons = Jikwon.objects.select_related('busernum').all()
for jikwon in jikwons:
    print(jikwon.busernum.busername)
```

#### 2. 필요한 필드만 조회
```python
# ❌ 모든 필드 조회
jikwons = Jikwon.objects.select_related('busernum').all()

# ✅ 필요한 필드만 조회
jikwons = Jikwon.objects.select_related('busernum').only(
    'jikwonno', 'jikwonname', 'jikwonpay', 
    'busernum__busername'
)
```

#### 3. 인덱스 활용
```python
# 자주 검색하는 필드에 인덱스 추가
class Jikwon(models.Model):
    jikwonname = models.CharField(max_length=10, db_index=True)
    jikwonjik = models.CharField(max_length=10, db_index=True)
```

### 🚀 DataFrame 최적화

#### 1. 메모리 효율적 처리
```python
# 대용량 데이터 처리 시
def process_large_dataset(queryset):
    chunk_size = 1000
    for chunk in queryset.iterator(chunk_size=chunk_size):
        df_chunk = pd.DataFrame([chunk])
        # 청크 단위로 처리
        yield df_chunk
```

#### 2. 캐싱 활용
```python
from django.core.cache import cache

def cached_analysis(dept):
    cache_key = f"analysis_{dept}"
    result = cache.get(cache_key)
    
    if result is None:
        result = perform_analysis(dept)
        cache.set(cache_key, result, 300)  # 5분 캐시
    
    return result
```

### 🔧 템플릿 최적화

#### 1. CSS/JS 파일 분리
```html
<!-- 외부 CSS 파일 사용 -->
{% load static %}
<link rel="stylesheet" href="{% static 'css/analysis.css' %}">
```

#### 2. 테이블 페이지네이션
```python
from django.core.paginator import Paginator

def paginated_view(request):
    employees = Jikwon.objects.select_related('busernum').all()
    paginator = Paginator(employees, 25)  # 페이지당 25개
    
    page = request.GET.get('page')
    employees_page = paginator.get_page(page)
    
    return render(request, 'template.html', {
        'employees': employees_page
    })
```

---

## 마무리: 실무 활용 체크리스트

### ✅ 완료해야 할 항목들

#### 모델 설정
- [ ] `inspectdb`로 기존 DB 구조 파악
- [ ] `managed = False`로 안전한 연동 설정
- [ ] `ForeignKey` 관계 설정
- [ ] `on_delete` 정책 결정

#### 뷰 함수 구현
- [ ] `select_related()` 로 JOIN 최적화
- [ ] 사용자 입력 검증 및 XSS 방지
- [ ] DataFrame 활용한 데이터 분석
- [ ] 예외 처리 및 빈 데이터 대응

#### 템플릿 구성
- [ ] 반응형 스타일링
- [ ] 안전한 HTML 출력 (`|safe`)
- [ ] 사용자 친화적 UI/UX

#### 성능 최적화
- [ ] 필요한 필드만 조회
- [ ] 적절한 캐싱 전략
- [ ] 쿼리 최적화

### 🎓 강사님의 핵심 메시지 재확인

> **"패턴을 읽어야 돼요. 명령을 외우라는 얘기가 아니야 패턴을 읽으세요."**

> **"장고 ORM을 써도 되고 그냥 Raw SQL 문장을 써도 괜찮아요. 편한 걸로 하시면 됩니다."**

이제 Django ORM을 활용한 실무급 데이터 분석 시스템을 완전히 구현할 수 있습니다! 🚀