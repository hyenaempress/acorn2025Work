# 20.03 Django MariaDB 연결 및 DB 활용 완전 가이드 - 추가 핵심 내용

## 🎯 강사님의 실무 철학과 핵심 조언

### 1. 패턴 읽기의 중요성
**강사님**: *"패턴을 안 읽고 그냥 맹목적으로... 패턴을 읽어야 돼요. 명령을 외우라는 얘기가 아니야 패턴을 읽으세요."*

#### MVC 패턴 이해
```python
# Django의 MVT 패턴
# Model(모델) - View(뷰) - Template(템플릿)

# Model: 데이터베이스와 상호작용
class Jikwon(models.Model):
    jikwonname = models.CharField(max_length=10)
    # "모델이 M을 담당하고 있죠"

# View: 비즈니스 로직 처리
def dbshowFunc(request):
    # "뷰에서 로직을 처리합니다"
    
# Template: 사용자에게 보여지는 부분
{{ join_html|safe }}
```

### 2. 마이그레이션 패턴과 타이밍
**강사님**: *"마이그레이션은 언제하는거에요? 테이블을 만들고 마이그레이션 하고 마이그레이트 하는거에요. 그때마다 메이크 마이그레이션을 해줘서 쓰면 됩니다."*

```bash
# 패턴 1: 새 모델 생성 후
python manage.py makemigrations
python manage.py migrate

# 패턴 2: 기존 모델 수정 후  
python manage.py makemigrations myapp
python manage.py migrate

# 패턴 3: inspectdb 후 모델 복사
python manage.py inspectdb > aa.py
# aa.py 내용을 models.py에 복사 후
python manage.py makemigrations --empty myapp
python manage.py migrate
```

---

## 🔒 보안 고려사항 상세 설명

### 1. SQL 인젝션 공격과 방지
**강사님**: *"문자를 더하기 하면 안 돼... SQL 인젝션 해킹에 걸려요"*

#### 위험한 코드 예시
```python
# ❌ 매우 위험한 방법
dept = request.GET.get('dept')
sql = f"SELECT * FROM jikwon WHERE busername = '{dept}'"

# 공격자가 입력할 수 있는 악성 코드:
# '; DROP TABLE jikwon; --
# 결과: "SELECT * FROM jikwon WHERE busername = ''; DROP TABLE jikwon; --'"
```

#### 안전한 코드 패턴
```python
# ✅ 안전한 방법 - 매개변수화된 쿼리
params = []
if dept:
    sql += " WHERE b.busername LIKE %s"
    params.append(f"%{dept}%")  # 퍼센트는 SQL의 LIKE 연산자용

cursor.execute(sql, params)  # "파람스는 퍼센트랑 매핑합니다"
```

### 2. XSS (크로스 사이트 스크립팅) 공격 방지
**강사님**: *"크로스 사이트 스크립팅... 자바스크립트 내용이 해당 컴퓨터로 가가지고 다른 작업을 해"*

```python
from django.utils.html import escape

# 사용자 입력 데이터 이스케이프 처리
dept = request.GET.get('dept')
safe_dept = escape(dept)  # <script> → &lt;script&gt;

# "문자열에 특수문자가 있는 경우 HTML 엔티티로 취급함 XSS 공격을 막기 위한 것"
context = {
    'dept': safe_dept,  # 특수문자를 일반 문자로 변환
}
```

---

## 📊 데이터 분석 고급 기법

### 1. 커서 메타데이터 활용
**강사님**: *"커서들은 쿼리 정보에 대한 메타데이터를 가지고 있습니다"*

```python
with connection.cursor() as cursor:
    cursor.execute(sql, params)
    rows = cursor.fetchall()
    
    # 컬럼명 자동 추출
    cols = [c[0] for c in cursor.description]
    # cursor.description: 각 컬럼의 메타데이터
    # (name, type_code, display_size, internal_size, precision, scale, null_ok)
    
    # DataFrame 생성 시 컬럼명 자동 매핑
    df = pd.DataFrame(rows, columns=cols)
```

### 2. 자유도(ddof) 설정의 중요성
```python
stats_df = (
    df.groupby('직급')['연봉']
      .agg(
          평균='mean',
          표준편차=lambda x: x.std(ddof=0),  # 자유도 0으로 설정
          인원수='count',
      )
      .round(2)
      .reset_index()
)

# ddof=0: 모집단 표준편차 (전체 직원이 모집단인 경우)
# ddof=1: 표본 표준편차 (기본값, 표본에서 모집단을 추정하는 경우)
```

### 3. NaN 값 처리 패턴
```python
# 1명인 경우 표준편차가 계산되지 않아 NaN 발생
stats_df['표준편차'] = stats_df['표준편차'].fillna(0)

# 연봉 데이터 안전한 숫자 변환
df['연봉'] = pd.to_numeric(df['연봉'], errors='coerce')
# errors='coerce': 변환 불가능한 값을 NaN으로 처리
```

---

## 🛡️ 데이터베이스 안전 관리

### 1. 강사님의 DB 관리 철학
**강사님**: *"DB는 정말 어린아이 다루듯이 다뤄야 돼... 꼭 백업을 받아놔야 돼요"*

```bash
# MariaDB 백업 명령어
mysqldump -u root -p mydb > backup_$(date +%Y%m%d_%H%M%S).sql

# 특정 테이블만 백업
mysqldump -u root -p mydb jikwon buser > employee_backup.sql

# 백업 복원
mysql -u root -p mydb < backup_20250812_143000.sql
```

### 2. 안전한 연결 종료
**강사님**: *"열었으면 닫아라! 메모리 누수를 막는 방법이다!"*

```python
# ✅ 안전한 패턴 - with문 사용 (권장)
with connection.cursor() as cursor:
    cursor.execute(sql, params)
    # with문이 자동으로 cursor.close() 호출

# ✅ 수동 관리 패턴
cursor = connection.cursor()
try:
    cursor.execute(sql, params)
    return cursor.fetchall()
finally:
    cursor.close()  # 반드시 리소스 정리
```

---

## 🚀 실무 프로젝트 운영 노하우

### 1. 팀 프로젝트 방식
**강사님**: *"팀별 프로젝트 짤 때는 꼭 위임을 해줘야 돼요... 랜덤하게 찍어가지고 팀원 중에 누군가가 발표"*

#### 역할 분담 예시
```python
# 프로젝트 구조와 역할
django_project/
├── backend/     # A팀원: 데이터베이스 설계 및 모델
├── frontend/    # B팀원: 템플릿 및 UI/UX
├── analysis/    # C팀원: 데이터 분석 및 통계
└── security/    # D팀원: 보안 및 배포
```

### 2. 평가 기준과 실행 중심 개발
**강사님**: *"문제를 복붙해가지고 내가 직접 돌려본다. 안 돌아가면 0점이야!"*

```python
# 실행 가능한 코드 작성 체크리스트
def code_quality_check():
    checks = [
        "모든 import 구문이 정상인가?",
        "변수명 오타가 없는가?",
        "데이터베이스 연결이 정상인가?",
        "예외 처리가 되어 있는가?",
        "테스트 데이터로 실행 가능한가?"
    ]
    return checks

# "돌아가는데 모양이 이상하면 부분 점수 (50% 정도)"
```

---

## 🔧 고급 Django 개발 패턴

### 1. Django ORM vs Raw SQL 선택 기준
**강사님**: *"장고 ORM을 써도 되고 그냥 Raw SQL 문장을 써도 괜찮아요. 편한 걸로 하시면 됩니다."*

```python
# Django ORM 방식 (단순한 쿼리)
def orm_approach(request):
    from .models import Jikwon, Buser
    
    jikwons = Jikwon.objects.select_related('busernum').all()
    if dept:
        jikwons = jikwons.filter(busernum__busername__icontains=dept)
    
    return jikwons

# Raw SQL 방식 (복잡한 쿼리, 성능 최적화)
def raw_sql_approach(request):
    sql = """
    SELECT j.*, b.busername 
    FROM jikwon j 
    INNER JOIN buser b ON j.busernum = b.buserno
    WHERE b.busername LIKE %s
    """
    # 복잡한 집계나 서브쿼리가 필요할 때 Raw SQL이 더 효율적
```

### 2. 보안 코딩 가이드라인
**강사님**: *"시큐어 코딩 가이드라인... 면접 같은 데 가가지고 '시큐어 코딩 가이드라인에 대해서 알고 있나요?' 이런 얘기할 때"*

```python
# 보안 코딩 체크리스트
def security_checklist():
    return {
        "입력 검증": "모든 사용자 입력 검증 및 이스케이프 처리",
        "SQL 인젝션 방지": "매개변수화된 쿼리 사용",
        "XSS 방지": "HTML 이스케이프 처리",
        "CSRF 방지": "Django의 기본 CSRF 토큰 활용",
        "권한 관리": "적절한 인증 및 인가 처리",
        "민감정보 보호": "패스워드, API 키 암호화 저장",
        "로깅": "보안 이벤트 로깅 및 모니터링"
    }

# settings.py 보안 설정
DEBUG = False  # 운영환경에서는 반드시 False
ALLOWED_HOSTS = ['your-domain.com']  # 허용된 호스트만 접근
SECRET_KEY = os.environ.get('SECRET_KEY')  # 환경변수로 관리
```

---

## 📋 실무 체크리스트와 베스트 프랙티스

### 1. 코드 품질 관리
```python
# 코드 리뷰 체크포인트
def code_review_checklist():
    return [
        "✅ 실행 가능성: 코드가 정상 실행되는가?",
        "✅ 가독성: 다른 개발자가 이해하기 쉬운가?",
        "✅ 보안성: 보안 취약점은 없는가?",
        "✅ 성능: 효율적으로 작동하는가?",
        "✅ 확장성: 요구사항 변경에 대응 가능한가?",
        "✅ 테스트: 테스트 코드가 작성되어 있는가?",
        "✅ 문서화: 주석과 문서가 적절한가?"
    ]
```

### 2. 배포 전 최종 점검
```bash
# 배포 전 체크리스트
echo "🔍 Django 배포 전 점검사항"
python manage.py check --deploy
python manage.py test
python manage.py collectstatic
echo "✅ 모든 검사 완료"
```

---

## 🎯 실무 프로젝트 예시

### 완전한 직원 관리 시스템 확장
```python
# 고급 기능 추가 예시
class AdvancedEmployeeView:
    """실무에서 요구되는 고급 기능들"""
    
    def dashboard_view(self, request):
        """대시보드: 실시간 통계"""
        pass
    
    def export_excel(self, request):
        """Excel 다운로드 기능"""
        pass
    
    def bulk_update(self, request):
        """대량 데이터 업데이트"""
        pass
    
    def audit_log(self, request):
        """변경 이력 추적"""
        pass
    
    def performance_analytics(self, request):
        """성과 분석 리포트"""
        pass
```

이제 Django MariaDB 연결 가이드가 실무에서 바로 적용 가능한 완전한 형태로 보완되었습니다! 강사님의 실무 경험과 조언이 고스란히 녹아있는 실전 가이드입니다. 🚀