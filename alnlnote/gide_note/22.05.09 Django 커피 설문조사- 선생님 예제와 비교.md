# Django 커피 설문조사 카이제곱 검정 웹 애플리케이션

## 📋 프로젝트 개요

이 프로젝트는 Django 프레임워크를 사용하여 성별에 따른 커피 브랜드 선호도 차이를 카이제곱 검정으로 분석하는 웹 애플리케이션입니다.

### 🎯 주요 기능
- 커피 브랜드 선호도 설문조사 입력
- 설문 결과 데이터베이스 저장
- 성별과 커피브랜드별 교차분할표 생성
- 카이제곱 독립성 검정 수행
- 검정 결과 웹 출력
- 커피브랜드별 선호도 차트 생성

---

## 🗄️ 데이터베이스 설정

### MariaDB 설정
```sql
-- 데이터베이스 생성
CREATE DATABASE coffeedb;
USE coffeedb;

-- 테이블 생성
CREATE TABLE survey(
    rnum INT PRIMARY KEY AUTO_INCREMENT, 
    gender VARCHAR(4),
    age INT(3),
    co_survey VARCHAR(10)
);

-- 샘플 데이터 입력 예시
INSERT INTO survey (gender, age, co_survey) VALUES ('남', 10, '탐앤탐스');
INSERT INTO survey (gender, age, co_survey) VALUES ('여', 10, '스타벅스');
```

### 테이블 구조
| 컬럼명 | 타입 | 설명 |
|--------|------|------|
| rnum | INT | 기본키 (자동증가) |
| gender | VARCHAR(4) | 성별 (남/여) |
| age | INT(3) | 나이대 |
| co_survey | VARCHAR(10) | 선호 커피브랜드 |

---

## 🏗️ Django 프로젝트 구조

### 프로젝트 생성
```bash
# 프로젝트 폴더 생성
mkdir django4_coffee
cd django4_coffee

# Django 프로젝트 생성
django-admin startproject mainapp .

# 앱 생성
python manage.py startapp myapp
```

### 폴더 구조
```
django4_coffee/
├── mainapp/
│   ├── __init__.py
│   ├── settings.py
│   ├── urls.py
│   └── views.py
├── myapp/
│   ├── __init__.py
│   ├── models.py
│   ├── views.py
│   ├── urls.py
│   └── templates/
│       ├── index.html
│       └── coffee/
│           ├── survey_form.html
│           └── survey_result.html
└── manage.py
```

---

## 📊 모델 정의

### models.py
```python
from django.db import models

class Survey(models.Model):
    rnum = models.AutoField(primary_key=True)
    gender = models.CharField(max_length=4, blank=True, null=True)
    age = models.IntegerField(blank=True, null=True)
    co_survey = models.CharField(max_length=10, blank=True, null=True)

    class Meta:
        managed = False  # 테이블 생성 안함 (기존 DB 사용)
        db_table = 'survey'
```

---

## 🔗 URL 설정

### mainapp/urls.py
```python
from django.contrib import admin
from django.urls import path, include
from mainapp import views

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', views.surveyMain),
    path('coffee/', include('myapp.urls')),
]
```

### myapp/urls.py
```python
from django.urls import path
from . import views

urlpatterns = [
    path('survey', views.survey_form, name='survey_form'),
    path('surveyshow', views.survey_result, name='survey_result'),
    path('surveyprocess', views.survey_process, name='survey_process'),
]
```

---

## 🎨 뷰 함수

### views.py (선생님 완전 구현 버전)
```python
from django.shortcuts import render, redirect
import os
from django.conf import settings
import matplotlib
matplotlib.use('Agg')   # 서버에서 시각화 GUI 없이 저장할 때
import matplotlib.pyplot as plt
plt.rc('font', family='Malgun Gothic')

from myapp.models import Survey
import pandas as pd
import numpy as np
import scipy.stats as stats

# Create your views here.
def surveyMain(request):
    """메인 페이지"""
    return render(request, 'index.html')

def surveyView(request):
    """설문 입력 폼 페이지"""
    return render(request, 'coffee/coffeesurvey.html')

def surveyProcess(request):
    """설문 처리 및 결과 분석"""
    insertDataFunc(request)

    # 전체 데이터 조회
    rdata = list(Survey.objects.all().values())
    
    # 데이터 분석(이원 카이제곱 검정)
    crossTbl, results, df = analysisFunc(rdata)   

    # 차트 처리함수 호출
    static_img_path = os.path.join(settings.BASE_DIR, 'static', 'images', 'cobar.png')
    save_brand_barFunc(df, static_img_path)

    return render(request, 'coffee/result.html', {
        'crossTbl': crossTbl.to_html(),
        'results': results,
        'df': df.to_html(index=False)
    })

def insertDataFunc(request):
    """설문 데이터 DB 저장"""
    if request.method == 'POST':
        # 폼 데이터 가져오기
        gender = request.POST.get('gender')
        age = request.POST.get('age') 
        co_survey = request.POST.get('co_survey')
        
        # DB에 저장
        Survey.objects.create(
            gender=gender,
            age=age,
            co_survey=co_survey,
        )

def analysisFunc(rdata):
    """카이제곱 독립성 검정 분석"""
    # 가설 설정
    # 귀무가설: 성별에 따라 선호하는 커피 브랜드에 차이가 없다.
    # 대립가설: 성별에 따라 선호하는 커피 브랜드에 차이가 있다.
    
    df = pd.DataFrame(rdata)
    if df.empty:
        return pd.DataFrame(), '데이터가 없어요', pd.DataFrame()
    
    # 결측치 제거
    df = df.dropna(subset=['gender', 'co_survey'])
    
    # 더미 변수 생성 (분석용)
    df['genNum'] = df['gender'].apply(lambda g: 1 if g == '남' else 2)
    df['coNum'] = df['co_survey'].apply(
        lambda c: 1 if c == '스타벅스' else 2 if c == '커피빈' else 3 if c == '이디야' else 4
    )
    
    # 교차분할표 작성
    crossTbl = pd.crosstab(index=df['gender'], columns=df['co_survey'])
    
    # 표본 부족 시 메시지 전달
    if crossTbl.size == 0 or crossTbl.shape[0] < 2 or crossTbl.shape[1] < 2:
        results = "표본 자료가 부족해 카이제곱 검정 수행 불가!!!"
        return crossTbl, results, df
    
    # 카이제곱 검정 수행
    alpha = 0.05   # 유의 수준
    st, pv, ddof, expected = stats.chi2_contingency(crossTbl)

    # 기대 빈도 최소값 체크 (경고용)
    min_expected = expected.min()
    expected_note = ""
    if min_expected < 5:
        expected_note = f"<br><small>* 주의: 기대빈도의 최소값이 {min_expected:.2f}로 5 미만이 있어 카이제곱 가정에 다소 취약합니다</small>"

    # 결과 해석
    if pv >= alpha:
        results = (
            f"p값이 {pv:.5f}이므로 {alpha} 이상 → "
            f"성별에 따라 선호 브랜드에 차이가 없다 (귀무가설 채택){expected_note}"
        )
    else:
        results = (
            f"p값이 {pv:.5f}이므로 {alpha} 미만 → "
            f"성별에 따라 선호 브랜드에 차이가 있다 (대립가설 채택){expected_note}"
        )
    
    return crossTbl, results, df

def save_brand_barFunc(df, out_path):
    """커피 브랜드별 선호도 세로막대 차트 생성"""
    # 데이터 검증
    if df is None or df.empty or 'co_survey' not in df.columns:
        try:
            if os.path.exists(out_path):
                os.remove(out_path)
        except Exception:
            pass
        return False
    
    # 브랜드 순서 정의
    order = ['스타벅스', '커피빈', '이디야', '탐앤탐스']
    brand_counts = df['co_survey'].value_counts().reindex(order, fill_value=0)

    # 무지개 색상 적용
    cmap = plt.get_cmap('rainbow')
    n = len(brand_counts)
    colors = [cmap(i / max(n - 1, 1)) for i in range(n)]
    
    # 차트 생성
    fig = plt.figure(figsize=(10, 6))
    ax = brand_counts.plot(kind='bar', width=0.6, color=colors, edgecolor='black')
    ax.set_xlabel('커피사')
    ax.set_ylabel('선호 건수')
    ax.set_title('커피 브랜드 선호 건수')
    ax.set_xticklabels(order, rotation=0)
    
    # 막대 위에 값 표시
    for i, v in enumerate(brand_counts):
        ax.text(i, v + 0.1, str(v), ha='center', va='bottom')
    
    fig.tight_layout()
    
    # 이미지 저장 경로 디렉토리 생성
    os.makedirs(os.path.dirname(out_path), exist_ok=True)
    fig.savefig(out_path, dpi=120, bbox_inches='tight')
    plt.close(fig)
    
    return True

def surveyShow(request):
    """설문 결과 조회 페이지 (개별 구현 가능)"""
    pass
```

---

## 🎨 템플릿

### templates/index.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커피 선호도 조사</title>
</head>
<body>
    <h2>커피를 사랑하라</h2>
    
    <nav>
        <a href="{% url 'survey_form' %}">[커피 브랜드 선호 조사]</a>
        <a href="{% url 'survey_result' %}">[선호도 분석 결과]</a>
    </nav>
    
    <h1>Hello World</h1>
</body>
</html>
```

### templates/coffee/coffeesurvey.html (선생님 버전)
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Coffee Survey</title>
</head>
<body>
    <h3>* 커피 전문점에 대한 소비자 인식 조사 *</h3>
    
    <form action="/coffee/surveyprocess" method="post">
        {% csrf_token %}
        
        <table>
            <tr>
                <td>귀하의 성별은?</td>
                <td>
                    <label for="genM">남</label>
                    <input type="radio" id="genM" name="gender" value="남" checked>&nbsp;&nbsp;
                    <label for="genF">여</label>
                    <input type="radio" id="genF" name="gender" value="여">
                </td>
            </tr>
            <tr>
                <td>귀하의 나이는?</td>
                <td>
                    <label for="age10">10대</label>
                    <input type="radio" id="age10" name="age" value="10대" checked>&nbsp;&nbsp;
                    <label for="age20">20대</label>
                    <input type="radio" id="age20" name="age" value="20대">&nbsp;&nbsp;
                    <label for="age30">30대</label>
                    <input type="radio" id="age30" name="age" value="30대">&nbsp;&nbsp;
                    <label for="age40">40대</label>
                    <input type="radio" id="age40" name="age" value="40대">&nbsp;&nbsp;
                    <label for="age50">50대 이상</label>
                    <input type="radio" id="age50" name="age" value="50대 이상">
                </td>
            </tr>
            <tr>
                <td>선호하는 커피 전문점은?</td>
                <td>
                    <label for="starbucks">스타벅스</label>
                    <input type="radio" id="starbucks" name="co_survey" value="스타벅스" checked>&nbsp;&nbsp;
                    <label for="coffeebean">커피빈</label>
                    <input type="radio" id="coffeebean" name="co_survey" value="커피빈">&nbsp;&nbsp;
                    <label for="ediya">이디야</label>
                    <input type="radio" id="ediya" name="co_survey" value="이디야">&nbsp;&nbsp;
                    <label for="tomntoms">탐앤탐스</label>
                    <input type="radio" id="tomntoms" name="co_survey" value="탐앤탐스">
                </td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: center;">
                    <br>
                    <input type="submit" value="설문 완료">
                    <input type="reset" value="초기화">
                </td>
            </tr>
        </table>
    </form>
</body>
</html>
```

### templates/coffee/result.html (결과 출력 페이지)
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커피 설문조사 결과</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 40px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .result-text { font-size: 18px; font-weight: bold; color: #333; padding: 15px; background-color: #f9f9f9; border-radius: 5px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        .chart-container { text-align: center; margin: 20px 0; }
        .navigation { text-align: center; margin: 30px 0; }
        .navigation a { margin: 0 10px; padding: 10px 20px; background-color: #007bff; color: white; text-decoration: none; border-radius: 5px; }
        .navigation a:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 커피 브랜드 선호도 분석 결과</h1>
        
        <!-- 카이제곱 검정 결과 -->
        <div class="section">
            <h2>🧮 카이제곱 독립성 검정 결과</h2>
            <div class="result-text">
                {{ results|safe }}
            </div>
        </div>
        
        <!-- 교차분할표 -->
        <div class="section">
            <h2>📋 성별-커피브랜드 교차분할표</h2>
            {{ crossTbl|safe }}
        </div>
        
        <!-- 차트 영역 -->
        <div class="section">
            <h2>📈 커피 브랜드별 선호도 차트</h2>
            <div class="chart-container">
                {% load static %}
                <img src="{% static 'images/cobar.png' %}" alt="커피 브랜드 선호도 차트" style="max-width: 100%; height: auto;">
            </div>
        </div>
        
        <!-- 전체 데이터 -->
        <div class="section">
            <h2>📋 전체 설문 데이터</h2>
            {{ df|safe }}
        </div>
        
        <!-- 네비게이션 -->
        <div class="navigation">
            <a href="/">🏠 메인으로</a>
            <a href="/coffee/survey">📝 다시 설문하기</a>
        </div>
    </div>
</body>
</html>
```

### templates/coffee/survey_result.html
```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>설문 결과</title>
    <style>
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        .result-section { margin: 30px 0; padding: 20px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h2>커피 브랜드 선호도 분석 결과</h2>
    
    <!-- 카이제곱 검정 결과 -->
    <div class="result-section">
        <h3>🧮 카이제곱 독립성 검정 결과</h3>
        
        {% if decision %}
            <h4>검정 결론</h4>
            <p><strong>{{ decision }}</strong></p>
            
            {% if chi2 %}
                <p><strong>카이제곱 통계량:</strong> {{ chi2 }}</p>
                <p><strong>자유도:</strong> {{ dof }}</p>
                <p><strong>유의수준:</strong> {{ alpha }}</p>
            {% endif %}
        {% endif %}
    </div>
    
    <!-- 교차분할표 -->
    {% if crosstab %}
    <div class="result-section">
        <h3>📊 성별-커피브랜드 교차분할표</h3>
        
        <table>
            <thead>
                <tr>
                    {% for header in crosstab.headers %}
                        <th>{{ header }}</th>
                    {% endfor %}
                    <th>행 합계</th>
                </tr>
            </thead>
            <tbody>
                {% for row in crosstab.rows %}
                    <tr>
                        {% for cell in row %}
                            <td>{{ cell }}</td>
                        {% endfor %}
                        <td><strong>{{ crosstab.row_totals|slice:forloop.counter0 }}</strong></td>
                    </tr>
                {% endfor %}
                <tr>
                    <th>열 합계</th>
                    {% for col_total in crosstab.col_totals %}
                        <td><strong>{{ col_total }}</strong></td>
                    {% endfor %}
                    <td><strong>{{ crosstab.total }}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- 전체 설문 데이터 -->
    <div class="result-section">
        <h3>📋 전체 설문 데이터</h3>
        
        <table>
            <thead>
                <tr>
                    <th>번호</th>
                    <th>성별</th>
                    <th>나이대</th>
                    <th>선호 브랜드</th>
                </tr>
            </thead>
            <tbody>
                {% for survey in surveys %}
                <tr>
                    <td>{{ survey.rnum }}</td>
                    <td>{{ survey.gender }}</td>
                    <td>{{ survey.age }}대</td>
                    <td>{{ survey.co_survey }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div style="text-align: center; margin: 30px;">
        <a href="{% url 'survey_form' %}">[다시 설문하기]</a> |
        <a href="/">[메인으로]</a>
    </div>
</body>
</html>
```

---

## ⚙️ settings.py 설정

### 데이터베이스 설정
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'coffeedb',
        'USER': 'root',
        'PASSWORD': 'your_password',
        'HOST': 'localhost',
        'PORT': '3306',
    }
}

# 앱 등록
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'myapp',
]

# 한국어 설정
LANGUAGE_CODE = 'ko-kr'
TIME_ZONE = 'Asia/Seoul'
```

---

## 🚀 실행 방법

### 1. 프로젝트 실행
```bash
# 마이그레이션 (선택사항)
python manage.py makemigrations
python manage.py migrate

# 서버 실행
python manage.py runserver
```

### 2. 접속 URL
- **메인 페이지**: `http://127.0.0.1:8000/`
- **설문 입력**: `http://127.0.0.1:8000/coffee/survey`
- **결과 확인**: `http://127.0.0.1:8000/coffee/surveyshow`

---

## 📊 카이제곱 검정 이론

### 가설 설정
- **귀무가설 (H₀)**: 성별과 커피 브랜드 선호도는 서로 독립이다 (관련이 없다)
- **대립가설 (H₁)**: 성별과 커피 브랜드 선호도는 서로 독립이 아니다 (관련이 있다)

### 검정 통계량
```
χ² = Σ[(관측도수 - 기대도수)² / 기대도수]
```

### 자유도
```
df = (행의 개수 - 1) × (열의 개수 - 1)
```

### 판정 기준
- **α = 0.05** (유의수준 5%)
- **χ² > 임계값**: 귀무가설 기각 → 관련성 있음
- **χ² ≤ 임계값**: 귀무가설 채택 → 관련성 없음

---

## 🔧 추가 개선사항

### 1. 차트 생성 기능
```python
def create_chart(request):
    """커피브랜드별 선호도 세로막대 차트 생성"""
    import matplotlib.pyplot as plt
    import os
    from django.conf import settings
    
    # 브랜드별 집계
    brand_counts = Survey.objects.values('co_survey').annotate(count=Count('rnum'))
    
    brands = [item['co_survey'] for item in brand_counts]
    counts = [item['count'] for item in brand_counts]
    
    # 차트 생성
    plt.figure(figsize=(10, 6))
    plt.bar(brands, counts, color=['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'])
    plt.title('커피 브랜드별 선호도')
    plt.xlabel('커피 브랜드')
    plt.ylabel('선호 인원수')
    plt.xticks(rotation=45)
    
    # 이미지 저장
    chart_path = os.path.join(settings.STATIC_ROOT, 'chart.png')
    plt.savefig(chart_path, bbox_inches='tight')
    plt.close()
    
    return chart_path
```

### 2. 데이터 검증
```python
def validate_survey_data(gender, age, co_survey):
    """설문 데이터 유효성 검사"""
    errors = []
    
    if not gender or gender not in ['남', '여']:
        errors.append('올바른 성별을 선택해주세요.')
    
    if not age or int(age) not in [10, 20, 30, 40, 50]:
        errors.append('올바른 나이대를 선택해주세요.')
    
    valid_brands = ['스타벅스', '커피빈', '이디야', '탐앤탐스']
    if not co_survey or co_survey not in valid_brands:
        errors.append('올바른 커피 브랜드를 선택해주세요.')
    
    return errors
```

### 3. 통계 요약 정보
```python
def get_survey_statistics():
    """설문 통계 요약 정보"""
    total_count = Survey.objects.count()
    gender_stats = Survey.objects.values('gender').annotate(count=Count('rnum'))
    brand_stats = Survey.objects.values('co_survey').annotate(count=Count('rnum'))
    
    return {
        'total': total_count,
        'by_gender': gender_stats,
        'by_brand': brand_stats,
    }
```

---

## 🎯 학습 목표 달성

이 프로젝트를 통해 다음을 학습할 수 있습니다:

### ✅ Django 웹 개발
- 모델, 뷰, 템플릿 패턴 이해
- URL 라우팅 및 폼 처리
- 데이터베이스 연동

### ✅ 통계 분석
- 카이제곱 독립성 검정 이론 및 실습
- 교차분할표 생성 및 해석
- 가설 검정 과정 이해

### ✅ 데이터 시각화
- Matplotlib을 활용한 차트 생성
- 웹에서 통계 결과 표현

### ✅ 실무 응용
- 설문조사 시스템 구현
- 통계 분석 결과 웹 출력
- 사용자 인터페이스 설계

---

*이 문서는 Django와 통계학을 연결한 실무형 프로젝트 가이드입니다. 실제 마케팅 리서치나 데이터 분석 업무에 활용할 수 있는 기본 틀을 제공합니다.*