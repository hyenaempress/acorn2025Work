# 19번 - SQLite와 Pandas를 활용한 데이터 분석

## 📋 목차
1. [Local Database 연동](#local-database-연동)
2. [테이블 생성 및 데이터 삽입](#테이블-생성-및-데이터-삽입)
3. [Pandas DataFrame과 SQL 연동](#pandas-dataframe과-sql-연동)
4. [실습 예제](#실습-예제)
5. [보안 고려사항](#보안-고려사항)

---

## Local Database 연동

SQLite는 파일 기반의 경량 데이터베이스로, Python에서 기본적으로 지원됩니다.

```python
import sqlite3
import pandas as pd

# 메모리 DB 연결 (임시 저장)
conn = sqlite3.connect(':memory:')

# 파일 DB 연결 (영구 저장)
# conn = sqlite3.connect('test.db')
```

### 연결 방식의 차이점
- **`:memory:`**: 메모리에 임시 저장, 프로그램 종료 시 데이터 삭제
- **`파일명.db`**: 파일로 영구 저장, 재실행 시에도 데이터 유지

---

## 테이블 생성 및 데이터 삽입

### 1. 테이블 생성

```python
# 테이블 생성 SQL (실험용 4개 컬럼)
sql = """
CREATE TABLE IF NOT EXISTS test(
    product VARCHAR(10), 
    maker VARCHAR(10), 
    weight REAL, 
    price INTEGER
);
"""

conn.execute(sql)
conn.commit()
```

### 2. 단일 데이터 삽입

```python
# 🔒 보안을 위한 매개변수화 쿼리 사용
stmt = "INSERT INTO test VALUES(?, ?, ?, ?)"

# 데이터 준비 (튜플 형태)
data1 = ('mouse', 'samsung', 12.5, 5000)
data2 = ('mouse2', 'samsung', 15, 5000)

# 데이터 삽입
conn.execute(stmt, data1)
conn.execute(stmt, data2)
```

### 3. 다중 데이터 삽입

```python
# 여러 데이터를 리스트로 준비
datas = [
    ('mouse3', 'lg', 22.5, 5000), 
    ('mouse4', 'lg', 18.5, 5000)
]

# 한 번에 여러 데이터 삽입
conn.executemany(stmt, datas)
```

---

## Pandas DataFrame과 SQL 연동

### 1. SQL → DataFrame

#### 방법 1: 직접 변환
```python
# 데이터 조회
cursor = conn.cursor()
cursor.execute("SELECT * FROM test")
rows = cursor.fetchall()

# DataFrame으로 변환
df = pd.DataFrame(rows, columns=['product', 'maker', 'weight', 'price'])
print(df)
```

#### 방법 2: pandas.read_sql 사용 ⭐
```python
# 한 번에 DataFrame으로 읽기
df2 = pd.read_sql("SELECT * FROM test", conn)
print(df2)
```

### 2. DataFrame → SQL

```python
# 새로운 데이터 생성
pdata = {
    'product': ['연필', '볼펜', '지우개'],
    'maker': ['모나미', '모나미', '모나미'],
    'weight': [10, 20, 30],
    'price': [1000, 2000, 3000]
}

frame = pd.DataFrame(pdata)

# DataFrame을 테이블에 삽입
frame.to_sql('test', conn, if_exists='append', index=False)
```

### to_sql 옵션
- **`if_exists='append'`**: 기존 테이블에 추가
- **`if_exists='replace'`**: 테이블을 새로 생성
- **`if_exists='fail'`**: 테이블이 존재하면 오류 발생
- **`index=False`**: DataFrame의 인덱스를 테이블에 포함하지 않음

---

## 실습 예제

### 전체 코드

```python
import sqlite3
import pandas as pd

# 1. 데이터베이스 연결
conn = sqlite3.connect(':memory:')

# 2. 테이블 생성
sql = "CREATE TABLE IF NOT EXISTS test(product VARCHAR(10), maker VARCHAR(10), weight REAL, price INTEGER);"
conn.execute(sql)
conn.commit()

# 3. 데이터 삽입
stmt = "INSERT INTO test VALUES(?, ?, ?, ?)"

# 단일 데이터
data1 = ('mouse', 'samsung', 12.5, 5000)
data2 = ('mouse2', 'samsung', 15, 5000)
conn.execute(stmt, data1)
conn.execute(stmt, data2)

# 다중 데이터
datas = [('mouse3', 'lg', 22.5, 5000), ('mouse4', 'lg', 18.5, 5000)]
conn.executemany(stmt, datas)

# 4. 데이터 조회 및 DataFrame 변환
cursor = conn.cursor()
cursor.execute("SELECT * FROM test")
rows = cursor.fetchall()

# 직접 변환
df = pd.DataFrame(rows, columns=['product', 'maker', 'weight', 'price'])
print("📊 직접 변환한 DataFrame:")
print(df)

# pandas.read_sql 사용
df2 = pd.read_sql("SELECT * FROM test", conn)
print("\n📊 read_sql로 읽은 DataFrame:")
print(df2)

# 5. DataFrame을 테이블에 저장
pdata = {
    'product': ['연필', '볼펜', '지우개'],
    'maker': ['모나미', '모나미', '모나미'],
    'weight': [10, 20, 30],
    'price': [1000, 2000, 3000]
}

frame = pd.DataFrame(pdata)
frame.to_sql('test', conn, if_exists='append', index=False)

# 6. 최종 결과 확인
df3 = pd.read_sql("SELECT * FROM test", conn)
print("\n💾 test 테이블의 전체 내용:")
print(df3)

# 7. 리소스 정리
cursor.close()
conn.close()
```

### 실행 결과 예시

```
📊 직접 변환한 DataFrame:
  product    maker  weight  price
0   mouse  samsung    12.5   5000
1  mouse2  samsung    15.0   5000
2  mouse3       lg    22.5   5000
3  mouse4       lg    18.5   5000

📊 read_sql로 읽은 DataFrame:
  product    maker  weight  price
0   mouse  samsung    12.5   5000
1  mouse2  samsung    15.0   5000
2  mouse3       lg    22.5   5000
3  mouse4       lg    18.5   5000

💾 test 테이블의 전체 내용:
  product    maker  weight  price
0   mouse  samsung    12.5   5000
1  mouse2  samsung    15.0   5000
2  mouse3       lg    22.5   5000
3  mouse4       lg    18.5   5000
4      연필      모나미    10.0   1000
5      볼펜      모나미    20.0   2000
6     지우개      모나미    30.0   3000
```

---

## 보안 고려사항

### ⚠️ SQL Injection 방지

**❌ 잘못된 방법**
```python
# 직접 문자열 삽입 (보안 위험!)
query = f"INSERT INTO test VALUES('{product}', '{maker}', {weight}, {price})"
```

**✅ 올바른 방법**
```python
# 매개변수화 쿼리 사용
stmt = "INSERT INTO test VALUES(?, ?, ?, ?)"
conn.execute(stmt, (product, maker, weight, price))
```

### 중요 포인트
- **물음표(?) 플레이스홀더** 사용으로 SQL Injection 방지
- **시큐어 코딩 가이드라인** 준수
- **매개변수 바인딩**을 통한 안전한 데이터 처리

---

## 추가 활용 방안

### 1. HTML 출력
```python
# DataFrame을 HTML로 변환 (Django 등에서 활용)
html_output = df.to_html()
print(html_output)
```

### 2. 조건부 쿼리
```python
# 특정 조건으로 데이터 필터링
filtered_df = pd.read_sql(
    "SELECT * FROM test WHERE maker = 'samsung'", 
    conn
)
```

### 3. 집계 함수 활용
```python
# 제조사별 평균 가격
avg_price = pd.read_sql(
    "SELECT maker, AVG(price) as avg_price FROM test GROUP BY maker", 
    conn
)
```

---

## 🚨 강의에서 강조한 중요 체크 포인트

### 1. **튜플 데이터 작성 시 주의사항** ⚠️
```python
# ❌ 잘못된 방법 - 튜플이 아님!
data = (4)  # 이건 그냥 숫자 4

# ✅ 올바른 방법 - 꼭 쉼표를 찍어야 함!
data = (4,)  # 이제야 튜플!

# 실제 사용
data1 = ('mouse', 'samsung', 12.5, 5000)  # 올바른 튜플
```

**💡 핵심**: "데이터가 하나일 때는 꼭 콤마를 찍어 줘야 돼. 파이썬에서 실수하는 경우가 되게 많다"

### 2. **보안 코딩 - 매개변수화 쿼리 필수** 🔒
```python
# ❌ 위험한 방법 (SQL Injection 취약)
query = f"INSERT INTO test VALUES('{product}', '{maker}', {weight}, {price})"

# ✅ 안전한 방법 (매개변수화 쿼리)
stmt = "INSERT INTO test VALUES(?, ?, ?, ?)"
conn.execute(stmt, data)
```

**💡 핵심**: "물음표를 써서 매핑을 해야지. 문자열 더하기로 집어넣으면 시큐어 코딩에 위배되는 거야. 가이드라인에 걸린다."

### 3. **메모리 DB vs 파일 DB 구분** 💾
```python
# 실험용 - 메모리에만 존재 (프로그램 종료시 삭제)
conn = sqlite3.connect(':memory:')

# 영구 저장용 - 파일로 저장
conn = sqlite3.connect('test.db')  # test.db 파일이 생성됨
```

**💡 핵심**: "메모리는 실험용이다. 매번 실행할 때마다 테이블이 다시 만들어지면서 램에서만 존재"

### 4. **pandas.read_sql()의 강력함** ⭐
```python
# 직접 변환 (번거로운 방법)
cursor = conn.cursor()
cursor.execute("SELECT * FROM test")
rows = cursor.fetchall()
df = pd.DataFrame(rows, columns=['product', 'maker', 'weight', 'price'])

# pandas로 한 번에! (권장 방법)
df2 = pd.read_sql("SELECT * FROM test", conn)
```

**💡 핵심**: "굳이 패치올까지 할 필요가 없어요. 판다스는 정말 훌륭하죠. 바로 데이터 프레임으로 만들어지는 거죠!"

### 5. **DataFrame.to_sql() 활용** 🔄
```python
# DataFrame을 데이터베이스로!
frame.to_sql('test', conn, if_exists='append', index=False)
```

**to_sql 중요 옵션들**:
- **`if_exists='append'`**: 기존 테이블에 추가
- **`index=False`**: DataFrame 인덱스는 제외하고 저장

**💡 핵심**: "꺼꾸로 데이터 프레임에 있는 내용을 DB에 저장할 수 있어야 되겠죠?"

### 6. **try-except 예외 처리의 중요성** 🛡️
```python
# 실무에서는 반드시 필요!
try:
    conn.execute(stmt, data)
    conn.commit()
except sqlite3.Error as e:
    print(f"데이터베이스 오류: {e}")
    conn.rollback()
finally:
    cursor.close()
    conn.close()
```

**💡 핵심**: "DB 처리, 네트워크 처리, 파일 처리 이런 것들은 꼭 try-except 문장을 써 줘야 돼요"

### 7. **HTML 출력으로 웹 연동** 🌐
```python
# Django 등 웹 프레임워크에서 활용
html_output = df.to_html()
print(html_output)  # HTML 테이블로 변환
```

**💡 핵심**: "HTML로 보낼 수 있음. 장고 이런데서 사용"

---

## 💡 핵심 정리

1. **SQLite**는 Python에서 기본 지원하는 경량 데이터베이스
2. **메모리 DB**는 임시 실험용, **파일 DB**는 영구 저장용
3. **매개변수화 쿼리(?)**로 보안 강화 - **시큐어 코딩 필수!**
4. **튜플 작성시 쉼표(,) 주의** - 파이썬 실수 빈발 지점
5. **pandas.read_sql()**로 간편한 DataFrame 변환
6. **DataFrame.to_sql()**로 역방향 데이터 저장
7. 실무에서는 **try-except** 문으로 예외 처리 필수
8. **HTML 변환**으로 웹 서비스 연동 가능

이 방법을 통해 SQL과 Pandas를 효과적으로 연동하여 데이터 분석 작업을 수행할 수 있습니다!