# 19.02 마리아DB 연결 - SQL 표준을 따르는 관계형 데이터베이스

## 📋 목차
1. [마리아DB를 선택하는 이유](#마리아db를-선택하는-이유)
2. [환경 설정 및 모듈 설치](#환경-설정-및-모듈-설치)
3. [연결 설정과 보안](#연결-설정과-보안)
4. [데이터베이스 연결 실습](#데이터베이스-연결-실습)
5. [데이터 조회 및 DataFrame 변환](#데이터-조회-및-dataframe-변환)
6. [PostgreSQL과의 비교](#postgresql과의-비교)

---

## 마리아DB를 선택하는 이유

### 🎯 핵심 이유
- **SQL 표준 준수**: 마리아DB는 표준 SQL을 완벽하게 지원합니다
- **관계형 데이터베이스**: ACID 속성을 완벽하게 지원하는 관계형 DB
- **MySQL 호환성**: MySQL과 완벽 호환되면서도 더 많은 기능 제공
- **리눅스 표준**: 리눅스의 표준 데이터베이스가 마리아DB입니다
- **오픈소스**: 무료로 사용 가능한 강력한 데이터베이스

### 다른 데이터베이스와 비교
```python
print("🗄️ 관계형 데이터베이스 비교:")
print("├── MariaDB: MySQL 호환, SQL 표준 준수, 리눅스 표준 DB")
print("├── PostgreSQL: 객체-관계형, 확장성 우수, 복잡한 쿼리 지원")  
print("├── MySQL: 가장 널리 사용, 웹 애플리케이션에 최적화")
print("├── Oracle: 엔터프라이즈급, SQLP 자격증 시험 대상")
print("└── SQLite: 파일 기반, 경량, 임베디드 용도")

print("\n💡 강사님 팁:")
print("- Oracle도 좀 써봐야 해요 (SQLP 시험 대비)")
print("- PostgreSQL도 요즘 많이 쓰는 녀석이거든요")
print("- 나중에 PostgreSQL도 설치해서 연결해보면 좋습니다")
```

---

## 환경 설정 및 모듈 설치

### 1. 필요 모듈 설치

```bash
# 아나콘다 프롬프트에서 실행
pip install MySQLClient
```

**설치 후 확인되는 폴더들**:
- MySQLClient 라이브러리
- 관련 의존성 패키지들

### 2. 기본 라이브러리 import

```python
# 강사님이 피클을 좋아하셔서 피클로 하지만 다른 방법 써도 됩니다
import MySQLdb
import pickle
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import sys

# 한글 깨짐 방지 설정
plt.rcParams['font.family'] = 'Malgun Gothic'
plt.rcParams['axes.unicode_minus'] = False
```

---

## 연결 설정과 보안

### 1. 설정 정보 딕셔너리로 관리

```python
# 데이터베이스 연결 설정
config = {
    'host': '127.0.0.1',      # localhost
    'user': 'root',           # 사용자명
    'password': '970506',     # 비밀번호 (실제로는 보안 처리 필요)
    'db': 'mydb',            # 데이터베이스명
    'port': 3306,            # 마리아DB 기본 포트
    'charset': 'utf8'        # 문자 인코딩
}

print("✅ 데이터베이스 설정 완료")
print(f"호스트: {config['host']}")
print(f"포트: {config['port']}")
print(f"데이터베이스: {config['db']}")
```

### 2. 설정 정보 파일로 저장 (보안을 위해)

```python
# 설정을 pickle 파일로 저장 (강사님이 피클을 좋아하시는 이유!)
with open('mymaria.dat', 'wb') as obj:
    pickle.dump(config, obj)

print("🔐 mymaria.dat 파일이 생성되었습니다.")
print("💡 실제 운영환경에서는 환경변수나 설정 파일을 사용하세요!")

# 🎯 강사님의 네이밍 센스!
print("📚 재미있는 사실:")
print("- 'mymaria': 마리아DB를 만든 개발자들의 첫째 딸 이름이 Maria입니다")
print("- MariaDB 자체가 MySQL의 창시자가 딸 이름을 따서 만든 DB에요!")
```

### 🚨 보안 주의사항
```python
print("🚨 보안 가이드라인:")
print("❌ 코드에 직접 비밀번호 작성 금지")
print("✅ 환경변수 사용: os.environ['DB_PASSWORD']")
print("✅ 설정 파일 사용: config.ini, .env 파일")
print("✅ 버전 관리에서 제외: .gitignore에 추가")
```

---

## 데이터베이스 연결 실습

### 1. 설정 파일 읽기와 예외 처리

```python
# 안전한 설정 파일 읽기
try:
    with open('mymaria.dat', mode='rb') as obj:
        config = pickle.load(obj)
    print("📂 설정 파일 로딩 성공:")
    print(config)
except Exception as e:
    print('❌ 설정 파일 로딩 실패:', e)
    sys.exit(0)
```

### 2. 데이터베이스 연결

```python
# 방법 1: 직접 연결 (비추천)
"""
conn = MySQLdb.connect(host='127.0.0.1',
                      user='root', 
                      password='970506',
                      db='mydb',
                      port=3306,
                      charset='utf8')
"""

# 방법 2: 딕셔너리 언팩킹 (권장) ⭐
try:
    conn = MySQLdb.connect(**config)  # 딕셔너리 언팩킹
    print("✅ 마리아DB 연결 성공!")
    
except Exception as e:
    print('❌ 데이터베이스 연결 실패:', e)
    sys.exit(0)
```

### 🔑 딕셔너리 언팩킹 이해
```python
print("💡 딕셔너리 언팩킹(**) 설명:")
print("config = {'a': 1, 'b': 2}")
print("func(**config) == func(a=1, b=2)")
print()
print("✅ 장점:")
print("  - 코드 간소화")
print("  - 설정 관리 용이")
print("  - 매개변수 변경 시 유연성")
```

---

## 데이터 조회 및 DataFrame 변환

### 1. 기본 SQL 쿼리 실행

```python
# 간단한 조회 쿼리
sql_basic = "SELECT jikwonno, jikwonname FROM jikwon"

# 복잡한 조회 쿼리 (가독성을 위해 여러 줄)
sql_advanced = """
SELECT jikwonno, jikwonname, buser_num, jikwon_pay
FROM jikwon 
WHERE jikwon_pay >= 1000000
ORDER BY jikwon_pay DESC
"""

print("📝 실행할 SQL:")
print(sql_advanced)
```

### 2. 세 가지 출력 방법 비교

```python
try:
    cursor = conn.cursor()
    cursor.execute(sql_advanced)
    
    print("=" * 60)
    
    # 📊 출력 방법 1: 커서 직접 순회
    print("1️⃣ 커서 직접 순회:")
    print("-" * 40)
    for (jikwonno, jikwonname, buser_num, jikwon_pay) in cursor:
        print(f"사번: {jikwonno}, 이름: {jikwonname}, 부서: {buser_num}, 급여: {jikwon_pay:,}")
    
    print("\n" + "=" * 60)
    
    # 🔄 커서를 다시 실행 (이미 소모되었으므로)
    cursor.execute(sql_advanced)
    
    # 📊 출력 방법 2: fetchall() + DataFrame 생성 (수동 제어)
    print("2️⃣ fetchall() + DataFrame:")
    print("-" * 40)
    df1 = pd.DataFrame(cursor.fetchall(),
                      columns=['jikwonno', 'jikwonname', 'buser_num', 'jikwon_pay'])
    print(df1.head(3))
    
    print("\n" + "=" * 60)
    
    # 📊 출력 방법 3: pandas.read_sql() (가장 권장) ⭐
    print("3️⃣ pandas.read_sql() (최고 권장!):")
    print("-" * 40)
    df2 = pd.read_sql(sql_advanced, conn)
    print(df2.head(3))
    
    # 📈 DataFrame 기본 정보
    print(f"\n📊 조회 결과: {len(df2)}건")
    print(f"💰 평균 급여: {df2['jikwon_pay'].mean():,.0f}원")
    print(f"💰 최고 급여: {df2['jikwon_pay'].max():,.0f}원")

except Exception as e:
    print('❌ 쿼리 실행 오류:', e)
    
finally:
    # 🧹 리소스 정리 (중요!)
    if 'cursor' in locals():
        cursor.close()
        print("🗑️ 커서 해제 완료")
    
    if 'conn' in locals():
        conn.close() 
        print("🔌 데이터베이스 연결 해제 완료")
```

### 3. 출력 방법별 특징 비교

```python
print("🔍 출력 방법 비교:")
print("=" * 50)
print("1️⃣ 커서 직접 순회:")
print("   ✅ 메모리 효율적 (한 행씩 처리)")
print("   ✅ 대용량 데이터에 적합")
print("   ❌ pandas 기능 활용 불가")
print()
print("2️⃣ fetchall() + DataFrame:")
print("   ✅ 수동 제어 가능")
print("   ❌ 코드가 복잡")
print("   ❌ 컬럼명 수동 지정 필요")
print()
print("3️⃣ pandas.read_sql() ⭐:")
print("   ✅ 한 번에 DataFrame 생성")
print("   ✅ 컬럼명 자동 설정")
print("   ✅ 코드 간소화")
print("   ✅ 데이터 분석에 최적")
print("   ❌ 대용량 데이터시 메모리 부담")
```

---

## PostgreSQL과의 비교

### 🐘 PostgreSQL 소개
```python
print("🔍 PostgreSQL vs MariaDB:")
print("=" * 40)
print("📊 PostgreSQL:")
print("✅ 객체-관계형 데이터베이스")
print("✅ 고급 데이터 타입 지원 (JSON, Array 등)")
print("✅ 복잡한 쿼리 성능 우수")
print("✅ 확장성과 표준 준수")
print("✅ 대기업과 복잡한 애플리케이션에 선호")
print()
print("📊 MariaDB:")
print("✅ MySQL 완벽 호환")
print("✅ 웹 애플리케이션에 최적화")
print("✅ 간단한 설치와 설정")
print("✅ 빠른 읽기 성능")
print("✅ 중소규모 프로젝트에 적합")
```

### PostgreSQL 연결 예제 (참고용)
```python
# PostgreSQL 연결 예제 (psycopg2 사용)
"""
import psycopg2
import pandas as pd

# PostgreSQL 설정
pg_config = {
    'host': 'localhost',
    'database': 'mydb',
    'user': 'postgres',
    'password': 'password',
    'port': 5432
}

# 연결
conn = psycopg2.connect(**pg_config)

# 데이터 조회
df = pd.read_sql("SELECT * FROM employees", conn)
conn.close()
"""
print("💡 PostgreSQL도 나중에 설치해서 연결해보는 것을 추천합니다!")
```

---

## 🎯 실전 활용 예제

### 1. 동적 쿼리 생성

```python
def get_employee_data(min_salary=None, department=None, limit=10):
    """
    조건에 따른 동적 쿼리 생성
    """
    base_query = "SELECT * FROM jikwon WHERE 1=1"
    params = []
    
    if min_salary:
        base_query += " AND jikwon_pay >= %s"
        params.append(min_salary)
    
    if department:
        base_query += " AND buser_num = %s"  
        params.append(department)
    
    base_query += " ORDER BY jikwon_pay DESC LIMIT %s"
    params.append(limit)
    
    return base_query, params

# 사용 예제
query, params = get_employee_data(min_salary=1500000, department=10, limit=5)
print("🔍 생성된 쿼리:")
print(query)
print("📝 매개변수:", params)
```

### 2. 트랜잭션 처리

```python
def safe_data_update():
    """
    안전한 데이터 업데이트 (트랜잭션 사용)
    """
    conn = None
    try:
        conn = MySQLdb.connect(**config)
        conn.autocommit(False)  # 자동 커밋 비활성화
        
        cursor = conn.cursor()
        
        # 여러 작업 수행
        cursor.execute("UPDATE jikwon SET jikwon_pay = jikwon_pay * 1.1 WHERE buser_num = 10")
        cursor.execute("INSERT INTO salary_log VALUES (NOW(), '급여 인상 완료')")
        
        conn.commit()  # 모든 작업 성공시 커밋
        print("✅ 급여 업데이트 성공")
        
    except Exception as e:
        if conn:
            conn.rollback()  # 오류시 롤백
        print(f"❌ 업데이트 실패: {e}")
        
    finally:
        if conn:
            conn.close()

print("💡 트랜잭션 사용으로 데이터 무결성 보장!")
```

---

## 🚨 강의에서 강조한 핵심 포인트

### 🎯 **강사님이 특히 강조한 내용들**

#### 1. **피클(Pickle) 사용 이유** 🥒
```python
print("💡 강사님의 피클 사랑:")
print("- '저는 피클을 좋아하기 때문에 피클로 하는 거야'")
print("- '꼭 피클로 하는 건 아니에요. 다른 방법 써도 괜찮아요'")
print("- '피클은 파이썬 객체를 그대로 저장할 수 있어서 편리해요'")
print()
print("🔧 피클 사용법:")
print("저장: pickle.dump(객체, 파일)")
print("읽기: pickle.load(파일)")
```

#### 2. **딕셔너리 언팩킹의 중요성** ⭐
```python
print("🔑 딕셔너리 언팩킹 핵심:")
print("conn = MySQLdb.connect(**config)")
print("↑ 이게 바로 딕셔너리 언팩킹!")
print()
print("📖 언팩킹 원리:")
print("config = {'host': '127.0.0.1', 'user': 'root'}")
print("**config → host='127.0.0.1', user='root' 형태로 전개")
```

#### 3. **보안의 중요성** 🔒
```python
print("🚨 강사님의 보안 강조:")
print("- '이거 노출되잖아, 노출되죠? 이거 별도 파일로 만들어야 해'")
print("- '보안에 뻥 뚫리잖아 이렇게 안 하고'")
print("- '연결 정보가 소스 속에 들어 있으면 안 되잖아요'")
```

#### 4. **SQL 가독성** 📚
```python
print("📝 가독성 좋은 SQL 작성법:")
sql = """
SELECT jikwonno, jikwonname, buser_num, jikwon_pay
FROM jikwon 
WHERE jikwon_pay >= 1000000
ORDER BY jikwon_pay DESC
"""
print("💡 강사님: '가독성이 좋을려면 이 방법이 좋습니다'")
```

#### 5. **리소스 관리의 중요성** 🧹
```python
print("🧹 강사님의 리소스 관리 철학:")
print("- 커서 사용 후 → cursor.close()")
print("- 연결 사용 후 → conn.close()")  
print("- '쓸모없어짐' → 반드시 정리하기")
```

### 6. **데이터베이스 선택 기준** 🎯
```python
print("🗄️ 강사님의 DB 선택 가이드:")
print("🔹 MariaDB: 리눅스 표준, SQL 표준 준수")
print("🔹 PostgreSQL: '요즘 많이 쓰는 녀석이거든요'")
print("🔹 Oracle: 'SQLP 시험 보는 사람들은 오라클도 좀 써봐야 해'")
print("🔹 MySQL: 웹 개발의 전통적 선택")
```

### 1. **연결 방법** ⭐
```python
# ✅ 권장: 딕셔너리 언팩킹
conn = MySQLdb.connect(**config)

# ❌ 비권장: 직접 매개변수 전달  
conn = MySQLdb.connect(host='...', user='...', ...)
```

### 2. **데이터 조회 최고의 방법** 🏆
```python
# 🥇 최고 권장: pandas.read_sql()
df = pd.read_sql(sql, conn)

# 🥈 대용량 데이터: 커서 순회
for row in cursor:
    process(row)
```

### 3. **보안 고려사항** 🔐
```python
# ❌ 절대 금지: 코드에 비밀번호
password = "123456"

# ✅ 권장: 환경변수 사용
import os
password = os.environ.get('DB_PASSWORD')
```

### 4. **리소스 정리** 🧹
```python
# 반드시 필요한 정리 작업
try:
    # DB 작업
    pass
finally:
    cursor.close()   # 커서 해제
    conn.close()     # 연결 해제
```

### 5. **예외 처리** 🛡️
```python
try:
    conn = MySQLdb.connect(**config)
    # DB 작업 수행
except MySQLdb.Error as e:
    print(f"DB 오류: {e}")
except Exception as e:
    print(f"일반 오류: {e}")
```

---

## 🎉 마무리: 다음 단계로

### ✅ 이제 할 수 있는 것들
- **마리아DB 연결** 및 기본 조작
- **pandas와 연동**한 데이터 분석
- **안전한 연결 관리**와 예외 처리
- **SQL 쿼리**를 DataFrame으로 변환

### 🚀 다음 학습 방향
1. **복잡한 SQL 쿼리** 작성 연습
2. **PostgreSQL 설치** 및 연결 실습  
3. **대용량 데이터** 처리 기법
4. **데이터베이스 설계**와 정규화
5. **웹 애플리케이션**과 DB 연동

### 💡 실무 팁
```python
print("💼 실무에서의 활용:")
print("🔗 Flask/Django와 연동하여 웹 서비스 개발")
print("📊 비즈니스 인텔리전스 대시보드 구축")  
print("🤖 머신러닝 모델을 위한 데이터 준비")
print("📈 실시간 데이터 분석 및 리포팅")
print("🔄 ETL 파이프라인 구축")
```

**관계형 데이터베이스의 세계에 오신 것을 환영합니다! 이제 SQL 표준을 마스터하여 어떤 데이터베이스든 자유자재로 다룰 수 있습니다!** 🎯