# Django 연결 및 구성 완벽 가이드

## 목차
1. [Django 프로젝트 구조](#django-프로젝트-구조)
2. [프로젝트 생성 및 초기 설정](#프로젝트-생성-및-초기-설정)
3. [Django의 요청-응답 흐름](#django의-요청-응답-흐름)
4. [설정 파일 구성](#설정-파일-구성)
5. [URL 라우팅](#url-라우팅)
6. [뷰 함수 구현](#뷰-함수-구현)
7. [템플릿 구성](#템플릿-구성)
8. [데이터 시각화 연동](#데이터-시각화-연동)
9. [주요 명령어](#주요-명령어)
10. [강의 핵심 포인트](#강의-핵심-포인트)

---

## Django 프로젝트 구조

### 기본 디렉토리 구조
```
django1/
├── manage.py              # Django 관리 명령어 실행 파일
├── mainapp/              # 메인 프로젝트 (루트 앱)
│   ├── __init__.py
│   ├── settings.py       # 전체 프로젝트 설정
│   ├── urls.py          # 메인 URL 라우팅
│   ├── wsgi.py          # WSGI 애플리케이션
│   └── asgi.py          # ASGI 애플리케이션
├── myapp/               # 생성한 앱
│   ├── __init__.py
│   ├── views.py         # 뷰 함수들
│   ├── models.py        # 데이터 모델
│   ├── admin.py         # 관리자 설정
│   ├── apps.py          # 앱 설정
│   ├── tests.py         # 테스트 코드
│   └── migrations/      # 데이터베이스 마이그레이션
├── templates/           # 템플릿 폴더
│   ├── main.html
│   └── showdata.html
├── static/             # 정적 파일 폴더
│   ├── css/
│   ├── js/
│   └── images/
└── db.sqlite3          # SQLite 데이터베이스
```

---

## 프로젝트 생성 및 초기 설정

### 1. Django 프로젝트 생성
```bash
# 디렉토리 생성 및 이동
mkdir django1
cd django1

# Django 프로젝트 생성
django-admin startproject mainapp .
```

### 2. Django 앱 생성
```bash
# myapp 앱 생성
python manage.py startapp myapp
```

### 3. 필요한 폴더 생성
```bash
# 템플릿 폴더 생성
mkdir templates

# 정적 파일 폴더 생성
mkdir static
mkdir static/css
mkdir static/js
mkdir static/images
```

---

## Django의 요청-응답 흐름

```
사용자 요청 → URL 라우팅 → 뷰 함수 → 템플릿 렌더링 → 응답
     ↓            ↓           ↓            ↓           ↓
http://localhost:8000/showdata/
     ↓            ↓           ↓            ↓           ↓
   브라우저    urls.py    views.py    templates/   HTML 응답
```

### 상세 흐름 설명
1. **사용자 요청**: 브라우저에서 URL 요청
2. **URL 라우팅**: `urls.py`에서 URL 패턴 매칭
3. **뷰 함수 실행**: 해당하는 `views.py`의 함수 실행
4. **데이터 처리**: 필요시 모델에서 데이터 조회/처리
5. **템플릿 렌더링**: HTML 템플릿에 데이터 삽입
6. **응답 반환**: 완성된 HTML을 브라우저에 전송

---

## 설정 파일 구성

### settings.py 핵심 설정

```python
"""
Django settings for mainapp project.

Generated by 'django-admin startproject' using Django 5.2.4.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""

from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-!fq(&t@io%a9@zvkjp_^dbf3268kt4*0cy3lu$k9^in81bsnt@'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []

# Application definition
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'myapp',  # 새로 생성한 앱 등록 ⭐
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'mainapp.urls'

# 템플릿 설정 ⭐
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],  # 템플릿 디렉토리 추가
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'mainapp.wsgi.application'

# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators
AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/
LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'UTC'
USE_I18N = True
USE_TZ = True

# Static files (CSS, JavaScript, Images) ⭐
# https://docs.djangoproject.com/en/5.2/howto/static-files/
STATIC_URL = 'static/'
STATICFILES_DIRS = [BASE_DIR / 'static']  # 개발용 정적 파일 디렉토리

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'
```

---

## URL 라우팅

### mainapp/urls.py (메인 URL 설정)

```python
"""
URL configuration for mainapp project.

The `urlpatterns` list routes URLs to views. For more information please see:
    https://docs.djangoproject.com/en/5.2/topics/http/urls/
Examples:
Function views
    1. Add an import:  from my_app import views
    2. Add a URL to urlpatterns:  path('', views.home, name='home')
Class-based views
    1. Add an import:  from other_app.views import Home
    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')
Including another URLconf
    1. Import the include() function: from django.urls import include, path
    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
"""
from django.contrib import admin
from django.urls import path
from myapp import views  # myapp의 views 모듈 import

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', views.main, name='main'),              # 루트 경로 → main 뷰
    path('showdata/', views.showdata, name='showdata'),  # showdata 경로
]
```

### URL 패턴 설명
- `path('', views.main, name='main')`: 루트 URL (/) 접속 시 `views.main` 함수 호출
- `path('showdata/', views.showdata, name='showdata')`: `/showdata/` 접속 시 `views.showdata` 함수 호출
- `name` 매개변수: 템플릿에서 `{% url 'main' %}` 형태로 역참조 가능

---

## 뷰 함수 구현

### myapp/views.py

```python
from django.shortcuts import render
from django.conf import settings
from pathlib import Path
import matplotlib
matplotlib.use('Agg')  # GUI 없이 파일로 그리기
import matplotlib.pyplot as plt
import pandas as pd

def main(request):
    """메인 페이지를 렌더링하는 뷰"""
    return render(request, 'main.html')

def showdata(request):
    """아이리스 데이터 분석 및 시각화 뷰"""
    
    # 1. 데이터 로딩 (seaborn 실패 시 sklearn으로 대체)
    try:
        import seaborn as sns
        df = sns.load_dataset('iris')
    except Exception:
        from sklearn.datasets import load_iris
        iris = load_iris(as_frame=True)
        df = iris.frame.rename(columns={
            'sepal length (cm)': 'sepal_length',
            'sepal width (cm)': 'sepal_width',
            'petal length (cm)': 'petal_length',
            'petal width (cm)': 'petal_width'
        })
        df['species'] = df['target'].map(dict(enumerate(iris.target_names)))
        df = df.drop(columns=['target'])

    # 2. 이미지 저장 경로 준비: <BASE_DIR>/static/images/iris.png
    static_img_dir = Path(settings.BASE_DIR) / 'static' / 'images'
    static_img_dir.mkdir(parents=True, exist_ok=True)
    img_path = static_img_dir / 'iris.png'

    # 3. 파이차트 그려서 파일 저장
    counts = df['species'].value_counts().sort_index()
    plt.figure()
    counts.plot(kind='pie', autopct='%1.1f%%', startangle=90, ylabel='')
    plt.title('iris species counts')
    plt.axis('equal')
    plt.tight_layout()
    plt.savefig(img_path, dpi=150)
    plt.close()

    # 4. 테이블 HTML 생성 (여기서 옵션 다 줘서 '문자열'로 완성)
    table_html = df.to_html(classes='table table-striped table-sm', index=False)

    # 5. 템플릿에 데이터 전달
    return render(request, 'showdata.html', {
        'table': table_html,           # 문자열 그대로 전달
        'img_relpath': 'images/iris.png'
    })
```

### 뷰 함수 핵심 포인트

1. **matplotlib 웹 출력 설정**
   ```python
   matplotlib.use('Agg')  # GUI 없이 파일로 저장
   ```

2. **정적 파일 경로 생성**
   ```python
   static_img_dir = Path(settings.BASE_DIR) / 'static' / 'images'
   static_img_dir.mkdir(parents=True, exist_ok=True)
   ```

3. **DataFrame을 HTML로 변환**
   ```python
   table_html = df.to_html(classes='table table-striped table-sm', index=False)
   ```

4. **템플릿에 컨텍스트 전달**
   ```python
   return render(request, 'showdata.html', {
       'table': table_html,
       'img_relpath': 'images/iris.png'
   })
   ```

---

## 템플릿 구성

### templates/main.html

```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메인 페이지</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <header>
        <h1>메인</h1>
    </header>
    
    <main>
        <p>아이리스 데이터 보기</p>
        <p><a href="{% url 'showdata' %}">차트 보기</a></p>
    </main>
</body>
</html>
```

### templates/showdata.html

```html
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아이리스 데이터 분석</title>
    {% load static %}
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <header>
            <h1 class="mb-4">아이리스 데이터 분석 결과</h1>
        </header>
        
        <main>
            <!-- 차트 표시 영역 -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <h3>종별 분포 차트</h3>
                    <img src="{% static img_relpath %}" 
                         class="img-fluid border rounded" 
                         alt="아이리스 분포 차트">
                </div>
            </div>
            
            <!-- 데이터 테이블 -->
            <div class="row">
                <div class="col-12">
                    <h3>데이터 테이블</h3>
                    <div class="table-responsive">
                        {{ table|safe }}  <!-- HTML 테이블을 안전하게 렌더링 -->
                    </div>
                </div>
            </div>
            
            <!-- 네비게이션 -->
            <div class="row mt-4">
                <div class="col-12">
                    <a href="{% url 'main' %}" class="btn btn-primary">
                        메인으로 돌아가기
                    </a>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
```

### 템플릿 핵심 포인트

1. **정적 파일 로드**
   ```html
   {% load static %}
   <img src="{% static img_relpath %}" alt="차트">
   ```

2. **URL 역참조**
   ```html
   <a href="{% url 'main' %}">메인으로</a>
   ```

3. **HTML 안전 렌더링**
   ```html
   {{ table|safe }}  <!-- HTML 문자열을 그대로 출력 -->
   ```

---

## 데이터 시각화 연동

### Matplotlib과 Django 연동 과정

1. **백엔드 설정**: GUI 없이 파일 저장
   ```python
   matplotlib.use('Agg')
   ```

2. **차트 생성 및 저장**
   ```python
   plt.figure()
   counts.plot(kind='pie', autopct='%1.1f%%')
   plt.savefig(img_path, dpi=150)
   plt.close()  # 메모리 정리
   ```

3. **정적 파일로 서빙**
   ```python
   # 뷰에서 이미지 경로 전달
   'img_relpath': 'images/iris.png'
   ```

4. **템플릿에서 표시**
   ```html
   <img src="{% static img_relpath %}" alt="차트">
   ```

### 데이터 테이블 연동

```python
# DataFrame을 HTML 테이블로 변환
table_html = df.to_html(
    classes='table table-striped table-sm',  # Bootstrap 클래스
    index=False,                             # 인덱스 제외
    escape=False                             # HTML 태그 허용
)

# 템플릿에 전달
return render(request, 'showdata.html', {
    'table': table_html,
})
```

---

## 주요 명령어

### 프로젝트 관리
```bash
# Django 프로젝트 생성
django-admin startproject mainapp

# Django 앱 생성
python manage.py startapp myapp

# 개발 서버 실행 (기본 포트: 8000)
python manage.py runserver

# 특정 포트로 서버 실행
python manage.py runserver 8080
```

### 데이터베이스 관리
```bash
# 마이그레이션 파일 생성
python manage.py makemigrations

# 마이그레이션 적용
python manage.py migrate

# 슈퍼유저 생성
python manage.py createsuperuser
```

### 개발 도구
```bash
# Django 셸 실행
python manage.py shell

# 정적 파일 수집 (프로덕션용)
python manage.py collectstatic
```

---

## 강의 핵심 포인트

### 1. 프로젝트 vs 앱 구분
- **mainapp**: 메인 프로젝트 (루트 앱) - 전체 설정 담당
- **myapp**: 실제 기능을 담당하는 앱 - 비즈니스 로직 구현

### 2. 디렉토리 구조의 중요성
```
👍 권장 구조:
├── mainapp/         # 프로젝트 설정
├── myapp/          # 앱 로직
├── templates/      # HTML 템플릿
└── static/         # CSS, JS, 이미지

❌ 피해야 할 구조:
└── 모든 파일이 한 폴더에...
```

### 3. URL 라우팅 패턴
```python
# 요청명이 없을 때 (루트 경로)
path('', views.main, name='main')

# 특정 요청 경로
path('showdata/', views.showdata, name='showdata')
```

### 4. 템플릿과 정적 파일 설정
```python
# settings.py에서 반드시 설정
TEMPLATES = [{'DIRS': [BASE_DIR / 'templates']}]
STATICFILES_DIRS = [BASE_DIR / 'static']
```

### 5. matplotlib 웹 출력 주의사항
```python
# 🔥 중요: GUI 없이 파일로 저장
matplotlib.use('Agg')

# 항상 plt.close()로 메모리 정리
plt.savefig(img_path)
plt.close()
```

### 6. 보안 고려사항
```html
<!-- HTML 안전 렌더링 -->
{{ table|safe }}

<!-- 정적 파일은 항상 {% static %} 태그 사용 -->
<img src="{% static 'images/chart.png' %}">
```

### 7. 강사님 강조 내용
> "요청명이 없을 때는 views.main 함수를 찾아갑니다."
> 
> "웹으로 출력하세요. 웹으로 출력할 수 있기 때문에."
> 
> "시뮬레이터를 돌리고 그 결과를 웹에다 주소를 걸어가지고 클릭하면 돌아가기도 한다거나..."

---

## 다음 단계

### 발전 방향
1. **모델 추가**: 데이터베이스 연동
2. **폼 처리**: 사용자 입력 받기
3. **AJAX**: 동적 데이터 업데이트
4. **REST API**: API 서버 구축
5. **배포**: 실제 서버에 배포

### 추천 학습 자료
- [Django 공식 문서](https://docs.djangoproject.com/)
- [Django Girls 튜토리얼](https://tutorial.djangogirls.org/)
- [MDN Django 가이드](https://developer.mozilla.org/docs/Learn/Server-side/Django)

이제 Django의 기본 구조와 연결 방법을 이해했으니, 데이터 분석 결과를 효과적으로 웹에서 표시할 수 있습니다! 🚀